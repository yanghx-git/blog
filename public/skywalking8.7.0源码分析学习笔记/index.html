<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>Skywalking 8.7.0 源码分析学习笔记 - yanghx blog</title><meta name="Description" content="yanghx blog"><meta property="og:title" content="Skywalking 8.7.0 源码分析学习笔记" />
<meta property="og:description" content="Skywalking 8.7.0 源码分析学习笔记 https://www.bilibili.com/video/BV1dy4y1V7ck 一、源码环境准备 下载地址: https://archive.apache.org/dist/skywalking/8.7.0/apache-skywalking-apm-8.7.0-src.tgz 禁用两个插件代码风格检查插件 前端项目编译插件 mac M1芯片编译问题此时在根目录执行 mvn clean package &#39;-Dmaven.test.skip=true&#39; 大佬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://yanghx.vip/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><meta property="og:image" content="http://yanghx.vip/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-20T02:42:30+08:00" />
<meta property="article:modified_time" content="2023-03-20T02:42:30+08:00" /><meta property="og:site_name" content="yanghx blog" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://yanghx.vip/logo.png"/>

<meta name="twitter:title" content="Skywalking 8.7.0 源码分析学习笔记"/>
<meta name="twitter:description" content="Skywalking 8.7.0 源码分析学习笔记 https://www.bilibili.com/video/BV1dy4y1V7ck 一、源码环境准备 下载地址: https://archive.apache.org/dist/skywalking/8.7.0/apache-skywalking-apm-8.7.0-src.tgz 禁用两个插件代码风格检查插件 前端项目编译插件 mac M1芯片编译问题此时在根目录执行 mvn clean package &#39;-Dmaven.test.skip=true&#39; 大佬"/>
<meta name="application-name" content="DoIt">
<meta name="apple-mobile-web-app-title" content="DoIt">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://yanghx.vip/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><link rel="prev" href="http://yanghx.vip/readme/" /><link rel="next" href="http://yanghx.vip/mysql%E5%9F%BA%E7%A1%80-%E9%BB%91%E9%A9%AC/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Skywalking 8.7.0 源码分析学习笔记",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/yanghx.vip\/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0\/"
        },"genre": "posts","keywords": "Skywalking","wordcount":  34069 ,
        "url": "http:\/\/yanghx.vip\/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0\/","datePublished": "2023-03-20T02:42:30+08:00","dateModified": "2023-03-20T02:42:30+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "yanghx"
            },"description": ""
    }
    </script><script src="//instant.page/5.1.1" defer type="module" integrity="sha384-MWfCL6g1OTGsbSwfuMHc8+8J2u71/LA8dzlIN3ycajckxuZZmF+DNjdm7O6H3PSq"></script>
</head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="yanghx blog">yanghx blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/series/"> 系列 </a><a class="menu-item" href="/posts/mysql/mysql45/"> mysql45讲 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" class="menu-item theme-select" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="切换主题">
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                        <option value="black">黑色</option>
                        <option value="auto">跟随系统</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="yanghx blog">yanghx blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/series/" title="">系列</a><a class="menu-item" href="/posts/mysql/mysql45/" title="">mysql45讲</a><a href="#" class="menu-item theme-select" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="切换主题">
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                    <option value="black">黑色</option>
                    <option value="auto">跟随系统</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#一源码环境准备">一、源码环境准备</a>
      <ul>
        <li><a href="#禁用两个插件"><strong>禁用两个插件</strong></a></li>
        <li><a href="#mac-m1芯片编译问题">mac M1芯片编译问题</a>
          <ul>
            <li><a href="#原因">原因</a></li>
            <li><a href="#解决办法">解决办法</a></li>
          </ul>
        </li>
        <li><a href="#将protocol生成的文件加入classpath">将<code>protocol</code>生成的文件加入<code>classPath</code></a></li>
      </ul>
    </li>
    <li><a href="#二-agent">二、 Agent</a>
      <ul>
        <li><a href="#原理概述">原理概述</a></li>
        <li><a href="#启动方式">启动方式</a></li>
        <li><a href="#启动流程">启动流程</a>
          <ul>
            <li><a href="#1初始化配置">1、初始化配置</a></li>
            <li><a href="#2加载插件">2、加载插件</a>
              <ul>
                <li><a href="#开启类加载器的并行加载模式">开启类加载器的并行加载模式</a></li>
                <li><a href="#从指定目录加载插件">从指定目录加载插件</a></li>
              </ul>
            </li>
            <li><a href="#3插件定义体系">3、插件定义体系</a>
              <ul>
                <li><a href="#从doubbe插件看开发流程">从doubbe插件看开发流程</a></li>
              </ul>
            </li>
            <li><a href="#4-插件加载流程">4、 插件加载流程</a></li>
            <li><a href="#5-定制agent">5、 定制agent</a>
              <ul>
                <li><a href="#synthetic"><code>synthetic</code></a></li>
                <li><a href="#nbac"><code>NBAC</code></a></li>
              </ul>
            </li>
            <li><a href="#6加载服务">6、加载服务</a></li>
            <li><a href="#7-注册关闭钩子">7 注册关闭钩子</a></li>
          </ul>
        </li>
        <li><a href="#插件工作原理">插件工作原理</a>
          <ul>
            <li><a href="#witness机制"><code>witness机制</code></a></li>
            <li><a href="#插件工作流程">插件工作流程</a></li>
          </ul>
        </li>
        <li><a href="#服务">服务</a>
          <ul>
            <li><a href="#bootservice"><code>BootService</code></a></li>
            <li><a href="#grpcchannelmanager"><code>GRPCChannelManager</code></a></li>
            <li><a href="#servicemanagementclient"><code>ServiceManagementClient</code></a></li>
            <li><a href="#commandservice"><code>CommandService</code></a>
              <ul>
                <li><a href="#commandserialnumbercache"><code>CommandSerialNumberCache</code></a></li>
                <li><a href="#commanddeserializer"><code>CommandDeserializer</code></a></li>
                <li><a href="#configurationdiscoverycommand"><code>ConfigurationDiscoveryCommand</code></a></li>
                <li><a href="#commandexecutorservice"><code>CommandExecutorService</code></a></li>
                <li><a href="#configurationdiscoverycommandexecutor"><code>ConfigurationDiscoveryCommandExecutor</code></a></li>
                <li><a href="#configurationdiscoveryservice"><code>ConfigurationDiscoveryService</code></a>
                  <ul>
                    <li><a href="#getagentdynamicconfig"><code>getAgentDynamicConfig</code></a></li>
                  </ul>
                </li>
                <li><a href="#handleconfigurationdiscoverycommand"><code>handleConfigurationDiscoveryCommand</code></a></li>
              </ul>
            </li>
            <li><a href="#samplingservice"><code>SamplingService</code></a></li>
            <li><a href="#jvmservice"><code>JVMService</code></a></li>
            <li><a href="#kafkaxxxservice"><code>KafkaXxxService</code></a></li>
            <li><a href="#statuscheckservice"><code>StatusCheckService</code></a></li>
          </ul>
        </li>
        <li><a href="#链路追踪">链路追踪</a>
          <ul>
            <li><a href="#概念">概念</a></li>
            <li><a href="#链路id的生成">链路ID的生成</a></li>
            <li><a href="#image-20221213211722391httpsblog-1257196793cosap-beijingmyqcloudcomimage-20221213211722391png"><img src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213211722391.png" alt="image-20221213211722391"></a></li>
            <li><a href="#tracesegment"><code>TraceSegment</code></a></li>
            <li><a href="#span"><code>span</code></a>
              <ul>
                <li><a href="#asyncspan"><code>AsyncSpan</code></a></li>
                <li><a href="#abstractspan"><code>AbstractSpan</code></a></li>
                <li><a href="#abstracttracingspan"><code>AbstractTracingSpan</code></a></li>
                <li><a href="#stackbasedtracingspan"><code>StackBasedTracingSpan</code></a></li>
                <li><a href="#entryspan-和-exitspan-"><code>EntrySpan 和 ExitSpan </code></a></li>
              </ul>
            </li>
            <li><a href="#链路追踪上下文">链路追踪上下文</a>
              <ul>
                <li><a href="#abstracttracercontext"><code>AbstractTracerContext</code></a>
                  <ul>
                    <li><a href="#跨进程传输数据">跨进程传输数据</a></li>
                    <li><a href="#跨线程传输数据">跨线程传输数据</a></li>
                  </ul>
                </li>
                <li><a href="#tracingcontext"><code>TracingContext</code></a>
                  <ul>
                    <li><a href="#activespanstack">activeSpanStack</a></li>
                    <li><a href="#createentryspan"><code>createEntrySpan()</code></a></li>
                    <li><a href="#stopspan"><code>stopSpan()</code></a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#上下文适配器-contextmanager">上下文适配器 <code>ContextManager</code></a></li>
            <li><a href="#-datacarrier"><code> DataCarrier</code></a>
              <ul>
                <li><a href="#基础buffer"><code>基础Buffer</code></a>
                  <ul>
                    <li><a href="#buffer"><code>Buffer</code></a></li>
                    <li><a href="#arrayblockingqueuebuffer"><code>ArrayBlockingQueueBuffer</code></a></li>
                  </ul>
                </li>
                <li><a href="#channels"><code>Channels</code></a></li>
                <li><a href="#消费-consumer"><code>消费 Consumer</code></a>
                  <ul>
                    <li><a href="#consumerthread"><code>ConsumerThread</code></a></li>
                    <li><a href="#multiplechannelsconsumer"><code>MultipleChannelsConsumer</code></a></li>
                  </ul>
                </li>
                <li><a href="#消费驱动-drive"><code>消费驱动 Drive</code></a>
                  <ul>
                    <li><a href="#consumedriver"><code>ConsumeDriver</code></a></li>
                    <li><a href="#bulkconsumepool"><code>BulkConsumePool</code></a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#链路数据发送的-oap">链路数据发送的 OAP</a>
              <ul>
                <li>
                  <ul>
                    <li><a href="#tracesegmentserviceclient"><code>TraceSegmentServiceClient</code></a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Skywalking 8.7.0 源码分析学习笔记</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="/" title="Author" rel=" author" class="author">yanghx</a>
                </span>&nbsp;<span class="post-category">收录于 </span>&nbsp;<span class="post-category">类别 <a href="/categories/skywalking/"><i class="far fa-folder fa-fw"></i>Skywalking</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-03-20">2023-03-20</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2023-03-20">2023-03-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 34069 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 69 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一源码环境准备">一、源码环境准备</a>
      <ul>
        <li><a href="#禁用两个插件"><strong>禁用两个插件</strong></a></li>
        <li><a href="#mac-m1芯片编译问题">mac M1芯片编译问题</a>
          <ul>
            <li><a href="#原因">原因</a></li>
            <li><a href="#解决办法">解决办法</a></li>
          </ul>
        </li>
        <li><a href="#将protocol生成的文件加入classpath">将<code>protocol</code>生成的文件加入<code>classPath</code></a></li>
      </ul>
    </li>
    <li><a href="#二-agent">二、 Agent</a>
      <ul>
        <li><a href="#原理概述">原理概述</a></li>
        <li><a href="#启动方式">启动方式</a></li>
        <li><a href="#启动流程">启动流程</a>
          <ul>
            <li><a href="#1初始化配置">1、初始化配置</a></li>
            <li><a href="#2加载插件">2、加载插件</a>
              <ul>
                <li><a href="#开启类加载器的并行加载模式">开启类加载器的并行加载模式</a></li>
                <li><a href="#从指定目录加载插件">从指定目录加载插件</a></li>
              </ul>
            </li>
            <li><a href="#3插件定义体系">3、插件定义体系</a>
              <ul>
                <li><a href="#从doubbe插件看开发流程">从doubbe插件看开发流程</a></li>
              </ul>
            </li>
            <li><a href="#4-插件加载流程">4、 插件加载流程</a></li>
            <li><a href="#5-定制agent">5、 定制agent</a>
              <ul>
                <li><a href="#synthetic"><code>synthetic</code></a></li>
                <li><a href="#nbac"><code>NBAC</code></a></li>
              </ul>
            </li>
            <li><a href="#6加载服务">6、加载服务</a></li>
            <li><a href="#7-注册关闭钩子">7 注册关闭钩子</a></li>
          </ul>
        </li>
        <li><a href="#插件工作原理">插件工作原理</a>
          <ul>
            <li><a href="#witness机制"><code>witness机制</code></a></li>
            <li><a href="#插件工作流程">插件工作流程</a></li>
          </ul>
        </li>
        <li><a href="#服务">服务</a>
          <ul>
            <li><a href="#bootservice"><code>BootService</code></a></li>
            <li><a href="#grpcchannelmanager"><code>GRPCChannelManager</code></a></li>
            <li><a href="#servicemanagementclient"><code>ServiceManagementClient</code></a></li>
            <li><a href="#commandservice"><code>CommandService</code></a>
              <ul>
                <li><a href="#commandserialnumbercache"><code>CommandSerialNumberCache</code></a></li>
                <li><a href="#commanddeserializer"><code>CommandDeserializer</code></a></li>
                <li><a href="#configurationdiscoverycommand"><code>ConfigurationDiscoveryCommand</code></a></li>
                <li><a href="#commandexecutorservice"><code>CommandExecutorService</code></a></li>
                <li><a href="#configurationdiscoverycommandexecutor"><code>ConfigurationDiscoveryCommandExecutor</code></a></li>
                <li><a href="#configurationdiscoveryservice"><code>ConfigurationDiscoveryService</code></a>
                  <ul>
                    <li><a href="#getagentdynamicconfig"><code>getAgentDynamicConfig</code></a></li>
                  </ul>
                </li>
                <li><a href="#handleconfigurationdiscoverycommand"><code>handleConfigurationDiscoveryCommand</code></a></li>
              </ul>
            </li>
            <li><a href="#samplingservice"><code>SamplingService</code></a></li>
            <li><a href="#jvmservice"><code>JVMService</code></a></li>
            <li><a href="#kafkaxxxservice"><code>KafkaXxxService</code></a></li>
            <li><a href="#statuscheckservice"><code>StatusCheckService</code></a></li>
          </ul>
        </li>
        <li><a href="#链路追踪">链路追踪</a>
          <ul>
            <li><a href="#概念">概念</a></li>
            <li><a href="#链路id的生成">链路ID的生成</a></li>
            <li><a href="#image-20221213211722391httpsblog-1257196793cosap-beijingmyqcloudcomimage-20221213211722391png"><img src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213211722391.png" alt="image-20221213211722391"></a></li>
            <li><a href="#tracesegment"><code>TraceSegment</code></a></li>
            <li><a href="#span"><code>span</code></a>
              <ul>
                <li><a href="#asyncspan"><code>AsyncSpan</code></a></li>
                <li><a href="#abstractspan"><code>AbstractSpan</code></a></li>
                <li><a href="#abstracttracingspan"><code>AbstractTracingSpan</code></a></li>
                <li><a href="#stackbasedtracingspan"><code>StackBasedTracingSpan</code></a></li>
                <li><a href="#entryspan-和-exitspan-"><code>EntrySpan 和 ExitSpan </code></a></li>
              </ul>
            </li>
            <li><a href="#链路追踪上下文">链路追踪上下文</a>
              <ul>
                <li><a href="#abstracttracercontext"><code>AbstractTracerContext</code></a>
                  <ul>
                    <li><a href="#跨进程传输数据">跨进程传输数据</a></li>
                    <li><a href="#跨线程传输数据">跨线程传输数据</a></li>
                  </ul>
                </li>
                <li><a href="#tracingcontext"><code>TracingContext</code></a>
                  <ul>
                    <li><a href="#activespanstack">activeSpanStack</a></li>
                    <li><a href="#createentryspan"><code>createEntrySpan()</code></a></li>
                    <li><a href="#stopspan"><code>stopSpan()</code></a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#上下文适配器-contextmanager">上下文适配器 <code>ContextManager</code></a></li>
            <li><a href="#-datacarrier"><code> DataCarrier</code></a>
              <ul>
                <li><a href="#基础buffer"><code>基础Buffer</code></a>
                  <ul>
                    <li><a href="#buffer"><code>Buffer</code></a></li>
                    <li><a href="#arrayblockingqueuebuffer"><code>ArrayBlockingQueueBuffer</code></a></li>
                  </ul>
                </li>
                <li><a href="#channels"><code>Channels</code></a></li>
                <li><a href="#消费-consumer"><code>消费 Consumer</code></a>
                  <ul>
                    <li><a href="#consumerthread"><code>ConsumerThread</code></a></li>
                    <li><a href="#multiplechannelsconsumer"><code>MultipleChannelsConsumer</code></a></li>
                  </ul>
                </li>
                <li><a href="#消费驱动-drive"><code>消费驱动 Drive</code></a>
                  <ul>
                    <li><a href="#consumedriver"><code>ConsumeDriver</code></a></li>
                    <li><a href="#bulkconsumepool"><code>BulkConsumePool</code></a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#链路数据发送的-oap">链路数据发送的 OAP</a>
              <ul>
                <li>
                  <ul>
                    <li><a href="#tracesegmentserviceclient"><code>TraceSegmentServiceClient</code></a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="skywalking-870-源码分析学习笔记" class="headerLink">
    <a href="#skywalking-870-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0" class="header-mark"></a>Skywalking 8.7.0 源码分析学习笔记</h1><blockquote>
<p><a href="https://www.bilibili.com/video/BV1dy4y1V7ck" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1dy4y1V7ck</a></p>
</blockquote>
<h2 id="一源码环境准备" class="headerLink">
    <a href="#%e4%b8%80%e6%ba%90%e7%a0%81%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87" class="header-mark"></a>一、源码环境准备</h2><blockquote>
<p>下载地址: <code>https://archive.apache.org/dist/skywalking/8.7.0/apache-skywalking-apm-8.7.0-src.tgz</code></p>
</blockquote>
<h3 id="禁用两个插件" class="headerLink">
    <a href="#%e7%a6%81%e7%94%a8%e4%b8%a4%e4%b8%aa%e6%8f%92%e4%bb%b6" class="header-mark"></a><strong>禁用两个插件</strong></h3><p>代码风格检查插件</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204714520.png" title="image-20221203204714520" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204714520.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204714520.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204714520.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204714520.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204714520.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204714520.png">
    </a></p>
<p>前端项目编译插件</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204747323.png" title="image-20221203204747323" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204747323.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204747323.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204747323.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204747323.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204747323.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203204747323.png">
    </a></p>
<h3 id="mac-m1芯片编译问题" class="headerLink">
    <a href="#mac-m1%e8%8a%af%e7%89%87%e7%bc%96%e8%af%91%e9%97%ae%e9%a2%98" class="header-mark"></a>mac M1芯片编译问题</h3><p>此时在根目录执行<code> mvn clean package '-Dmaven.test.skip=true'</code></p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205152669.png" title="image-20221203205152669" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205152669.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205152669.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205152669.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205152669.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205152669.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205152669.png">
    </a></p>
<p>大佬解释了原因，并给出解决办法</p>
<h4 id="原因" class="headerLink">
    <a href="#%e5%8e%9f%e5%9b%a0" class="header-mark"></a>原因</h4><p><code>apm-protocol</code>下的<code>apm-network</code>模块引用的插件<code>os-maven-plugin</code>, 在m1芯片下是没有的,但是inter芯片版本的,并且inter版本的，m1也是可以用的。所以要把这个变量写死为inter版本的<code>(大概意思)</code></p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205413109.png" title="image-20221203205413109" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205413109.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205413109.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205413109.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205413109.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205413109.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203205413109.png">
    </a></p>
<h4 id="解决办法" class="headerLink">
    <a href="#%e8%a7%a3%e5%86%b3%e5%8a%9e%e6%b3%95" class="header-mark"></a>解决办法</h4><p>在maven的setting.xml文件中，将变量固定</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203210945282.png" title="image-20221203210945282" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203210945282.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203210945282.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203210945282.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203210945282.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203210945282.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203210945282.png">
    </a></p>
<p>之后再编译，就没有问题了</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203211247383.png" title="image-20221203211247383" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203211247383.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203211247383.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203211247383.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203211247383.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203211247383.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203211247383.png">
    </a></p>
<h3 id="将protocol生成的文件加入classpath" class="headerLink">
    <a href="#%e5%b0%86protocol%e7%94%9f%e6%88%90%e7%9a%84%e6%96%87%e4%bb%b6%e5%8a%a0%e5%85%a5classpath" class="header-mark"></a>将<code>protocol</code>生成的文件加入<code>classPath</code></h3><p>skywalking采用grpc通信，需使用<code>protocol</code>生成通信用的实体类。将这些生成的代码，加入classPath中，可以在源码中使用，在调试过程中，才不会报错。</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203214217332.png" title="image-20221203214217332" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203214217332.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203214217332.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203214217332.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203214217332.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203214217332.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221203214217332.png">
    </a></p>
<h2 id="二-agent" class="headerLink">
    <a href="#%e4%ba%8c-agent" class="header-mark"></a>二、 Agent</h2><h3 id="原理概述" class="headerLink">
    <a href="#%e5%8e%9f%e7%90%86%e6%a6%82%e8%bf%b0" class="header-mark"></a>原理概述</h3><p>在目标类中插入它自己的监控代码(插桩)</p>
<h3 id="启动方式" class="headerLink">
    <a href="#%e5%90%af%e5%8a%a8%e6%96%b9%e5%bc%8f" class="header-mark"></a>启动方式</h3><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171330539.png" title="image-20221205171330539" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171330539.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171330539.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171330539.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171330539.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171330539.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171330539.png">
    </a></p>
<p>SkyWalking 只支持静态启动方式。 入口<code>SkyWalkingAgent.premain()</code></p>
<p>这个模块下只有这一个类。</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171756377.png" title="image-20221205171756377" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171756377.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171756377.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171756377.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171756377.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171756377.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205171756377.png">
    </a></p>
<h3 id="启动流程" class="headerLink">
    <a href="#%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b" class="header-mark"></a>启动流程</h3><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/SkyWalking%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90.png" title="SkyWalking源码分析" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/SkyWalking源码分析.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/SkyWalking%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/SkyWalking%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/SkyWalking%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/SkyWalking%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/SkyWalking源码分析.png">
    </a></p>
<h4 id="1初始化配置" class="headerLink">
    <a href="#1%e5%88%9d%e5%a7%8b%e5%8c%96%e9%85%8d%e7%bd%ae" class="header-mark"></a>1、初始化配置</h4><p>涉及到类</p>
<ul>
<li>
<p><code>SkyWalkingAgent</code></p>
</li>
<li>
<p><code>SnifferConfigInitializer</code></p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The main entrance of sky-walking agent, based on javaagent mechanism.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SkyWalkingAgent</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">SkyWalkingAgent</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Main entrance. Use byte-buddy transform to enhance all classes, which define in plugins.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * //传参方式。等号后面
</span></span></span><span class="line"><span class="cl"><span class="cm">     * -javaagent:/path/to/agent.jar=xxxxxx
</span></span></span><span class="line"><span class="cl"><span class="cm">     * // 机构话传参
</span></span></span><span class="line"><span class="cl"><span class="cm">     * -javaagent:/path/to/agent.jar=aaa=xx,bbb=xxx
</span></span></span><span class="line"><span class="cl"><span class="cm">     * -
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 我常用的skyWalking的启动配置
</span></span></span><span class="line"><span class="cl"><span class="cm">     * -
</span></span></span><span class="line"><span class="cl"><span class="cm">     * java   -javaagent:skywalking-agent/skywalking-agent.jar \
</span></span></span><span class="line"><span class="cl"><span class="cm">     * -Dskywalking.agent.service_name=${SKYWALKING_AGENT_SERVICE_NAME} \
</span></span></span><span class="line"><span class="cl"><span class="cm">     * -Dskywalking.collector.backend_service=${SKYWALKING_COLLECTOR_BACKEND_SERVICE} \
</span></span></span><span class="line"><span class="cl"><span class="cm">     * -jar ${JAR_NAME}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">premain</span><span class="o">(</span><span class="n">String</span> <span class="n">agentArgs</span><span class="o">,</span> <span class="n">Instrumentation</span> <span class="n">instrumentation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">PluginFinder</span> <span class="n">pluginFinder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SnifferConfigInitializer</span><span class="o">.</span><span class="na">initializeCoreConfig</span><span class="o">(</span><span class="n">agentArgs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 初始化配置时，重定义了一个logger,所以这里要重新获取一下
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// try to resolve a new logger, and use the new logger to write the error log here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">SkyWalkingAgent</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;SkyWalking agent initialized failure. Shutting down.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// refresh logger again after initialization finishes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">SkyWalkingAgent</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="c1">// ----
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;SnifferConfigInitializer&lt;/code&gt; initializes all configs in several way.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SnifferConfigInitializer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">SnifferConfigInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SPECIFIED_CONFIG_PATH</span> <span class="o">=</span> <span class="s">&#34;skywalking_config&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_CONFIG_FILE_NAME</span> <span class="o">=</span> <span class="s">&#34;/config/agent.config&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ENV_KEY_PREFIX</span> <span class="o">=</span> <span class="s">&#34;skywalking.&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Properties</span> <span class="n">AGENT_SETTINGS</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">IS_INIT_COMPLETED</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If the specified agent config path is set, the agent will try to locate the specified agent config. If the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * specified agent config path is not set , the agent will try to locate `agent.config`, which should be in the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * /config directory of agent package.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Also try to override the config by system.properties. All the keys in this place should start with {@link
</span></span></span><span class="line"><span class="cl"><span class="cm">     * #ENV_KEY_PREFIX}. e.g. in env `skywalking.agent.service_name=yourAppName` to override `agent.service_name` in
</span></span></span><span class="line"><span class="cl"><span class="cm">     * config file.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * At the end, `agent.service_name` and `collector.servers` must not be blank.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">initializeCoreConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">agentOptions</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AGENT_SETTINGS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="kd">final</span> <span class="n">InputStreamReader</span> <span class="n">configFileStream</span> <span class="o">=</span> <span class="n">loadConfig</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 将流 load 到 Properties 中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">AGENT_SETTINGS</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">configFileStream</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 替换占位符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// aaa = xxx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// bbb = ${aaa}-yyy ==替换==&gt; xxx-yyy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">AGENT_SETTINGS</span><span class="o">.</span><span class="na">stringPropertyNames</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">AGENT_SETTINGS</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">AGENT_SETTINGS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">PropertyPlaceholderHelper</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">replacePlaceholders</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">AGENT_SETTINGS</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;Failed to read the config file, skywalking is going to run in default config.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果在环境变量里配置了一些变量，要覆盖 Properties中的变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 环境变量优先级更高
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">overrideConfigBySystemProp</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;Failed to read the system properties.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// agent 参数替换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// agent参数 优先级更高
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">agentOptions</span> <span class="o">=</span> <span class="n">StringUtil</span><span class="o">.</span><span class="na">trim</span><span class="o">(</span><span class="n">agentOptions</span><span class="o">,</span> <span class="sc">&#39;,&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">agentOptions</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">agentOptions</span> <span class="o">=</span> <span class="n">agentOptions</span><span class="o">.</span><span class="na">trim</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Agent options is {}.&#34;</span><span class="o">,</span> <span class="n">agentOptions</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">overrideConfigByAgentOptions</span><span class="o">(</span><span class="n">agentOptions</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;Failed to parse the agent options, val is {}.&#34;</span><span class="o">,</span> <span class="n">agentOptions</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// AGENT_SETTINGS 中的配置数据。映射到 Config类中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">initializeConfig</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 重新配置logger
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 根据配置的日志解析模式，重新生成一个logger。   模式 JSON  PATTERN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// reconfigure logger after config initialization
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">configureLogger</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">SnifferConfigInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 使用agent，要传入server_name .这里做效验
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">SERVICE_NAME</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ExceptionInInitializerError</span><span class="o">(</span><span class="s">&#34;`agent.service_name` is missing.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">BACKEND_SERVICE</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ExceptionInInitializerError</span><span class="o">(</span><span class="s">&#34;`collector.backend_service` is missing.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// PEER 可以理解为链接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// APPLICATION -&gt; Redis
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// PEER 就是 redis 地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Plugin</span><span class="o">.</span><span class="na">PEER_MAX_LENGTH</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;PEER_MAX_LENGTH configuration:{} error, the default value of 200 will be used.&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Config</span><span class="o">.</span><span class="na">Plugin</span><span class="o">.</span><span class="na">PEER_MAX_LENGTH</span>
</span></span><span class="line"><span class="cl">            <span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Config</span><span class="o">.</span><span class="na">Plugin</span><span class="o">.</span><span class="na">PEER_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">200</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 配置加载完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">IS_INIT_COMPLETED</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Initialize field values of any given config class.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param configClass to host the settings for code access.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">initializeConfig</span><span class="o">(</span><span class="n">Class</span> <span class="n">configClass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">AGENT_SETTINGS</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Plugin configs have to be initialized after core config initialization.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ConfigInitializer</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="n">AGENT_SETTINGS</span><span class="o">,</span> <span class="n">configClass</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                         <span class="s">&#34;Failed to set the agent settings {}&#34;</span>
</span></span><span class="line"><span class="cl">                             <span class="o">+</span> <span class="s">&#34; to Config={} &#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">AGENT_SETTINGS</span><span class="o">,</span> <span class="n">configClass</span>
</span></span><span class="line"><span class="cl">            <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">overrideConfigByAgentOptions</span><span class="o">(</span><span class="n">String</span> <span class="n">agentOptions</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalArgumentException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">terms</span> <span class="o">:</span> <span class="n">parseAgentOptions</span><span class="o">(</span><span class="n">agentOptions</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">terms</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;[&#34;</span> <span class="o">+</span> <span class="n">terms</span> <span class="o">+</span> <span class="s">&#34;] is not a key-value pair.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">AGENT_SETTINGS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">terms</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">terms</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">parseAgentOptions</span><span class="o">(</span><span class="n">String</span> <span class="n">agentOptions</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">options</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">terms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">isInQuotes</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringBuilder</span> <span class="n">currentTerm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">char</span> <span class="n">c</span> <span class="o">:</span> <span class="n">agentOptions</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;&#34;&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">isInQuotes</span> <span class="o">=</span> <span class="o">!</span><span class="n">isInQuotes</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isInQuotes</span><span class="o">)</span> <span class="o">{</span>   <span class="c1">// key-value pair uses &#39;=&#39; as separator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">terms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">currentTerm</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">currentTerm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isInQuotes</span><span class="o">)</span> <span class="o">{</span>   <span class="c1">// multiple options use &#39;,&#39; as separator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">terms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">currentTerm</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">currentTerm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">options</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">terms</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">terms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">currentTerm</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// add the last term and option without separator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">terms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">currentTerm</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">terms</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">options</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isInitCompleted</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">IS_INIT_COMPLETED</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Override the config by system properties. The property key must start with `skywalking`, the result should be as
</span></span></span><span class="line"><span class="cl"><span class="cm">     * same as in `agent.config`
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * such as: Property key of `agent.service_name` should be `skywalking.agent.service_name`
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">overrideConfigBySystemProp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IllegalAccessException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Properties</span> <span class="n">systemProperties</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">prop</span> <span class="o">:</span> <span class="n">systemProperties</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">ENV_KEY_PREFIX</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">realKey</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">ENV_KEY_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">AGENT_SETTINGS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">realKey</span><span class="o">,</span> <span class="n">prop</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Load the specified config file or default config file
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the config file {@link InputStream}, or null if not needEnhance.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">InputStreamReader</span> <span class="nf">loadConfig</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">AgentPackageNotFoundException</span><span class="o">,</span> <span class="n">ConfigNotFoundException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 配置文件地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">specifiedConfigPath</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">SPECIFIED_CONFIG_PATH</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果为空，就加载 默认配置文件 /config/agent.config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// AgentPackagePath.getPath() 用来查找agent的绝对目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">File</span> <span class="n">configFile</span> <span class="o">=</span> <span class="n">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">specifiedConfigPath</span><span class="o">)</span> <span class="o">?</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">AgentPackagePath</span><span class="o">.</span><span class="na">getPath</span><span class="o">(),</span> <span class="n">DEFAULT_CONFIG_FILE_NAME</span><span class="o">)</span> <span class="o">:</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">specifiedConfigPath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">configFile</span><span class="o">.</span><span class="na">exists</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">configFile</span><span class="o">.</span><span class="na">isFile</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Config file found in {}.&#34;</span><span class="o">,</span> <span class="n">configFile</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">configFile</span><span class="o">),</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">ConfigNotFoundException</span><span class="o">(</span><span class="s">&#34;Failed to load agent.config&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ConfigNotFoundException</span><span class="o">(</span><span class="s">&#34;Failed to load agent.config.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">configureLogger</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Logging</span><span class="o">.</span><span class="na">RESOLVER</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">JSON</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">LogManager</span><span class="o">.</span><span class="na">setLogResolver</span><span class="o">(</span><span class="k">new</span> <span class="n">JsonLogResolver</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">PATTERN</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">LogManager</span><span class="o">.</span><span class="na">setLogResolver</span><span class="o">(</span><span class="k">new</span> <span class="n">PatternLogResolver</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2加载插件" class="headerLink">
    <a href="#2%e5%8a%a0%e8%bd%bd%e6%8f%92%e4%bb%b6" class="header-mark"></a>2、加载插件</h4><blockquote>
<p>SkyWalking 通过自定义类加载器的方式，去加载指定目录下的jar包(插件)。</p>
<p>自定义类加载器 <code>AgentClassLoader</code></p>
</blockquote>
<h5 id="开启类加载器的并行加载模式" class="headerLink">
    <a href="#%e5%bc%80%e5%90%af%e7%b1%bb%e5%8a%a0%e8%bd%bd%e5%99%a8%e7%9a%84%e5%b9%b6%e8%a1%8c%e5%8a%a0%e8%bd%bd%e6%a8%a1%e5%bc%8f" class="header-mark"></a>开启类加载器的并行加载模式</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;AgentClassLoader&lt;/code&gt; represents a classloader, which is in charge of finding plugins and interceptors.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 自定义类加载器
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AgentClassLoader</span> <span class="kd">extends</span> <span class="n">ClassLoader</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Try to solve the classloader dead lock. See https://github.com/apache/skywalking/pull/2016
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 开启类加载器的并行加载模式。
</span></span></span><span class="line"><span class="cl"><span class="cm">         * jdk1.7 之前 类加载是串行的。1.7后，改为并行，
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 原理： super.loadClass() 中锁，从锁当前类加载器，改为锁正在加载的类。
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">registerAsParallelCapable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">		<span class="c1">// ClassLoader 类的构造器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kd">private</span> <span class="nf">ClassLoader</span><span class="o">(</span><span class="n">Void</span> <span class="n">unused</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">unnamedModule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Module</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      	<span class="c1">// 上面静态代码块中的方法，就是将clss注册为并行加载类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      	<span class="c1">// 为parallelLockMap赋值 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">ParallelLoaders</span><span class="o">.</span><span class="na">isRegistered</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">parallelLockMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="n">assertionLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// no finer-grained lock; lock on the classloader instance
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">parallelLockMap</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">assertionLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">package2certs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">nameAndId</span> <span class="o">=</span> <span class="n">nameAndId</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// ClassLoader类的 loadClass方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">protected</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadClass</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">resolve</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">throws</span> <span class="n">ClassNotFoundException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// getClassLoadingLock() 获取锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">getClassLoadingLock</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// First, check if the class has already been loaded
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">findLoadedClass</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">long</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">parent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">c</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">c</span> <span class="o">=</span> <span class="n">findBootstrapClassOrNull</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// ClassNotFoundException thrown if class not found
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// from the non-null parent class loader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// If still not found, then invoke findClass in order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// to find the class.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="kt">long</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">c</span> <span class="o">=</span> <span class="n">findClass</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// this is the defining class loader; record the stats
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">PerfCounter</span><span class="o">.</span><span class="na">getParentDelegationTime</span><span class="o">().</span><span class="na">addTime</span><span class="o">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">PerfCounter</span><span class="o">.</span><span class="na">getFindClassTime</span><span class="o">().</span><span class="na">addElapsedTimeFrom</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">PerfCounter</span><span class="o">.</span><span class="na">getFindClasses</span><span class="o">().</span><span class="na">increment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">resolve</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">resolveClass</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">c</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 重点。获取锁的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">getClassLoadingLock</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 并行加载map 不为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">parallelLockMap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          	<span class="c1">// 创建一个新的锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Object</span> <span class="n">newLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span> <span class="o">=</span> <span class="n">parallelLockMap</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">newLock</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">lock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lock</span> <span class="o">=</span> <span class="n">newLock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      	<span class="c1">// 这里就是 以类加载器 为锁。线性加载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">lock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="从指定目录加载插件" class="headerLink">
    <a href="#%e4%bb%8e%e6%8c%87%e5%ae%9a%e7%9b%ae%e5%bd%95%e5%8a%a0%e8%bd%bd%e6%8f%92%e4%bb%b6" class="header-mark"></a>从指定目录加载插件</h5><p><strong>简述：</strong></p>
<p><code>AgentClassLoader</code>初始化后，将<code>agent插件根目录 的 &quot;plugins&quot;, &quot;activations&quot;</code>加入到classPath,后面就是从这两个目录下加载插件(jar包)。</p>
<p><code>findClass()</code>方法就是加载类的方法，加载完成后，会检查一下类上有没有<code>@PluginConfig</code>注解。有的话，就将相关配置信息，拷给这个类。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="nf">AgentClassLoader</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">parent</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AgentPackageNotFoundException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">File</span> <span class="n">agentDictionary</span> <span class="o">=</span> <span class="n">AgentPackagePath</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">classpath</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Config.Plugin.MOUNT 用来指定被加载类的目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 默认值 &#34;plugins&#34;, &#34;activations&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Config</span><span class="o">.</span><span class="na">Plugin</span><span class="o">.</span><span class="na">MOUNT</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">mountFolder</span> <span class="o">-&gt;</span> <span class="n">classpath</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">agentDictionary</span><span class="o">,</span> <span class="n">mountFolder</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// findClass方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">findClass</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 拿到所有的jar
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Jar</span><span class="o">&gt;</span> <span class="n">allJars</span> <span class="o">=</span> <span class="n">getAllJars</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">).</span><span class="na">concat</span><span class="o">(</span><span class="s">&#34;.class&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Jar</span> <span class="n">jar</span> <span class="o">:</span> <span class="n">allJars</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">JarEntry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">jar</span><span class="o">.</span><span class="na">jarFile</span><span class="o">.</span><span class="na">getJarEntry</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">URL</span> <span class="n">classFileUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s">&#34;jar:file:&#34;</span> <span class="o">+</span> <span class="n">jar</span><span class="o">.</span><span class="na">sourceFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;!/&#34;</span> <span class="o">+</span> <span class="n">path</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">(</span><span class="kd">final</span> <span class="n">BufferedInputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">classFileUrl</span><span class="o">.</span><span class="na">openStream</span><span class="o">());</span> <span class="kd">final</span> <span class="n">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">int</span> <span class="n">ch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">while</span> <span class="o">((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">is</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">baos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="n">data</span> <span class="o">=</span> <span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 包装一下。进行配置信息加载。将配置文件传给插件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">processLoadedClass</span><span class="o">(</span><span class="n">defineClass</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;find class fail.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ClassNotFoundException</span><span class="o">(</span><span class="s">&#34;Can&#39;t find &#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// processLoadedClass 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">processLoadedClass</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadedClass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">PluginConfig</span> <span class="n">pluginConfig</span> <span class="o">=</span> <span class="n">loadedClass</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">PluginConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">pluginConfig</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Set up the plugin config when loaded by class loader at the first time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Agent class loader just loaded limited classes in the plugin jar(s), so the cost of this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// isAssignableFrom would be also very limited.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">SnifferConfigInitializer</span><span class="o">.</span><span class="na">initializeConfig</span><span class="o">(</span><span class="n">pluginConfig</span><span class="o">.</span><span class="na">root</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">loadedClass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3插件定义体系" class="headerLink">
    <a href="#3%e6%8f%92%e4%bb%b6%e5%ae%9a%e4%b9%89%e4%bd%93%e7%b3%bb" class="header-mark"></a>3、插件定义体系</h4><blockquote>
<p>首先自己看SkyWalking官网的插件开发指南</p>
</blockquote>
<h5 id="从doubbe插件看开发流程" class="headerLink">
    <a href="#%e4%bb%8edoubbe%e6%8f%92%e4%bb%b6%e7%9c%8b%e5%bc%80%e5%8f%91%e6%b5%81%e7%a8%8b" class="header-mark"></a>从doubbe插件看开发流程</h5><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205224426951.png" title="image-20221205224426951" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205224426951.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205224426951.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205224426951.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205224426951.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205224426951.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205224426951.png">
    </a></p>
<p>具体注释，看代码</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205221245087.png" title="image-20221205221245087" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205221245087.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205221245087.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205221245087.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205221245087.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205221245087.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221205221245087.png">
    </a></p>
<h4 id="4-插件加载流程" class="headerLink">
    <a href="#4-%e6%8f%92%e4%bb%b6%e5%8a%a0%e8%bd%bd%e6%b5%81%e7%a8%8b" class="header-mark"></a>4、 插件加载流程</h4><p>涉及到类</p>
<ul>
<li><code>PluginBootstrap</code></li>
<li><code>PluginFinder</code></li>
</ul>
<p><em><strong>简述:</strong></em></p>
<p><code>new PluginBootstrap().loadPlugins()</code> 加载所有插件，通过读取skywalking-plugin.def文件，将定义的class 实例化。</p>
<p><code>PluginFinder</code> 将这些类分类存放到<code>nameMatchDefine,signatureMatchDefine,bootstrapClassMatchDefine</code>。并且提供find方法，可以通过类查找到<code>可以对这个类生效的插件</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">  <span class="c1">// SkyWalkingAgent   
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">premain</span><span class="o">(</span><span class="n">String</span> <span class="n">agentArgs</span><span class="o">,</span> <span class="n">Instrumentation</span> <span class="n">instrumentation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">PluginFinder</span> <span class="n">pluginFinder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">      	<span class="c1">// -----
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 加载插件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 插件查找器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// new PluginBootstrap().loadPlugins()  插件加载器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 构造函数。对插件进行分类。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">pluginFinder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PluginFinder</span><span class="o">(</span><span class="k">new</span> <span class="n">PluginBootstrap</span><span class="o">().</span><span class="na">loadPlugins</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">AgentPackageNotFoundException</span> <span class="n">ape</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">ape</span><span class="o">,</span> <span class="s">&#34;Locate agent.jar failure. Shutting down.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;SkyWalking agent initialized failure. Shutting down.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PluginBootstrap</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">PluginBootstrap</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * load all plugins.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 加载所有的插件
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return plugin definition list.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;</span> <span class="nf">loadPlugins</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">AgentPackageNotFoundException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化自定义类加载器实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AgentClassLoader</span><span class="o">.</span><span class="na">initDefaultLoader</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 插件资源转换器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PluginResourcesResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PluginResourcesResolver</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//拿到所有 skywalking-plugin.def 的资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="na">getResources</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">resources</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">resources</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;no plugin files (skywalking-plugin.def) found, continue to start application.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">URL</span> <span class="n">pluginUrl</span> <span class="o">:</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// url转换成流，然后load（解析.def文件）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">PluginCfg</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">pluginUrl</span><span class="o">.</span><span class="na">openStream</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;plugin file [{}] init failure.&#34;</span><span class="o">,</span> <span class="n">pluginUrl</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// load后的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">PluginDefine</span><span class="o">&gt;</span> <span class="n">pluginClassList</span> <span class="o">=</span> <span class="n">PluginCfg</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getPluginClassList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;</span> <span class="n">plugins</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 实例化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">PluginDefine</span> <span class="n">pluginDefine</span> <span class="o">:</span> <span class="n">pluginClassList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;loading plugin class {}.&#34;</span><span class="o">,</span> <span class="n">pluginDefine</span><span class="o">.</span><span class="na">getDefineClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 创建实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">AbstractClassEnhancePluginDefine</span> <span class="n">plugin</span> <span class="o">=</span> <span class="o">(</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">)</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">pluginDefine</span><span class="o">.</span><span class="na">getDefineClass</span><span class="o">(),</span> <span class="kc">true</span><span class="o">,</span> <span class="n">AgentClassLoader</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">getDefault</span><span class="o">()).</span><span class="na">newInstance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">plugins</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">plugin</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;load plugin [{}] failure.&#34;</span><span class="o">,</span> <span class="n">pluginDefine</span><span class="o">.</span><span class="na">getDefineClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// DynamicPluginLoader.INSTANCE.load(AgentClassLoader.getDefault()) 加载一些通过xml定义的插件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">plugins</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">DynamicPluginLoader</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">AgentClassLoader</span><span class="o">.</span><span class="na">getDefault</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">plugins</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PluginFinder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 为什么这里map 泛型是&lt;String,List&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 因为对于一个类，可能有多个插件都要对他进行字节码增强
</span></span></span><span class="line"><span class="cl"><span class="cm">     * KEY =&gt; 目标类
</span></span></span><span class="line"><span class="cl"><span class="cm">     * VAL =&gt; 所有可以对这个类生效的插件
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;&gt;</span> <span class="n">nameMatchDefine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 这里是因为 间接匹配的，无法确定到具体的类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;</span> <span class="n">signatureMatchDefine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;</span> <span class="n">bootstrapClassMatchDefine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param plugins 所有的插件
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">PluginFinder</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;</span> <span class="n">plugins</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 分类。放到不同的map中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">AbstractClassEnhancePluginDefine</span> <span class="n">plugin</span> <span class="o">:</span> <span class="n">plugins</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 拿到匹配器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ClassMatch</span> <span class="n">match</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="na">enhanceClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">match</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// nameMatch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">match</span> <span class="k">instanceof</span> <span class="n">NameMatch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">NameMatch</span> <span class="n">nameMatch</span> <span class="o">=</span> <span class="o">(</span><span class="n">NameMatch</span><span class="o">)</span> <span class="n">match</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;</span> <span class="n">pluginDefines</span> <span class="o">=</span> <span class="n">nameMatchDefine</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">nameMatch</span><span class="o">.</span><span class="na">getClassName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">pluginDefines</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pluginDefines</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nameMatchDefine</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">nameMatch</span><span class="o">.</span><span class="na">getClassName</span><span class="o">(),</span> <span class="n">pluginDefines</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">pluginDefines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">plugin</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 间接匹配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">signatureMatchDefine</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">plugin</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 对jdk类库进行增强的插件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">plugin</span><span class="o">.</span><span class="na">isBootstrapInstrumentation</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">bootstrapClassMatchDefine</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">plugin</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据类查找 插件
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 查找要对这个类生效的插件
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  1.从命名插件中找
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  2. 从间接匹配插件中找
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param typeDescription 类的描述信息
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span><span class="n">TypeDescription</span> <span class="n">typeDescription</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;</span> <span class="n">matchedPlugins</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">typeDescription</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">nameMatchDefine</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">typeName</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">matchedPlugins</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">nameMatchDefine</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">typeName</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 间接匹配。使用匹配器进行验证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">AbstractClassEnhancePluginDefine</span> <span class="n">pluginDefine</span> <span class="o">:</span> <span class="n">signatureMatchDefine</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">IndirectMatch</span> <span class="n">match</span> <span class="o">=</span> <span class="o">(</span><span class="n">IndirectMatch</span><span class="o">)</span> <span class="n">pluginDefine</span><span class="o">.</span><span class="na">enhanceClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">match</span><span class="o">.</span><span class="na">isMatch</span><span class="o">(</span><span class="n">typeDescription</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">matchedPlugins</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pluginDefine</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">matchedPlugins</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 用来告诉byteBuddy要拦截的类
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ElementMatcher</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">TypeDescription</span><span class="o">&gt;</span> <span class="nf">buildMatch</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ElementMatcher</span><span class="o">.</span><span class="na">Junction</span> <span class="n">judge</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AbstractJunction</span><span class="o">&lt;</span><span class="n">NamedElement</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="n">NamedElement</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">nameMatchDefine</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getActualName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 不能是接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">judge</span> <span class="o">=</span> <span class="n">judge</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">not</span><span class="o">(</span><span class="n">isInterface</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">AbstractClassEnhancePluginDefine</span> <span class="n">define</span> <span class="o">:</span> <span class="n">signatureMatchDefine</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ClassMatch</span> <span class="n">match</span> <span class="o">=</span> <span class="n">define</span><span class="o">.</span><span class="na">enhanceClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">match</span> <span class="k">instanceof</span> <span class="n">IndirectMatch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">judge</span> <span class="o">=</span> <span class="n">judge</span><span class="o">.</span><span class="na">or</span><span class="o">(((</span><span class="n">IndirectMatch</span><span class="o">)</span> <span class="n">match</span><span class="o">).</span><span class="na">buildJunction</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 封装一下，避免和其他字节码增强工具的兼容性问题。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">ProtectiveShieldMatcher</span><span class="o">(</span><span class="n">judge</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;</span> <span class="nf">getBootstrapClassMatchDefine</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">bootstrapClassMatchDefine</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5-定制agent" class="headerLink">
    <a href="#5-%e5%ae%9a%e5%88%b6agent" class="header-mark"></a>5、 定制agent</h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221206113314349.png" title="image-20221206113314349" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221206113314349.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221206113314349.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221206113314349.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221206113314349.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221206113314349.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221206113314349.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">premain</span><span class="o">(</span><span class="n">String</span> <span class="n">agentArgs</span><span class="o">,</span> <span class="n">Instrumentation</span> <span class="n">instrumentation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   		<span class="c1">// ----
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     
</span></span><span class="line"><span class="cl">        <span class="c1">// 定制化agent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Config.Agent.IS_OPEN_DEBUGGING_CLASS 是否打开调试类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">final</span> <span class="n">ByteBuddy</span> <span class="n">byteBuddy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteBuddy</span><span class="o">().</span><span class="na">with</span><span class="o">(</span><span class="n">TypeValidation</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">IS_OPEN_DEBUGGING_CLASS</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">AgentBuilder</span> <span class="n">agentBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AgentBuilder</span><span class="o">.</span><span class="na">Default</span><span class="o">(</span><span class="n">byteBuddy</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 被忽略的类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">ignore</span><span class="o">(</span><span class="n">nameStartsWith</span><span class="o">(</span><span class="s">&#34;net.bytebuddy.&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">nameStartsWith</span><span class="o">(</span><span class="s">&#34;org.slf4j.&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">nameStartsWith</span><span class="o">(</span><span class="s">&#34;org.groovy.&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">nameContains</span><span class="o">(</span><span class="s">&#34;javassist&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">nameContains</span><span class="o">(</span><span class="s">&#34;.asm.&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">nameContains</span><span class="o">(</span><span class="s">&#34;.reflectasm.&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">nameStartsWith</span><span class="o">(</span><span class="s">&#34;sun.reflect&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">allSkyWalkingAgentExcludeToolkit</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Synthetic  关键字， 用来标识，生成的字节码类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">ElementMatchers</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">JDK9ModuleExporter</span><span class="o">.</span><span class="na">EdgeClasses</span> <span class="n">edgeClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JDK9ModuleExporter</span><span class="o">.</span><span class="na">EdgeClasses</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 将 edgeClasses  注入到 Bootstrap ClassLoader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">agentBuilder</span> <span class="o">=</span> <span class="n">BootstrapInstrumentBoost</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">pluginFinder</span><span class="o">,</span> <span class="n">instrumentation</span><span class="o">,</span> <span class="n">agentBuilder</span><span class="o">,</span> <span class="n">edgeClasses</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;SkyWalking agent inject bootstrap instrumentation failure. Shutting down.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 打开读边界
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// jdK9之后，出现模块化加载新技术，这里是绕过 模块化加载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">agentBuilder</span> <span class="o">=</span> <span class="n">JDK9ModuleExporter</span><span class="o">.</span><span class="na">openReadEdge</span><span class="o">(</span><span class="n">instrumentation</span><span class="o">,</span> <span class="n">agentBuilder</span><span class="o">,</span> <span class="n">edgeClasses</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;SkyWalking agent open read edge in JDK 9+ failure. Shutting down.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 为true 的话， 将修改后的字节码，保存到磁盘或者内存上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">IS_CACHE_ENHANCED_CLASS</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">agentBuilder</span> <span class="o">=</span> <span class="n">agentBuilder</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheableTransformerDecorator</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">CLASS_CACHE_MODE</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;SkyWalking agent class cache [{}] activated.&#34;</span><span class="o">,</span> <span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">CLASS_CACHE_MODE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;SkyWalking agent can&#39;t active class cache.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// pluginFinder.buildMatch()  构造出一个巨大的条件，用来匹配插件类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// type 指定byteBuddy要拦截的类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">agentBuilder</span><span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="n">pluginFinder</span><span class="o">.</span><span class="na">buildMatch</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">(</span><span class="n">pluginFinder</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 增强的模式: redefine 和 retransform 的区别就在于 是否保留修改前的内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">AgentBuilder</span><span class="o">.</span><span class="na">RedefinitionStrategy</span><span class="o">.</span><span class="na">RETRANSFORMATION</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 注册监听器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="k">new</span> <span class="n">RedefinitionListener</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="k">new</span> <span class="n">Listener</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 安装到 instrumentation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">installOn</span><span class="o">(</span><span class="n">instrumentation</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"> 		<span class="c1">// ----
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="synthetic" class="headerLink">
    <a href="#synthetic" class="header-mark"></a><code>synthetic</code></h5><p>略</p>
<h5 id="nbac" class="headerLink">
    <a href="#nbac" class="header-mark"></a><code>NBAC</code></h5><p>略</p>
<h4 id="6加载服务" class="headerLink">
    <a href="#6%e5%8a%a0%e8%bd%bd%e6%9c%8d%e5%8a%a1" class="header-mark"></a>6、加载服务</h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207124816764.png" title="image-20221207124816764" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207124816764.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207124816764.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207124816764.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207124816764.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207124816764.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207124816764.png">
    </a></p>
<p><em><strong>简述:</strong></em></p>
<p>通过 服务管理器<code>ServiceManager</code>  基于 <code>ServiceLoader(SPI)</code> 加载所有 <code>BootService</code> 的实现类。</p>
<p>根据<code>@DefaultImplementor，@OverrideImplementor</code>注解，来决定 服务最终选择的实现类。规则如上思维导图。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">premain</span><span class="o">(</span><span class="n">String</span> <span class="n">agentArgs</span><span class="o">,</span> <span class="n">Instrumentation</span> <span class="n">instrumentation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">				<span class="c1">// ----
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 启动服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">boot</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;Skywalking agent boot failure.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// ---
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;ServiceManager&lt;/code&gt; bases on {@link ServiceLoader}, load all {@link BootService} implementations.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 服务管理器。  基于 ServiceLoader(SPI) 加载所有 BootService 的实现类
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">ServiceManager</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ServiceManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span> <span class="n">BootService</span><span class="o">&gt;</span> <span class="n">bootedServices</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 加载服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">bootedServices</span> <span class="o">=</span> <span class="n">loadAllServices</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">prepare</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">startup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">onComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 倒序。 根据依赖关系。优雅关闭
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">bootedServices</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">BootService</span><span class="o">::</span><span class="n">priority</span><span class="o">).</span><span class="na">reversed</span><span class="o">()).</span><span class="na">forEach</span><span class="o">(</span><span class="n">service</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">service</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;ServiceManager try to shutdown [{}] fail.&#34;</span><span class="o">,</span> <span class="n">service</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span> <span class="n">BootService</span><span class="o">&gt;</span> <span class="nf">loadAllServices</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span> <span class="n">BootService</span><span class="o">&gt;</span> <span class="n">bootedServices</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">BootService</span><span class="o">&gt;</span> <span class="n">allServices</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// spi 去加载服务类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">load</span><span class="o">(</span><span class="n">allServices</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 根据 默认实现、覆盖实现。为服务分类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 一个服务class, 有 默认实现、覆盖实现。 覆盖实现的优先级高。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 如果一个服务class,只有一个实现，可以不用加注解
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">BootService</span> <span class="n">bootService</span> <span class="o">:</span> <span class="n">allServices</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">BootService</span><span class="o">&gt;</span> <span class="n">bootServiceClass</span> <span class="o">=</span> <span class="n">bootService</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">isDefaultImplementor</span> <span class="o">=</span> <span class="n">bootServiceClass</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="n">DefaultImplementor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">isDefaultImplementor</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">bootedServices</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">bootServiceClass</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bootedServices</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">bootServiceClass</span><span class="o">,</span> <span class="n">bootService</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//ignore the default service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">OverrideImplementor</span> <span class="n">overrideImplementor</span> <span class="o">=</span> <span class="n">bootServiceClass</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">OverrideImplementor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">overrideImplementor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(!</span><span class="n">bootedServices</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">bootServiceClass</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">bootedServices</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">bootServiceClass</span><span class="o">,</span> <span class="n">bootService</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 服务不能重复定义，抛异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceConflictException</span><span class="o">(</span><span class="s">&#34;Duplicate service define for :&#34;</span> <span class="o">+</span> <span class="n">bootServiceClass</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">BootService</span><span class="o">&gt;</span> <span class="n">targetService</span> <span class="o">=</span> <span class="n">overrideImplementor</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">bootedServices</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">targetService</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">boolean</span> <span class="n">presentDefault</span> <span class="o">=</span> <span class="n">bootedServices</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">targetService</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                               <span class="o">.</span><span class="na">getClass</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                               <span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="n">DefaultImplementor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">presentDefault</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">bootedServices</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">targetService</span><span class="o">,</span> <span class="n">bootService</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceConflictException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                <span class="s">&#34;Service &#34;</span> <span class="o">+</span> <span class="n">bootServiceClass</span> <span class="o">+</span> <span class="s">&#34; overrides conflict, &#34;</span> <span class="o">+</span> <span class="s">&#34;exist more than one service want to override :&#34;</span> <span class="o">+</span> <span class="n">targetService</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 当前 覆盖实现 要覆盖的 默认实现 还没有被加载出来。这时候，就把这个 覆盖实现 当做是其服务的 默认实现。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// @OverrideImplementor 有个value字段，value就是 要覆盖的服务。 这里 把这个 要覆盖的服务，当成了key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">bootedServices</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">targetService</span><span class="o">,</span> <span class="n">bootService</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">bootedServices</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bootedServices</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">BootService</span><span class="o">::</span><span class="n">priority</span><span class="o">)).</span><span class="na">forEach</span><span class="o">(</span><span class="n">service</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">service</span><span class="o">.</span><span class="na">prepare</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;ServiceManager try to pre-start [{}] fail.&#34;</span><span class="o">,</span> <span class="n">service</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">startup</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bootedServices</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">BootService</span><span class="o">::</span><span class="n">priority</span><span class="o">)).</span><span class="na">forEach</span><span class="o">(</span><span class="n">service</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">service</span><span class="o">.</span><span class="na">boot</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;ServiceManager try to start [{}] fail.&#34;</span><span class="o">,</span> <span class="n">service</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">BootService</span> <span class="n">service</span> <span class="o">:</span> <span class="n">bootedServices</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">service</span><span class="o">.</span><span class="na">onComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;Service [{}] AfterBoot process fails.&#34;</span><span class="o">,</span> <span class="n">service</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Find a {@link BootService} implementation, which is already started.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param serviceClass class name.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param &lt;T&gt;          {@link BootService} implementation class.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {@link BootService} instance
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">BootService</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">findService</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">serviceClass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">bootedServices</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">serviceClass</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * spi 去加载 服务
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param allServices
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">load</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">BootService</span><span class="o">&gt;</span> <span class="n">allServices</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">BootService</span> <span class="n">bootService</span> <span class="o">:</span> <span class="n">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">BootService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">AgentClassLoader</span><span class="o">.</span><span class="na">getDefault</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">allServices</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bootService</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="7-注册关闭钩子" class="headerLink">
    <a href="#7-%e6%b3%a8%e5%86%8c%e5%85%b3%e9%97%ad%e9%92%a9%e5%ad%90" class="header-mark"></a>7 注册关闭钩子</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">premain</span><span class="o">(</span><span class="n">String</span> <span class="n">agentArgs</span><span class="o">,</span> <span class="n">Instrumentation</span> <span class="n">instrumentation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">				<span class="c1">// ----
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 注册关闭钩子，优雅关机
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">::</span><span class="n">shutdown</span><span class="o">,</span> <span class="s">&#34;skywalking service shutdown thread&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="插件工作原理" class="headerLink">
    <a href="#%e6%8f%92%e4%bb%b6%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" class="header-mark"></a>插件工作原理</h3><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154649835.png" title="image-20221207154649835" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154649835.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154649835.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154649835.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154649835.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154649835.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154649835.png">
    </a></p>
<h4 id="witness机制" class="headerLink">
    <a href="#witness%e6%9c%ba%e5%88%b6" class="header-mark"></a><code>witness机制</code></h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154703060.png" title="image-20221207154703060" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154703060.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154703060.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154703060.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154703060.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154703060.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154703060.png">
    </a></p>
<h4 id="插件工作流程" class="headerLink">
    <a href="#%e6%8f%92%e4%bb%b6%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" class="header-mark"></a>插件工作流程</h4><img src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207154720722.png" alt="image-20221207154720722" style="zoom:200%;" />
<blockquote>
<p>这块理解的不好。可以看这个博客，很清晰。就不复制人家的笔记了，等后面把这块重新看看，再自己总计。 <a href="https://blog.csdn.net/qq_40378034/article/details/122278500" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/qq_40378034/article/details/122278500</a></p>
</blockquote>
<p><strong>入口</strong></p>
<p><code>org/apache/skywalking/apm/agent/SkyWalkingAgent.java:156</code></p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207193803771.png" title="image-20221207193803771" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207193803771.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207193803771.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207193803771.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207193803771.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207193803771.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221207193803771.png">
    </a></p>
<blockquote>
<p><code>SkyWalkingAgent.Transformer</code> ： <code>agent</code>自定义的增强逻辑。重点看 transform方法</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 自己定义的插桩逻辑
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Transformer</span> <span class="kd">implements</span> <span class="n">AgentBuilder</span><span class="o">.</span><span class="na">Transformer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">PluginFinder</span> <span class="n">pluginFinder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @param pluginFinder 插件查找器
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">Transformer</span><span class="o">(</span><span class="n">PluginFinder</span> <span class="n">pluginFinder</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">pluginFinder</span> <span class="o">=</span> <span class="n">pluginFinder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @param builder         当前拦截到的类的字节码
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @param typeDescription 简单当成 Class ,它包含了类的描述信息
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @param classLoader     加载 【当前拦截到的类】的类加载器
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @param module          The class&#39;s module or {@code null} if the current VM does not support modules.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">transform</span><span class="o">(</span><span class="kd">final</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">builder</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="kd">final</span> <span class="n">TypeDescription</span> <span class="n">typeDescription</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="kd">final</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="kd">final</span> <span class="n">JavaModule</span> <span class="n">module</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 加载UrlClassLoader 类。 用于构造JVM信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">LoadedLibraryCollector</span><span class="o">.</span><span class="na">registerURLClassLoader</span><span class="o">(</span><span class="n">classLoader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 找到所有 对这个类生效的插件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">&gt;</span> <span class="n">pluginDefines</span> <span class="o">=</span> <span class="n">pluginFinder</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">typeDescription</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">pluginDefines</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 遍历这些差价，构造 newBuilder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">newBuilder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// context 记录一些标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">EnhanceContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnhanceContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="n">AbstractClassEnhancePluginDefine</span> <span class="n">define</span> <span class="o">:</span> <span class="n">pluginDefines</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 去做增强 【核心步骤】 define.define()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">possibleNewBuilder</span> <span class="o">=</span> <span class="n">define</span><span class="o">.</span><span class="na">define</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">typeDescription</span><span class="o">,</span> <span class="n">newBuilder</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 如果增强了，就不会为null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">possibleNewBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">newBuilder</span> <span class="o">=</span> <span class="n">possibleNewBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">isEnhanced</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Finish the prepare stage for {}.&#34;</span><span class="o">,</span> <span class="n">typeDescription</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 被所有可用插件修改完的  最终字节码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">newBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Matched class {}, but ignore by finding mechanism.&#34;</span><span class="o">,</span> <span class="n">typeDescription</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>重点看这串代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">for</span> <span class="o">(</span><span class="n">AbstractClassEnhancePluginDefine</span> <span class="n">define</span> <span class="o">:</span> <span class="n">pluginDefines</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	   <span class="c1">// 去做增强 【核心步骤】 define.define()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	   <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">possibleNewBuilder</span> <span class="o">=</span> <span class="n">define</span><span class="o">.</span><span class="na">define</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">	           <span class="n">typeDescription</span><span class="o">,</span> <span class="n">newBuilder</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	   <span class="c1">// 如果增强了，就不会为null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	   <span class="k">if</span> <span class="o">(</span><span class="n">possibleNewBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	       <span class="n">newBuilder</span> <span class="o">=</span> <span class="n">possibleNewBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	   <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>``AbstractClassEnhancePluginDefine <code> 是所有插件的父类。</code>define<code>方法先进行 </code>witness<code>版本识别，然后调用</code>enhance<code>方法，根据 </code>静态方法、实例方法/构造器、JDK类库中类<code>分类进行不同的增强。然后具体的增强实现要看 </code>ClassEnhancePluginDefine[子类] 的 enhanceInstance() 和enhanceClass() <code>这两个方法</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 所有插件的父类
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Basic abstract class of all sky-walking auto-instrumentation plugins.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * It provides the outline of enhancing the target class. If you want to know more about enhancing, you should go to see
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link ClassEnhancePluginDefine}
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractClassEnhancePluginDefine</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">AbstractClassEnhancePluginDefine</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * New field name.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONTEXT_ATTR_NAME</span> <span class="o">=</span> <span class="s">&#34;_$EnhancedClassField_ws&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Main entrance of enhancing the class.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param builder         当前拦截到的类的字节码
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param typeDescription 简单当成 Class ,它包含了类的描述信息
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param classLoader     加载 【当前拦截到的类】的类加载器
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param typeDescription target class description.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param builder         byte-buddy&#39;s builder to manipulate target class&#39;s bytecode.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param classLoader     load the given transformClass
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the new builder, or &lt;code&gt;null&lt;/code&gt; if not be enhanced.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws PluginException when set builder failure.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">define</span><span class="o">(</span><span class="n">TypeDescription</span> <span class="n">typeDescription</span><span class="o">,</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">builder</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">,</span> <span class="n">EnhanceContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 当前插件的名字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">interceptorDefineClassName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 被拦截的类的 className
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">transformClassName</span> <span class="o">=</span> <span class="n">typeDescription</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">transformClassName</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;classname of being intercepted is not defined by {}.&#34;</span><span class="o">,</span> <span class="n">interceptorDefineClassName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;prepare to enhance class {} by {}.&#34;</span><span class="o">,</span> <span class="n">transformClassName</span><span class="o">,</span> <span class="n">interceptorDefineClassName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// witness 版本识别 [细节可以不去了解]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 来确认这个插件是不是可以用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">WitnessFinder</span> <span class="n">finder</span> <span class="o">=</span> <span class="n">WitnessFinder</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * find witness classes for enhance class
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 根据类来识别
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span><span class="o">[]</span> <span class="n">witnessClasses</span> <span class="o">=</span> <span class="n">witnessClasses</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">witnessClasses</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">witnessClass</span> <span class="o">:</span> <span class="n">witnessClasses</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">finder</span><span class="o">.</span><span class="na">exist</span><span class="o">(</span><span class="n">witnessClass</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;enhance class {} by plugin {} is not working. Because witness class {} is not existed.&#34;</span><span class="o">,</span> <span class="n">transformClassName</span><span class="o">,</span> <span class="n">interceptorDefineClassName</span><span class="o">,</span> <span class="n">witnessClass</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 根据方法来识别
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">WitnessMethod</span><span class="o">&gt;</span> <span class="n">witnessMethods</span> <span class="o">=</span> <span class="n">witnessMethods</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">CollectionUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">witnessMethods</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">WitnessMethod</span> <span class="n">witnessMethod</span> <span class="o">:</span> <span class="n">witnessMethods</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">finder</span><span class="o">.</span><span class="na">exist</span><span class="o">(</span><span class="n">witnessMethod</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;enhance class {} by plugin {} is not working. Because witness method {} is not existed.&#34;</span><span class="o">,</span> <span class="n">transformClassName</span><span class="o">,</span> <span class="n">interceptorDefineClassName</span><span class="o">,</span> <span class="n">witnessMethod</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * find origin class source code for interceptor
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 进行字节码增强 【重点】
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">enhance</span><span class="o">(</span><span class="n">typeDescription</span><span class="o">,</span> <span class="n">builder</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置 增强标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">context</span><span class="o">.</span><span class="na">initializationStageCompleted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;enhance class {} by {} completely.&#34;</span><span class="o">,</span> <span class="n">transformClassName</span><span class="o">,</span> <span class="n">interceptorDefineClassName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newClassBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 增强方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Begin to define how to enhance class. After invoke this method, only means definition is finished.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param typeDescription target class description
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param newClassBuilder byte-buddy&#39;s builder to manipulate class bytecode.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return new byte-buddy&#39;s builder for further manipulation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">enhance</span><span class="o">(</span><span class="n">TypeDescription</span> <span class="n">typeDescription</span><span class="o">,</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">newClassBuilder</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">,</span> <span class="n">EnhanceContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 增强类的静态方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">enhanceClass</span><span class="o">(</span><span class="n">typeDescription</span><span class="o">,</span> <span class="n">newClassBuilder</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 增强实例和构造器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">enhanceInstance</span><span class="o">(</span><span class="n">typeDescription</span><span class="o">,</span> <span class="n">newClassBuilder</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newClassBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 增强类以拦截构造函数和类实例方法。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 看实现类 {@link   ClassEnhancePluginDefine#enhanceInstance(TypeDescription, DynamicType.Builder, ClassLoader, EnhanceContext)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Enhance a class to intercept constructors and class instance methods.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param typeDescription target class description
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param newClassBuilder byte-buddy&#39;s builder to manipulate class bytecode.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return new byte-buddy&#39;s builder for further manipulation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">enhanceInstance</span><span class="o">(</span><span class="n">TypeDescription</span> <span class="n">typeDescription</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">newClassBuilder</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="n">EnhanceContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 增强类以拦截类静态方法。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 看实现类 {@link   ClassEnhancePluginDefine#enhanceClass(TypeDescription, DynamicType.Builder, ClassLoader)}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Enhance a class to intercept class static methods.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param typeDescription target class description
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param newClassBuilder byte-buddy&#39;s builder to manipulate class bytecode.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return new byte-buddy&#39;s builder for further manipulation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">enhanceClass</span><span class="o">(</span><span class="n">TypeDescription</span> <span class="n">typeDescription</span><span class="o">,</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">newClassBuilder</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>ClassEnhancePluginDefine</code> 是 <code>AbstractClassEnhancePluginDefine</code>子类。实现了具体的增强逻辑。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ClassEnhancePluginDefine</span> <span class="kd">extends</span> <span class="n">AbstractClassEnhancePluginDefine</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ClassEnhancePluginDefine</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 增强类的静态方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Enhance a class to intercept constructors and class instance methods.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param typeDescription target class description
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param newClassBuilder byte-buddy&#39;s builder to manipulate class bytecode.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return new byte-buddy&#39;s builder for further manipulation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">enhanceInstance</span><span class="o">(</span><span class="n">TypeDescription</span> <span class="n">typeDescription</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">newClassBuilder</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">EnhanceContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取拦截点 (构造方法拦截点，实例方法拦截点)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ConstructorInterceptPoint</span><span class="o">[]</span> <span class="n">constructorInterceptPoints</span> <span class="o">=</span> <span class="n">getConstructorsInterceptPoints</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">InstanceMethodsInterceptPoint</span><span class="o">[]</span> <span class="n">instanceMethodsInterceptPoints</span> <span class="o">=</span> <span class="n">getInstanceMethodsInterceptPoints</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 被拦截的类的类名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">enhanceOriginClassName</span> <span class="o">=</span> <span class="n">typeDescription</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">existedConstructorInterceptPoint</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">constructorInterceptPoints</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">constructorInterceptPoints</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">existedConstructorInterceptPoint</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">existedMethodsInterceptPoints</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">instanceMethodsInterceptPoints</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">instanceMethodsInterceptPoints</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">existedMethodsInterceptPoints</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * nothing need to be enhanced in class instance, maybe need enhance static methods.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">existedConstructorInterceptPoint</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">existedMethodsInterceptPoints</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">newClassBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 修改类的源码
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Manipulate class source code.&lt;br/&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * new class need:&lt;br/&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 1.Add field, name {@link #CONTEXT_ATTR_NAME}.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 2.Add a field accessor for this field.
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * And make sure the source codes manipulation only occurs once.
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">typeDescription</span><span class="o">.</span><span class="na">isAssignableTo</span><span class="o">(</span><span class="n">EnhancedInstance</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">context</span><span class="o">.</span><span class="na">isObjectExtended</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 增加字段或者方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 增加这个字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">.</span><span class="na">defineField</span><span class="o">(</span><span class="n">CONTEXT_ATTR_NAME</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ACC_PRIVATE</span> <span class="o">|</span> <span class="n">ACC_VOLATILE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 实现这个类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">.</span><span class="na">implement</span><span class="o">(</span><span class="n">EnhancedInstance</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">FieldAccessor</span><span class="o">.</span><span class="na">ofField</span><span class="o">(</span><span class="n">CONTEXT_ATTR_NAME</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="o">.</span><span class="na">extendObjectCompleted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 存在 构造器拦截点
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 2. enhance constructors
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">existedConstructorInterceptPoint</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">ConstructorInterceptPoint</span> <span class="n">constructorInterceptPoint</span> <span class="o">:</span> <span class="n">constructorInterceptPoints</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">isBootstrapInstrumentation</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span><span class="o">.</span><span class="na">constructor</span><span class="o">(</span><span class="n">constructorInterceptPoint</span><span class="o">.</span><span class="na">getConstructorMatcher</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                                                     <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">SuperMethodCall</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">andThen</span><span class="o">(</span><span class="n">MethodDelegation</span><span class="o">.</span><span class="na">withDefaultConfiguration</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                                                                 <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">BootstrapInstrumentBoost</span>
</span></span><span class="line"><span class="cl">                                                                                                                     <span class="o">.</span><span class="na">forInternalDelegateClass</span><span class="o">(</span><span class="n">constructorInterceptPoint</span>
</span></span><span class="line"><span class="cl">                                                                                                                         <span class="o">.</span><span class="na">getConstructorInterceptor</span><span class="o">()))));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span><span class="o">.</span><span class="na">constructor</span><span class="o">(</span><span class="n">constructorInterceptPoint</span><span class="o">.</span><span class="na">getConstructorMatcher</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// 代理的逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                     <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">SuperMethodCall</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">andThen</span><span class="o">(</span><span class="n">MethodDelegation</span><span class="o">.</span><span class="na">withDefaultConfiguration</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                                                                 <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="k">new</span> <span class="n">ConstructorInter</span><span class="o">(</span><span class="n">constructorInterceptPoint</span>
</span></span><span class="line"><span class="cl">                                                                                                                     <span class="o">.</span><span class="na">getConstructorInterceptor</span><span class="o">(),</span> <span class="n">classLoader</span><span class="o">))));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 存在实例方法 拦截前
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 3. enhance instance methods
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">existedMethodsInterceptPoints</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">InstanceMethodsInterceptPoint</span> <span class="n">instanceMethodsInterceptPoint</span> <span class="o">:</span> <span class="n">instanceMethodsInterceptPoints</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">interceptor</span> <span class="o">=</span> <span class="n">instanceMethodsInterceptPoint</span><span class="o">.</span><span class="na">getMethodsInterceptor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">interceptor</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">EnhanceException</span><span class="o">(</span><span class="s">&#34;no InstanceMethodsAroundInterceptor define to enhance class &#34;</span> <span class="o">+</span> <span class="n">enhanceOriginClassName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">ElementMatcher</span><span class="o">.</span><span class="na">Junction</span><span class="o">&lt;</span><span class="n">MethodDescription</span><span class="o">&gt;</span> <span class="n">junction</span> <span class="o">=</span> <span class="n">not</span><span class="o">(</span><span class="n">isStatic</span><span class="o">()).</span><span class="na">and</span><span class="o">(</span><span class="n">instanceMethodsInterceptPoint</span><span class="o">.</span><span class="na">getMethodsMatcher</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// DeclaredInstanceMethodsInterceptPoint 声明式拦截点。一般用于判断spring 的注解
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">instanceMethodsInterceptPoint</span> <span class="k">instanceof</span> <span class="n">DeclaredInstanceMethodsInterceptPoint</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 辅助判断。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">junction</span> <span class="o">=</span> <span class="n">junction</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">ElementMatchers</span><span class="o">.&lt;</span><span class="n">MethodDescription</span><span class="o">&gt;</span><span class="n">isDeclaredBy</span><span class="o">(</span><span class="n">typeDescription</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">instanceMethodsInterceptPoint</span><span class="o">.</span><span class="na">isOverrideArgs</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 重写入参？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">isBootstrapInstrumentation</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">junction</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                         <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">MethodDelegation</span><span class="o">.</span><span class="na">withDefaultConfiguration</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                                    <span class="o">.</span><span class="na">withBinders</span><span class="o">(</span><span class="n">Morph</span><span class="o">.</span><span class="na">Binder</span><span class="o">.</span><span class="na">install</span><span class="o">(</span><span class="n">OverrideCallable</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                                                                    <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">BootstrapInstrumentBoost</span><span class="o">.</span><span class="na">forInternalDelegateClass</span><span class="o">(</span><span class="n">interceptor</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">junction</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                         <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">MethodDelegation</span><span class="o">.</span><span class="na">withDefaultConfiguration</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                                    <span class="o">.</span><span class="na">withBinders</span><span class="o">(</span><span class="n">Morph</span><span class="o">.</span><span class="na">Binder</span><span class="o">.</span><span class="na">install</span><span class="o">(</span><span class="n">OverrideCallable</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                                                                    <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="k">new</span> <span class="n">InstMethodsInterWithOverrideArgs</span><span class="o">(</span><span class="n">interceptor</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 没有重新入参
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">isBootstrapInstrumentation</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">junction</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                         <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">MethodDelegation</span><span class="o">.</span><span class="na">withDefaultConfiguration</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                                    <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">BootstrapInstrumentBoost</span><span class="o">.</span><span class="na">forInternalDelegateClass</span><span class="o">(</span><span class="n">interceptor</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">junction</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                         <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">MethodDelegation</span><span class="o">.</span><span class="na">withDefaultConfiguration</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                                    <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="k">new</span> <span class="n">InstMethodsInter</span><span class="o">(</span><span class="n">interceptor</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newClassBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 静态方法增强逻辑
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Enhance a class to intercept class static methods.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param typeDescription target class description
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param newClassBuilder byte-buddy&#39;s builder to manipulate class bytecode.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return new byte-buddy&#39;s builder for further manipulation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">enhanceClass</span><span class="o">(</span><span class="n">TypeDescription</span> <span class="n">typeDescription</span><span class="o">,</span> <span class="n">DynamicType</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">newClassBuilder</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PluginException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取静态方法拦截点。 调用的 AbstractClassEnhancePluginDefine 的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 其实就是插件定中，写的那个方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">StaticMethodsInterceptPoint</span><span class="o">[]</span> <span class="n">staticMethodsInterceptPoints</span> <span class="o">=</span> <span class="n">getStaticMethodsInterceptPoints</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 简单认为获取className
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">enhanceOriginClassName</span> <span class="o">=</span> <span class="n">typeDescription</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">staticMethodsInterceptPoints</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">staticMethodsInterceptPoints</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">newClassBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">StaticMethodsInterceptPoint</span> <span class="n">staticMethodsInterceptPoint</span> <span class="o">:</span> <span class="n">staticMethodsInterceptPoints</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">interceptor</span> <span class="o">=</span> <span class="n">staticMethodsInterceptPoint</span><span class="o">.</span><span class="na">getMethodsInterceptor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 没有拦截器，就报错
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">interceptor</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">EnhanceException</span><span class="o">(</span><span class="s">&#34;no StaticMethodsAroundInterceptor define to enhance class &#34;</span> <span class="o">+</span> <span class="n">enhanceOriginClassName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 是否修改原方法入参
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">staticMethodsInterceptPoint</span><span class="o">.</span><span class="na">isOverrideArgs</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// BootstrapClassLoader 加载器加载的插件吗？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 换个说法就是  是JDK类库中的类吗
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">isBootstrapInstrumentation</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">isStatic</span><span class="o">().</span><span class="na">and</span><span class="o">(</span><span class="n">staticMethodsInterceptPoint</span><span class="o">.</span><span class="na">getMethodsMatcher</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// intercept 拦截
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">MethodDelegation</span><span class="o">.</span><span class="na">withDefaultConfiguration</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">.</span><span class="na">withBinders</span><span class="o">(</span><span class="n">Morph</span><span class="o">.</span><span class="na">Binder</span><span class="o">.</span><span class="na">install</span><span class="o">(</span><span class="n">OverrideCallable</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">BootstrapInstrumentBoost</span><span class="o">.</span><span class="na">forInternalDelegateClass</span><span class="o">(</span><span class="n">interceptor</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 修改参数的，静态方法增强逻辑。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">isStatic</span><span class="o">().</span><span class="na">and</span><span class="o">(</span><span class="n">staticMethodsInterceptPoint</span><span class="o">.</span><span class="na">getMethodsMatcher</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">MethodDelegation</span><span class="o">.</span><span class="na">withDefaultConfiguration</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">.</span><span class="na">withBinders</span><span class="o">(</span><span class="n">Morph</span><span class="o">.</span><span class="na">Binder</span><span class="o">.</span><span class="na">install</span><span class="o">(</span><span class="n">OverrideCallable</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="k">new</span> <span class="n">StaticMethodsInterWithOverrideArgs</span><span class="o">(</span><span class="n">interceptor</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// BootstrapClassLoader 加载器加载的插件吗？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 换个说法就是  是JDK类库中的类吗
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">isBootstrapInstrumentation</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">isStatic</span><span class="o">().</span><span class="na">and</span><span class="o">(</span><span class="n">staticMethodsInterceptPoint</span><span class="o">.</span><span class="na">getMethodsMatcher</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">MethodDelegation</span><span class="o">.</span><span class="na">withDefaultConfiguration</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">BootstrapInstrumentBoost</span><span class="o">.</span><span class="na">forInternalDelegateClass</span><span class="o">(</span><span class="n">interceptor</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">newClassBuilder</span> <span class="o">=</span> <span class="n">newClassBuilder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">isStatic</span><span class="o">().</span><span class="na">and</span><span class="o">(</span><span class="n">staticMethodsInterceptPoint</span><span class="o">.</span><span class="na">getMethodsMatcher</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="c1">// intercept 拦截
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="c1">// StaticMethodsInter 包装的一个代理类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">MethodDelegation</span><span class="o">.</span><span class="na">withDefaultConfiguration</span><span class="o">().</span><span class="na">to</span><span class="o">(</span><span class="k">new</span> <span class="n">StaticMethodsInter</span><span class="o">(</span><span class="n">interceptor</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newClassBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return null, means enhance no v2 instance methods.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">InstanceMethodsInterceptV2Point</span><span class="o">[]</span> <span class="nf">getInstanceMethodsInterceptV2Points</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return null, means enhance no v2 static methods.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">StaticMethodsInterceptV2Point</span><span class="o">[]</span> <span class="nf">getStaticMethodsInterceptV2Points</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="服务" class="headerLink">
    <a href="#%e6%9c%8d%e5%8a%a1" class="header-mark"></a>服务</h3><h4 id="bootservice" class="headerLink">
    <a href="#bootservice" class="header-mark"></a><code>BootService</code></h4><p>是所有服务的顶层接口，定义了服务的声明周期</p>
<ul>
<li>
<p>准备阶段 <code>prepare</code></p>
</li>
<li>
<p>启动阶段 <code>boot</code></p>
</li>
<li>
<p>启动完成阶段 <code>onComplete</code></p>
</li>
<li>
<p>关闭阶段 <code>shutdown</code></p>
</li>
<li>
<p>优先级 <code>priority</code></p>
<p>优先级高的服务先启动，后关闭</p>
</li>
</ul>
<h4 id="grpcchannelmanager" class="headerLink">
    <a href="#grpcchannelmanager" class="header-mark"></a><code>GRPCChannelManager</code></h4><blockquote>
<p>Agent到 OAP 的大动脉，也就是网络链接</p>
</blockquote>
<p><code>GRPCChannelManager</code>服务负责Agent和OAP直接的网络通信。他的职责是创建链接、通信检查和通知。</p>
<p>重点逻辑在<code>run</code>方法里</p>
<ol>
<li>
<p>根据 <code>IS_RESOLVE_DNS_PERIODICALLY</code>、<code>reconnect</code> 属性，判断是否要刷新DNS 或者重连。条件成立就重新解析 OAP的网络地址</p>
</li>
<li>
<p>根据<code>reconnect</code> 属性进行重连操作，在<code>OAP</code>网络地址 &gt;0 的情况下。</p>
</li>
<li>
<p>假设有多个OAP地址，那就换个地址进行连接，</p>
<ol>
<li>
<p>假设有多个OAP地址，那就换个地址进行连接，</p>
<ol>
<li>先关闭上次的链接，如果有的话。</li>
<li>新建连接，</li>
<li>通知所有用到这个连接的服务，这个网络可以用了。<code>GRPCChannelManager提供了注册监听的功能，有需要的服务可以接收到网络状态变动的通知</code></li>
<li>设置网络重连册数 为0</li>
<li>设置重连标志为false</li>
</ol>
</li>
<li>
<p>不巧，只有一个，那只能依靠GRPC的重连策略了。</p>
<ol>
<li>成功了,发通知。没成功，就等下一轮吧</li>
</ol>
</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 这个服务是 Agent到 OAP 的大动脉，也就是网络链接
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultImplementor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GRPCChannelManager</span> <span class="kd">implements</span> <span class="n">BootService</span><span class="o">,</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 网络连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">GRPCChannel</span> <span class="n">managedChannel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 网络连接状态定时检查调度器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">ScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">connectCheckFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 当前链接 是否需要重连
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">reconnect</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">GRPCChannelListener</span><span class="o">&gt;</span> <span class="n">listeners</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// oap 地址列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">grpcServers</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 上次选择的 OAP 地址的 下标索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">selectedIdx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置网络重连次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">reconnectCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查 OPA 地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">BACKEND_SERVICE</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Collector server addresses are not set.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Agent will not uplink any data.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">grpcServers</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">BACKEND_SERVICE</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建线程池。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 添加一个定时任务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">connectCheckFuture</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">DefaultNamedThreadFactory</span><span class="o">(</span><span class="s">&#34;GRPCChannelManager&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">).</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 任务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">new</span> <span class="n">RunnableWithExceptionProtection</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;unexpected exception.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">GRPC_CHANNEL_CHECK_INTERVAL</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 关闭调度器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">connectCheckFuture</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">connectCheckFuture</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 关闭连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">managedChannel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">managedChannel</span><span class="o">.</span><span class="na">shutdownNow</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Selected collector grpc service shutdown.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Selected collector grpc service running, reconnect:{}.&#34;</span><span class="o">,</span> <span class="n">reconnect</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 需要刷新DNS 并且 需要重连。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">IS_RESOLVE_DNS_PERIODICALLY</span> <span class="o">&amp;&amp;</span> <span class="n">reconnect</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 第一个后端地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">backendService</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">BACKEND_SERVICE</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">)[</span><span class="mi">0</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span><span class="o">[]</span> <span class="n">domainAndPort</span> <span class="o">=</span> <span class="n">backendService</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;:&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 找到 domain 对应的所有IP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">newGrpcServers</span> <span class="o">=</span> <span class="n">Arrays</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">InetAddress</span><span class="o">.</span><span class="na">getAllByName</span><span class="o">(</span><span class="n">domainAndPort</span><span class="o">[</span><span class="mi">0</span><span class="o">]))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">InetAddress</span><span class="o">::</span><span class="n">getHostAddress</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">ip</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;%s:%s&#34;</span><span class="o">,</span> <span class="n">ip</span><span class="o">,</span> <span class="n">domainAndPort</span><span class="o">[</span><span class="mi">1</span><span class="o">]))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">grpcServers</span> <span class="o">=</span> <span class="n">newGrpcServers</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;Failed to resolve {} of backend service.&#34;</span><span class="o">,</span> <span class="n">backendService</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">reconnect</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">grpcServers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">server</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 计算索引下标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">())</span> <span class="o">%</span> <span class="n">grpcServers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// 不等于上次的下标。 表示要换个OAP地址。 去重连
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="n">selectedIdx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">selectedIdx</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="n">server</span> <span class="o">=</span> <span class="n">grpcServers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">String</span><span class="o">[]</span> <span class="n">ipAndPort</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;:&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// 关闭上次的链接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="n">managedChannel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">managedChannel</span><span class="o">.</span><span class="na">shutdownNow</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// 新建链接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">managedChannel</span> <span class="o">=</span> <span class="n">GRPCChannel</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="n">ipAndPort</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">ipAndPort</span><span class="o">[</span><span class="mi">1</span><span class="o">]))</span>
</span></span><span class="line"><span class="cl">                                                    <span class="o">.</span><span class="na">addManagedChannelBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">StandardChannelBuilder</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                                                    <span class="o">.</span><span class="na">addManagedChannelBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">TLSChannelBuilder</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                                                    <span class="o">.</span><span class="na">addChannelDecorator</span><span class="o">(</span><span class="k">new</span> <span class="n">AgentIDDecorator</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                                                    <span class="o">.</span><span class="na">addChannelDecorator</span><span class="o">(</span><span class="k">new</span> <span class="n">AuthenticationDecorator</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                                                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 通知所有使用到这个网络连接的服务。 这个网络可以用了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">notify</span><span class="o">(</span><span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">CONNECTED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 设置网络重连册数 为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">reconnectCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 设置 不需要重连了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">reconnect</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">managedChannel</span><span class="o">.</span><span class="na">isConnected</span><span class="o">(++</span><span class="n">reconnectCount</span> <span class="o">&gt;</span> <span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">FORCE_RECONNECTION_PERIOD</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 是否已经连接上了(原地址)。可以理解为 恢复了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Reconnect to the same server is automatically done by GRPC,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// therefore we are responsible to check the connectivity and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// set the state and notify listeners
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">reconnectCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">notify</span><span class="o">(</span><span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">CONNECTED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">reconnect</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;Create channel to {} fail.&#34;</span><span class="o">,</span> <span class="n">server</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Selected collector grpc service is not available. Wait {} seconds to retry&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">GRPC_CHANNEL_CHECK_INTERVAL</span>
</span></span><span class="line"><span class="cl">            <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addChannelListener</span><span class="o">(</span><span class="n">GRPCChannelListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">listeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Channel</span> <span class="nf">getChannel</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">managedChannel</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If the given exception is triggered by network problem, connect in background.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 报告一个错误。如果是网络异常 。1.设置重连,2.通知所有监听者
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reportError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">isNetworkError</span><span class="o">(</span><span class="n">throwable</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">reconnect</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">notify</span><span class="o">(</span><span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">DISCONNECT</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">notify</span><span class="o">(</span><span class="n">GRPCChannelStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 通知所有的监听器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">GRPCChannelListener</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">listeners</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">listener</span><span class="o">.</span><span class="na">statusChanged</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;Fail to notify {} about channel connected.&#34;</span><span class="o">,</span> <span class="n">listener</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isNetworkError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="k">instanceof</span> <span class="n">StatusRuntimeException</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">StatusRuntimeException</span> <span class="n">statusRuntimeException</span> <span class="o">=</span> <span class="o">(</span><span class="n">StatusRuntimeException</span><span class="o">)</span> <span class="n">throwable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">statusEquals</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">statusRuntimeException</span><span class="o">.</span><span class="na">getStatus</span><span class="o">(),</span> <span class="n">Status</span><span class="o">.</span><span class="na">UNAVAILABLE</span><span class="o">,</span> <span class="n">Status</span><span class="o">.</span><span class="na">PERMISSION_DENIED</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">Status</span><span class="o">.</span><span class="na">UNAUTHENTICATED</span><span class="o">,</span> <span class="n">Status</span><span class="o">.</span><span class="na">RESOURCE_EXHAUSTED</span><span class="o">,</span> <span class="n">Status</span><span class="o">.</span><span class="na">UNKNOWN</span>
</span></span><span class="line"><span class="cl">            <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">statusEquals</span><span class="o">(</span><span class="n">Status</span> <span class="n">sourceStatus</span><span class="o">,</span> <span class="n">Status</span><span class="o">...</span> <span class="n">potentialStatus</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Status</span> <span class="n">status</span> <span class="o">:</span> <span class="n">potentialStatus</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">sourceStatus</span><span class="o">.</span><span class="na">getCode</span><span class="o">()</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="na">getCode</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">priority</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="servicemanagementclient" class="headerLink">
    <a href="#servicemanagementclient" class="header-mark"></a><code>ServiceManagementClient</code></h4><blockquote>
<p>负责数据汇报和心跳</p>
</blockquote>
<p>和 <code>GRPCChannelManager</code>一样，使用线程池执行定时任务， ``逻辑主要在<code>run</code>方法中。</p>
<p>实现了 <code>GRPCChannelListener</code>接口，监听网络的变动，如果连接是通的，则实例化<code>managementServiceBlockingStub</code>属性，准备向OAP发送数据。</p>
<p><strong><code>run</code>方法的逻辑</strong></p>
<p>首先，定时任务的周期是30秒。根据周期和配置中的汇报频率因子进行判断<code>(默认是5分钟)</code>，条件成立的话，汇报数据。否则发送心跳<code>(也就是30秒发送一次心跳)</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 建立连接后 打招呼/自报家门
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. 将当前 Agent Client 的基本信息汇报给 OAP
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. 和OAP 保持心跳
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultImplementor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceManagementClient</span> <span class="kd">implements</span> <span class="n">BootService</span><span class="o">,</span> <span class="n">Runnable</span><span class="o">,</span> <span class="n">GRPCChannelListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ServiceManagementClient</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Agent Client 信息
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">KeyStringValuePair</span><span class="o">&gt;</span> <span class="n">SERVICE_INSTANCE_PROPERTIES</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 当前网络连接状态
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">GRPCChannelStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">DISCONNECT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * grpc 的 Stub 可以理解为 在 protobuf 中定义的 XxxService
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 这里是  网络服务
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">ManagementServiceGrpc</span><span class="o">.</span><span class="na">ManagementServiceBlockingStub</span> <span class="n">managementServiceBlockingStub</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">ScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">heartbeatFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Agent Client 信息发送计数器
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">AtomicInteger</span> <span class="n">sendPropertiesCounter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 网络状态变动
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param status
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">statusChanged</span><span class="o">(</span><span class="n">GRPCChannelStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 是连接的？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">CONNECTED</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">status</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 找到ServiceManager 服务，拿到网络连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//  grpc 的 Stub 可以理解为 在 protobuf 中定义的 XxxService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">managementServiceBlockingStub</span> <span class="o">=</span> <span class="n">ManagementServiceGrpc</span><span class="o">.</span><span class="na">newBlockingStub</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">managementServiceBlockingStub</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 把自身注册为监听器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">addChannelListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">SERVICE_INSTANCE_PROPERTIES</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 从配置文件中读取数据  Config.Agent.INSTANCE_PROPERTIES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 把 配置文件中的 Agent Client 信息放入集合、等待发送
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">INSTANCE_PROPERTIES</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SERVICE_INSTANCE_PROPERTIES</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">KeyStringValuePair</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">setKey</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">INSTANCE_PROPERTIES</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建线程池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 和 GRPCChannelManager  一样
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">heartbeatFuture</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">DefaultNamedThreadFactory</span><span class="o">(</span><span class="s">&#34;ServiceManagementClient&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">).</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 放入this。 看run方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">new</span> <span class="n">RunnableWithExceptionProtection</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="k">this</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;unexpected exception.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">HEARTBEAT_PERIOD</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">heartbeatFuture</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ServiceManagementClient running, status:{}.&#34;</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 是否已连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">CONNECTED</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">status</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">managementServiceBlockingStub</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 取绝对值？ 发送次数过多的情况下，可能超过int最大值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 心跳周期是30秒，信息汇报频率因子 = 10  ==&gt; 以此推论。每5分钟 向OAP 汇报一次 Agent Client 的 Properties
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// Round 1, counter = 0 0%10 =0  //条件成立
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// Round 2, counter = 1 1%10 =1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">sendPropertiesCounter</span><span class="o">.</span><span class="na">getAndAdd</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">%</span> <span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">PROPERTIES_REPORT_PERIOD_FACTOR</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// 组装数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">managementServiceBlockingStub</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">withDeadlineAfter</span><span class="o">(</span><span class="n">GRPC_UPSTREAM_TIMEOUT</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">reportInstanceProperties</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">InstanceProperties</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">.</span><span class="na">setService</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">SERVICE_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">.</span><span class="na">setServiceInstance</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">INSTANCE_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">.</span><span class="na">addAllProperties</span><span class="o">(</span><span class="n">OSUtil</span><span class="o">.</span><span class="na">buildOSInfo</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                                        <span class="n">Config</span><span class="o">.</span><span class="na">OsInfo</span><span class="o">.</span><span class="na">IPV4_LIST_SIZE</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">.</span><span class="na">addAllProperties</span><span class="o">(</span><span class="n">SERVICE_INSTANCE_PROPERTIES</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">.</span><span class="na">addAllProperties</span><span class="o">(</span><span class="n">LoadedLibraryCollector</span><span class="o">.</span><span class="na">buildJVMInfo</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                <span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 发送心跳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kd">final</span> <span class="n">Commands</span> <span class="n">commands</span> <span class="o">=</span> <span class="n">managementServiceBlockingStub</span><span class="o">.</span><span class="na">withDeadlineAfter</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                <span class="n">GRPC_UPSTREAM_TIMEOUT</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span>
</span></span><span class="line"><span class="cl">                        <span class="o">).</span><span class="na">keepAlive</span><span class="o">(</span><span class="n">InstancePingPkg</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">setService</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">SERVICE_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">setServiceInstance</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">INSTANCE_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// 处理服务端相应数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">CommandService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">receiveCommand</span><span class="o">(</span><span class="n">commands</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;ServiceManagementClient execute fail.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">reportError</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="commandservice" class="headerLink">
    <a href="#commandservice" class="header-mark"></a><code>CommandService</code></h4><blockquote>
<p>可以理解为 Command Scheduler 命令的调度器</p>
<p>收集 OAP 返回的 CommandS， 然后分发给不同的处理器去处理</p>
</blockquote>
<p><em><strong>属性字段</strong></em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 命名的处理流程，是否在运行
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 初始化 单线程线程池
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">DefaultNamedThreadFactory</span><span class="o">(</span><span class="s">&#34;CommandService&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 待处理命令列表
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">BaseCommand</span><span class="o">&gt;</span> <span class="n">commands</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">64</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 序列号缓存
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 里面是个先入先出的队列，默认能放64个，
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">CommandSerialNumberCache</span> <span class="n">serialNumberCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CommandSerialNumberCache</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em><strong>逻辑</strong></em></p>
<ol>
<li>
<p>生命周期</p>
<p>启动阶段<code>boot()</code>向线程池提交任务，是自己的<code>run()</code>方法。是一个循环，在<code>isRunning = true</code>的情况下，不停的从待处理命令队列<code>this.commands</code>中取出数据，通过 命令序列号缓存<code>serialNumberCache</code>验证，保证命令不会重复进行，最后交由<code>CommandExecutorService</code>进行处理。</p>
</li>
<li>
<p><code>receiveCommand</code></p>
<p>被<code>ServiceManagementClient</code>调用的方法，用来接收服务端返回的<code>command</code>数据，进行反序列化，最后放到<code>this.commands</code>中，供<code>CommandExecutorService</code>方法处理。</p>
</li>
</ol>
<p><em><strong>源码</strong></em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 可以理解为 Command Scheduler 命令的调度器
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 收集 OAP 返回的 CommandS， 然后分发给不同的处理器去处理
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultImplementor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommandService</span> <span class="kd">implements</span> <span class="n">BootService</span><span class="o">,</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">CommandService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 命名的处理流程，是否在运行
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 初始化 单线程线程池
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">DefaultNamedThreadFactory</span><span class="o">(</span><span class="s">&#34;CommandService&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 待处理命令列表
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">BaseCommand</span><span class="o">&gt;</span> <span class="n">commands</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">64</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 序列号缓存
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 里面是个先入先出的队列，默认能放64个，
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CommandSerialNumberCache</span> <span class="n">serialNumberCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CommandSerialNumberCache</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 启动阶段。提交一个自己到线程池
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Throwable
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">RunnableWithExceptionProtection</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;CommandService failed to execute commands&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 不断从命令队列(任务队列)中取出任务，交给执行器去执行。
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">CommandExecutorService</span> <span class="n">commandExecutorService</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">CommandExecutorService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// isRunning 命名的处理流程，是否在运行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">while</span> <span class="o">(</span><span class="n">isRunning</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">BaseCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// 命令是否已经执行了  ==》 有没有缓存这个序列号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 保证 同一个命令，不重复执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">isCommandExecuted</span><span class="o">(</span><span class="n">command</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 交给 commandExecutorService 处理命令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">commandExecutorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 命令序列号缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">serialNumberCache</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getSerialNumber</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;Failed to take commands.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CommandExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;Failed to execute command[{}].&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">command</span><span class="o">().</span><span class="na">getCommand</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;There is unexpected exception&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isCommandExecuted</span><span class="o">(</span><span class="n">BaseCommand</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">serialNumberCache</span><span class="o">.</span><span class="na">contain</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getSerialNumber</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 清空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">commands</span><span class="o">.</span><span class="na">drainTo</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;());</span>
</span></span><span class="line"><span class="cl">        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  被 ServiceManagementClient  调用的方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param commands 接收到命令s
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receiveCommand</span><span class="o">(</span><span class="n">Commands</span> <span class="n">commands</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Command</span> <span class="n">command</span> <span class="o">:</span> <span class="n">commands</span><span class="o">.</span><span class="na">getCommandsList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 反序列化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">BaseCommand</span> <span class="n">baseCommand</span> <span class="o">=</span> <span class="n">CommandDeserializer</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// 已经执行过了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">isCommandExecuted</span><span class="o">(</span><span class="n">baseCommand</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Command[{}] is executed, ignored&#34;</span><span class="o">,</span> <span class="n">baseCommand</span><span class="o">.</span><span class="na">getCommand</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 放入 this.commands  待处理的命令队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">commands</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">baseCommand</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="n">LOGGER</span><span class="o">.</span><span class="na">isWarnEnable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;Command[{}, {}] cannot add to command list. because the command list is full.&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">baseCommand</span><span class="o">.</span><span class="na">getCommand</span><span class="o">(),</span> <span class="n">baseCommand</span><span class="o">.</span><span class="na">getSerialNumber</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnsupportedCommandException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isWarnEnable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Received unsupported command[{}].&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getCommand</span><span class="o">().</span><span class="na">getCommand</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em><strong>涉及到的类</strong></em></p>
<h5 id="commandserialnumbercache" class="headerLink">
    <a href="#commandserialnumbercache" class="header-mark"></a><code>CommandSerialNumberCache</code></h5><blockquote>
<p>命令序列号缓存。</p>
<p>服务端返回的<code>command</code>数据，每一条都有一个序列号。这里进行缓存，主要是保证每一个<code>command</code>只执行一次，避免重复执行。</p>
<p>内部结构是一个容量是64的先入先出队列。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 命令的序列号缓存。序列号被放到一个队列里面，
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 容量控制为64，先入先出
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommandSerialNumberCache</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_MAX_CAPACITY</span> <span class="o">=</span> <span class="mi">64</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Deque</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">CommandSerialNumberCache</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">DEFAULT_MAX_CAPACITY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">CommandSerialNumberCache</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedBlockingDeque</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">maxCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">maxCapacity</span> <span class="o">=</span> <span class="n">maxCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">String</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">queue</span><span class="o">.</span><span class="na">pollFirst</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">number</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contain</span><span class="o">(</span><span class="n">String</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queue</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="commanddeserializer" class="headerLink">
    <a href="#commanddeserializer" class="header-mark"></a><code>CommandDeserializer</code></h5><p>在<code>receiveCommand</code>方法中，有一步反序列的操作，就是使用<code>CommandDeserializer</code> 完成的。其实这个也是分发，根据<code>commandName</code>交给不同的反序列化器再去反序列化。目前有两个</p>
<ul>
<li><code>ProfileTaskCommand</code>: 性能追踪命令反序列化器</li>
<li><code>ConfigurationDiscoveryCommand</code>: 配置发现命令反序列化器</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 反序列化器
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommandDeserializer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">BaseCommand</span> <span class="nf">deserialize</span><span class="o">(</span><span class="kd">final</span> <span class="n">Command</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">String</span> <span class="n">commandName</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="na">getCommand</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 做性能追踪的命令？用这个序列化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 在SkyWalking UI性能剖析功能中，新建任务，会下发给Agent性能追踪任务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">ProfileTaskCommand</span><span class="o">.</span><span class="na">NAME</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">commandName</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ProfileTaskCommand</span><span class="o">.</span><span class="na">DESERIALIZER</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ConfigurationDiscoveryCommand</span><span class="o">.</span><span class="na">NAME</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">commandName</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 改配置的命令？ 用这个序列化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 当前版本SkyWalking Agent支持运行时动态调整配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="n">ConfigurationDiscoveryCommand</span><span class="o">.</span><span class="na">DESERIALIZER</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedCommandException</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="configurationdiscoverycommand" class="headerLink">
    <a href="#configurationdiscoverycommand" class="header-mark"></a><code>ConfigurationDiscoveryCommand</code></h5><p>配置发现命令反序列化器,主要看一下<code>deserialize()</code>。最后就是解析<code>command</code>返回一个 <code>ConfigurationDiscoveryCommand</code>对象。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ConfigurationDiscoveryCommand</span> <span class="nf">deserialize</span><span class="o">(</span><span class="n">Command</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">serialNumber</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">uuid</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">KeyStringValuePair</span><span class="o">&gt;</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">KeyStringValuePair</span> <span class="n">pair</span> <span class="o">:</span> <span class="n">command</span><span class="o">.</span><span class="na">getArgsList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 序列号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">SERIAL_NUMBER_CONST_NAME</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">getKey</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">serialNumber</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">UUID_CONST_NAME</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">getKey</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// UUID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                <span class="n">uuid</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">config</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pair</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">ConfigurationDiscoveryCommand</span><span class="o">(</span><span class="n">serialNumber</span><span class="o">,</span> <span class="n">uuid</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="commandexecutorservice" class="headerLink">
    <a href="#commandexecutorservice" class="header-mark"></a><code>CommandExecutorService</code></h5><p>这个比较重要。<code>CommandService.run()</code>中，将<code>BaseCommand</code>取出后，先用<code>命令序列号缓存</code>验证一下。然后就交给<code>CommandExecutorService.execute()</code>了。</p>
<p>当然，这个类也是主要做分发作用😅，和反序列类似：</p>
<ul>
<li>如果是性能追踪的命令，交给<code>ProfileTaskCommandExecutor.execute()</code></li>
<li>如果是配置发现的命令，交给<code>ConfigurationDiscoveryCommandExecutor.execute()</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Command executor service, acts like a routing executor that controls all commands&#39; execution, is responsible for
</span></span></span><span class="line"><span class="cl"><span class="cm"> * managing all the mappings between commands and their executors, one can simply invoke {@link #execute(BaseCommand)}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * and it will routes the command to corresponding executor.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Registering command executor for new command in {@link #commandExecutorMap} is required to support new command.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 根据命令，再分发到具体的执行器
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 看 ${@link ConfigurationDiscoveryCommandExecutor}
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultImplementor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommandExecutorService</span> <span class="kd">implements</span> <span class="n">BootService</span><span class="o">,</span> <span class="n">CommandExecutor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 命令执行器 map
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">CommandExecutor</span><span class="o">&gt;</span> <span class="n">commandExecutorMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化。 也是分为 性能追踪、配置变化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">commandExecutorMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">CommandExecutor</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Profile task executor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">commandExecutorMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ProfileTaskCommand</span><span class="o">.</span><span class="na">NAME</span><span class="o">,</span> <span class="k">new</span> <span class="n">ProfileTaskCommandExecutor</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//Get ConfigurationDiscoveryCommand executor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">commandExecutorMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ConfigurationDiscoveryCommand</span><span class="o">.</span><span class="na">NAME</span><span class="o">,</span> <span class="k">new</span> <span class="n">ConfigurationDiscoveryCommandExecutor</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="kd">final</span> <span class="n">BaseCommand</span> <span class="n">command</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CommandExecutionException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 拿到执行器。 执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">executorForCommand</span><span class="o">(</span><span class="n">command</span><span class="o">).</span><span class="na">execute</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CommandExecutor</span> <span class="nf">executorForCommand</span><span class="o">(</span><span class="kd">final</span> <span class="n">BaseCommand</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">CommandExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">commandExecutorMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getCommand</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">executor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">NoopCommandExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="configurationdiscoverycommandexecutor" class="headerLink">
    <a href="#configurationdiscoverycommandexecutor" class="header-mark"></a><code>ConfigurationDiscoveryCommandExecutor</code></h5><p>巧了，依然是转发。下面咱们看<code>ConfigurationDiscoveryService.handleConfigurationDiscoveryCommand()</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 配置命令解析
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigurationDiscoveryCommandExecutor</span> <span class="kd">implements</span> <span class="n">CommandExecutor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ConfigurationDiscoveryCommandExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">BaseCommand</span> <span class="n">command</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CommandExecutionException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ConfigurationDiscoveryCommand</span> <span class="n">agentDynamicConfigurationCommand</span> <span class="o">=</span> <span class="o">(</span><span class="n">ConfigurationDiscoveryCommand</span><span class="o">)</span> <span class="n">command</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 再拿一个 ConfigurationDiscoveryService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">ConfigurationDiscoveryService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 调用的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                   <span class="o">.</span><span class="na">handleConfigurationDiscoveryCommand</span><span class="o">(</span><span class="n">agentDynamicConfigurationCommand</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;Handle ConfigurationDiscoveryCommand error, command:{}&#34;</span><span class="o">,</span> <span class="n">command</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="configurationdiscoveryservice" class="headerLink">
    <a href="#configurationdiscoveryservice" class="header-mark"></a><code>ConfigurationDiscoveryService</code></h5><p>注意，这是一个<code>service</code>。它身上有三条逻辑线：</p>
<ul>
<li>
<p><code>网络监听器</code> ： 它实现了<code>GRPCChannelListener</code>,监听网络变化。在网络联通的情况下，组装<code>configurationDiscoveryServiceBlockingStub</code>,用于向服务端发请求，拉取配置信息。</p>
</li>
<li>
<p><code>处理服务端返回的command</code>: 从<code>CommandService.receiveCommand()</code>开始，经过反序列化，各个类的转发，最终这个类的<code>handleConfigurationDiscoveryCommand()</code>来做最后的处理。<code>仅限配置发现的command</code></p>
</li>
<li>
<p><code>拉取配置</code>：在生命周期方法<code>boot</code>中，创建了一个单线程线程池，每20秒调用<code>getAgentDynamicConfig()</code>向服务端发送请求，拉取配置。</p>
<p>特别说一下，发送请求后，将返回<code>command</code>交给了<code>CommandService.receiveCommand()</code>。这就闭环了啊，最终一定是传到<code>handleConfigurationDiscoveryCommand()</code>来处理。</p>
</li>
</ul>
<h6 id="getagentdynamicconfig" class="headerLink">
    <a href="#getagentdynamicconfig" class="header-mark"></a><code>getAgentDynamicConfig</code></h6><p>首先是组装请求数据，然后进行<code>watcherSize</code>验证，在通过在网络监听器中实例化的<code>configurationDiscoveryServiceBlockingStub</code>发送数据，拿到返回值后，交给<code>CommandService.receiveCommand()</code>处理。其中特别说一下 <code>watcher</code>这个东西。</p>
<p><code>watcherSize验证</code></p>
<p>首先说一下<code>watch</code>,在<code>ConfigurationDiscoveryService.Register</code>中封装了一个map。value是<code>WatcherHolder</code>。而<code>WatcherHolder</code>又封装了 <code>AgentConfigChangeWatcher</code>。咱们直接看<code>AgentConfigChangeWatcher</code>。<code>AgentConfigChangeWatcher</code> 用于监控配置信息的变动。</p>
<p>这里的验证就是说，如果需要被监听的配置key发生了变化，那我就要清空uuid,重新加载配置，<code>uuid和command的uuid一样，就表示配置没变，不需要刷新配置</code>，清空的意思就是不管变不变，在<code>handleConfigurationDiscoveryCommand()</code>处理返回信息时，一定是进入到变更的逻辑中的。</p>
<h5 id="handleconfigurationdiscoverycommand" class="headerLink">
    <a href="#handleconfigurationdiscoverycommand" class="header-mark"></a><code>handleConfigurationDiscoveryCommand</code></h5><p>处理的逻辑就比较清晰了。</p>
<ol>
<li>验证一下uuid,没变就不处理了。</li>
<li>读取配置；其实是对返回值进行处理、过滤。将没有<code>watcher</code>的配置key过滤掉。</li>
<li>然后遍历，发通知； 遍历被watcher的key,根据key拿到<code>wahter</code>对象，调用<code>watcher</code>对象的<code>notify()</code>发送通知。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 配置的解析service
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultImplementor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigurationDiscoveryService</span> <span class="kd">implements</span> <span class="n">BootService</span><span class="o">,</span> <span class="n">GRPCChannelListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * UUID of the last return value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">uuid</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Register</span> <span class="n">register</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Register</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 上一次计算的 watcher 数量
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">lastRegisterWatcherSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">ScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">getDynamicConfigurationFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">GRPCChannelStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">DISCONNECT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">ConfigurationDiscoveryServiceGrpc</span><span class="o">.</span><span class="na">ConfigurationDiscoveryServiceBlockingStub</span> <span class="n">configurationDiscoveryServiceBlockingStub</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ConfigurationDiscoveryService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 网络监听 处理
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param status
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">statusChanged</span><span class="o">(</span><span class="kd">final</span> <span class="n">GRPCChannelStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">CONNECTED</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">status</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">configurationDiscoveryServiceBlockingStub</span> <span class="o">=</span> <span class="n">ConfigurationDiscoveryServiceGrpc</span><span class="o">.</span><span class="na">newBlockingStub</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">configurationDiscoveryServiceBlockingStub</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 注册监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">addChannelListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 定时任务，看run方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">getDynamicConfigurationFuture</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">DefaultNamedThreadFactory</span><span class="o">(</span><span class="s">&#34;ConfigurationDiscoveryService&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">).</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">RunnableWithExceptionProtection</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">::</span><span class="n">getAgentDynamicConfig</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Sync config from OAP error.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">GET_AGENT_DYNAMIC_CONFIG_INTERVAL</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">GET_AGENT_DYNAMIC_CONFIG_INTERVAL</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">getDynamicConfigurationFuture</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">getDynamicConfigurationFuture</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 注册 配置变更  监听
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Register dynamic configuration watcher.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param watcher dynamic configuration watcher
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerAgentConfigChangeWatcher</span><span class="o">(</span><span class="n">AgentConfigChangeWatcher</span> <span class="n">watcher</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">WatcherHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WatcherHolder</span><span class="o">(</span><span class="n">watcher</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">register</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">getKey</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Duplicate register, watcher=&#34;</span> <span class="o">+</span> <span class="n">watcher</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">register</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">holder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 处理 服务端 返回的 配置信息 command
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Process ConfigurationDiscoveryCommand and notify each configuration watcher.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param configurationDiscoveryCommand Describe dynamic configuration information
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleConfigurationDiscoveryCommand</span><span class="o">(</span><span class="n">ConfigurationDiscoveryCommand</span> <span class="n">configurationDiscoveryCommand</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// uuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 配置没有变动的话。uuid 也是不会变的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">final</span> <span class="n">String</span> <span class="n">responseUuid</span> <span class="o">=</span> <span class="n">configurationDiscoveryCommand</span><span class="o">.</span><span class="na">getUuid</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">responseUuid</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">uuid</span><span class="o">,</span> <span class="n">responseUuid</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 配置变了，去读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">KeyStringValuePair</span><span class="o">&gt;</span> <span class="n">config</span> <span class="o">=</span> <span class="n">readConfig</span><span class="o">(</span><span class="n">configurationDiscoveryCommand</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 配置变更
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">config</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">property</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">propertyKey</span> <span class="o">=</span> <span class="n">property</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">WatcherHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="n">register</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">propertyKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">AgentConfigChangeWatcher</span> <span class="n">watcher</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getWatcher</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">newPropertyValue</span> <span class="o">=</span> <span class="n">property</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">StringUtil</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">newPropertyValue</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">watcher</span><span class="o">.</span><span class="na">value</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// 发通知，有变更。 把新值发出去
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// Notify watcher, the new value is null with delete event type.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">watcher</span><span class="o">.</span><span class="na">notify</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="k">new</span> <span class="n">AgentConfigChangeWatcher</span><span class="o">.</span><span class="na">ConfigChangeEvent</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                <span class="kc">null</span><span class="o">,</span> <span class="n">AgentConfigChangeWatcher</span><span class="o">.</span><span class="na">EventType</span><span class="o">.</span><span class="na">DELETE</span>
</span></span><span class="line"><span class="cl">                            <span class="o">));</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Don&#39;t need to notify, stay in null.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(!</span><span class="n">newPropertyValue</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">watcher</span><span class="o">.</span><span class="na">value</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">watcher</span><span class="o">.</span><span class="na">notify</span><span class="o">(</span><span class="k">new</span> <span class="n">AgentConfigChangeWatcher</span><span class="o">.</span><span class="na">ConfigChangeEvent</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">newPropertyValue</span><span class="o">,</span> <span class="n">AgentConfigChangeWatcher</span><span class="o">.</span><span class="na">EventType</span><span class="o">.</span><span class="na">MODIFY</span>
</span></span><span class="line"><span class="cl">                        <span class="o">));</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Don&#39;t need to notify, stay in the same config value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Config {} from OAP, doesn&#39;t match any watcher, ignore.&#34;</span><span class="o">,</span> <span class="n">propertyKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">uuid</span> <span class="o">=</span> <span class="n">responseUuid</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">LOGGER</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">&#34;Current configurations after the sync, configurations:{}&#34;</span><span class="o">,</span> <span class="n">register</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 读取服务端返回的配置信息
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Read the registered dynamic configuration, compare it with the dynamic configuration information returned by the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * service, and complete the dynamic configuration that has been deleted on the OAP.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param configurationDiscoveryCommand Describe dynamic configuration information
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return Adapted dynamic configuration information
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">KeyStringValuePair</span><span class="o">&gt;</span> <span class="nf">readConfig</span><span class="o">(</span><span class="n">ConfigurationDiscoveryCommand</span> <span class="n">configurationDiscoveryCommand</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">KeyStringValuePair</span><span class="o">&gt;</span> <span class="n">commandConfigs</span> <span class="o">=</span> <span class="n">configurationDiscoveryCommand</span><span class="o">.</span><span class="na">getConfig</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                                      <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                                      <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toMap</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                                                                          <span class="n">KeyStringValuePair</span><span class="o">::</span><span class="n">getKey</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                                                                          <span class="n">Function</span><span class="o">.</span><span class="na">identity</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                                      <span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">KeyStringValuePair</span><span class="o">&gt;</span> <span class="n">configList</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">name</span> <span class="o">:</span> <span class="n">register</span><span class="o">.</span><span class="na">keys</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">KeyStringValuePair</span> <span class="n">command</span> <span class="o">=</span> <span class="n">commandConfigs</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">KeyStringValuePair</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                                             <span class="o">.</span><span class="na">setKey</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                                                             <span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">configList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">configList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * get agent dynamic config through gRPC.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 通知grpc 从 OAP 拿动态的配置信息
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">getAgentDynamicConfig</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ConfigurationDiscoveryService running, status:{}.&#34;</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">CONNECTED</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">status</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ConfigurationSyncRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">ConfigurationSyncRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">builder</span><span class="o">.</span><span class="na">setService</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">SERVICE_NAME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// 计算有多少 Watcher
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// Some plugin will register watcher later.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">register</span><span class="o">.</span><span class="na">keys</span><span class="o">().</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">//  上一次计算的 watcher 数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 这里说明， 数据监听出现变化。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">lastRegisterWatcherSize</span> <span class="o">!=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// reset uuid, avoid the same uuid causing the configuration not to be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">uuid</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">lastRegisterWatcherSize</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">uuid</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">builder</span><span class="o">.</span><span class="na">setUuid</span><span class="o">(</span><span class="n">uuid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// 向服务端发请求，拿配置信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">configurationDiscoveryServiceBlockingStub</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">final</span> <span class="n">Commands</span> <span class="n">commands</span> <span class="o">=</span> <span class="n">configurationDiscoveryServiceBlockingStub</span><span class="o">.</span><span class="na">withDeadlineAfter</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">GRPC_UPSTREAM_TIMEOUT</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span>
</span></span><span class="line"><span class="cl">                    <span class="o">).</span><span class="na">fetchConfigurations</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 再 交给 CommandService 去处理返回信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// 可以预见，最终会到 handleConfigurationDiscoveryCommand 方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// 因为 服务端的返回的是 配置信息 command 。反序列一步步到handleConfigurationDiscoveryCommand。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">CommandService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">receiveCommand</span><span class="o">(</span><span class="n">commands</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;ConfigurationDiscoveryService execute fail.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">reportError</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Local dynamic configuration center.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Register</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * WatcherHolder   对 AgentConfigChangeWatcher 封装。 方便使用
</span></span></span><span class="line"><span class="cl"><span class="cm">         * AgentConfigChangeWatcher 是 针对某项 配置 的值，进行监听
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">WatcherHolder</span><span class="o">&gt;</span> <span class="n">register</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">containsKey</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">register</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">WatcherHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">register</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">holder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">WatcherHolder</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">register</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">keys</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">register</span><span class="o">.</span><span class="na">keySet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">registerTableDescription</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">register</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">register</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">key</span><span class="o">,</span> <span class="n">holder</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">AgentConfigChangeWatcher</span> <span class="n">watcher</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getWatcher</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">registerTableDescription</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">StringBuilder</span><span class="o">().</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;key:&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;value(current):&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">watcher</span><span class="o">.</span><span class="na">value</span><span class="o">()).</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">registerTableDescription</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">,</span> <span class="s">&#34;[&#34;</span><span class="o">,</span> <span class="s">&#34;]&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 对 AgentConfigChangeWatcher 封装。 方便使用
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WatcherHolder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">AgentConfigChangeWatcher</span> <span class="n">watcher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">key</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="nf">WatcherHolder</span><span class="o">(</span><span class="n">AgentConfigChangeWatcher</span> <span class="n">watcher</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">watcher</span> <span class="o">=</span> <span class="n">watcher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">watcher</span><span class="o">.</span><span class="na">getPropertyKey</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 监听  agent 的 某项配置值的变化
</span></span></span><span class="line"><span class="cl"><span class="cm"> *代表 原来的值
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 举例
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 采样率 = 10% 变更好 = 50%
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * value() = 10%
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AgentConfigChangeWatcher</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Config key, should match KEY in the Table of Agent Configuration Properties.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这个key 来源于  agent 配置文件， 也就是说 只有 agent 配置文件中合法的key 才能在这里被使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">propertyKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">AgentConfigChangeWatcher</span><span class="o">(</span><span class="n">String</span> <span class="n">propertyKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">propertyKey</span> <span class="o">=</span> <span class="n">propertyKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Notify the watcher, the new value received.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param value of new.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     *              value() 变更时，发送通知
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">notify</span><span class="o">(</span><span class="n">ConfigChangeEvent</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return current value of current config.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 当前的配置值
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">String</span> <span class="nf">value</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;AgentConfigChangeWatcher{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;propertyKey=&#39;&#34;</span> <span class="o">+</span> <span class="n">propertyKey</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">            <span class="sc">&#39;}&#39;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequiredArgsConstructor</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ConfigChangeEvent</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">newValue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">EventType</span> <span class="n">eventType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">enum</span> <span class="n">EventType</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ADD</span><span class="o">,</span> <span class="n">MODIFY</span><span class="o">,</span> <span class="n">DELETE</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="samplingservice" class="headerLink">
    <a href="#samplingservice" class="header-mark"></a><code>SamplingService</code></h4><blockquote>
<p>采样服务。 控制链路是否被上报到OAP</p>
</blockquote>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211131300366.png" title="image-20221211131300366" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211131300366.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211131300366.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211131300366.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211131300366.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211131300366.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211131300366.png">
    </a></p>
<p><code>Agent</code>会对应用的链路进行采集。但是全部上报到OAP,数据过大。<code>SamplingService</code>就是用来控制具体要不要上报的服务。</p>
<p>首先<code>SamplingService</code> 会通过<code>SamplingRateWatcher</code>对配置项<code>Config.sample_n_per_3_secs</code>进行watcher。如果采样率发生变化，会通知到<code>SamplingService.handleSamplingRateChanged()</code>。</p>
<p>然后<code>SamplingService</code>在启动阶段，先初始化了<code>SamplingRateWatcher</code>实例，然后主动调用了<code>handleSamplingRateChanged()</code>。</p>
<ul>
<li><code>Config.sample_n_per_3_secs</code>: 3秒内最多采集多少条链路。-1或0，表示 采样机制关闭。 全部上报</li>
<li><code>SamplingRateWatcher</code>: 继承了<code>AgentConfigChangeWatcher</code> 了，主要监听采样率的变化。上面已经说了。</li>
<li><code>handleSamplingRateChanged()</code>: 检查配置中的采样率：
<ul>
<li>大于0，并且服务未运行<code>on!=true</code>： 首先设置标志位<code>on=true</code>。重置<code>3秒内已经采集到的次数</code>。然后开启定时任务，每3秒重置一次<code>3秒内已经采集到的次数</code>。 注: 定时任务前的处理，可以理解为初始化操作<code>只会在启动时执行一次</code>。定时任务中的逻辑，才是日常任务。</li>
<li>小于等于0： 把服务关了。因为按照<code>Config.sample_n_per_3_secs</code>的说法，小于等于0，就全部上报。所以这里就不管了。当然，如果后面OAP发送开启上报的配置到Agent。<code>SamplingRateWatcher</code>就会调用<code>handleSamplingRateChanged()</code>。再走上面的逻辑。</li>
</ul>
</li>
<li><code>trySampling()</code>:用来检查链路是否上报。规则一样 <code>采样率配置大于0，就按照采样率来算是否上报。如果小于等于0，就上报。</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Licensed to the Apache Software Foundation (ASF) under one or more
</span></span></span><span class="line"><span class="cl"><span class="cm"> * contributor license agreements.  See the NOTICE file distributed with
</span></span></span><span class="line"><span class="cl"><span class="cm"> * this work for additional information regarding copyright ownership.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The ASF licenses this file to You under the Apache License, Version 2.0
</span></span></span><span class="line"><span class="cl"><span class="cm"> * (the &#34;License&#34;); you may not use this file except in compliance with
</span></span></span><span class="line"><span class="cl"><span class="cm"> * the License.  You may obtain a copy of the License at
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Unless required by applicable law or agreed to in writing, software
</span></span></span><span class="line"><span class="cl"><span class="cm"> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * See the License for the specific language governing permissions and
</span></span></span><span class="line"><span class="cl"><span class="cm"> * limitations under the License.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">org.apache.skywalking.apm.agent.core.sampling</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.ScheduledExecutorService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.ScheduledFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.agent.core.boot.BootService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.agent.core.boot.DefaultImplementor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.agent.core.boot.DefaultNamedThreadFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.agent.core.boot.ServiceManager</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.agent.core.conf.Config</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.agent.core.conf.dynamic.ConfigurationDiscoveryService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.agent.core.conf.dynamic.watcher.SamplingRateWatcher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.agent.core.context.trace.TraceSegment</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.agent.core.logging.api.ILog</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.agent.core.logging.api.LogManager</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.util.RunnableWithExceptionProtection</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;SamplingService&lt;/code&gt; take charge of how to sample the {@link TraceSegment}. Every {@link TraceSegment}s
</span></span></span><span class="line"><span class="cl"><span class="cm"> * have been traced, but, considering CPU cost of serialization/deserialization, and network bandwidth, the agent do NOT
</span></span></span><span class="line"><span class="cl"><span class="cm"> * send all of them to collector, if SAMPLING is on.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * By default, SAMPLING is on, and  {@link Config.Agent#SAMPLE_N_PER_3_SECS }
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 采样服务
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultImplementor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SamplingService</span> <span class="kd">implements</span> <span class="n">BootService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">SamplingService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 是否运行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">on</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 累加3秒内已经采样的次数
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">AtomicInteger</span> <span class="n">samplingFactorHolder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 每三秒重置一次 samplingFactorHolder
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">ScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">scheduledFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *针对采样率这个配置，进行watcher监听
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SamplingRateWatcher</span> <span class="n">samplingRateWatcher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化 watcher
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">samplingRateWatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SamplingRateWatcher</span><span class="o">(</span><span class="s">&#34;agent.sample_n_per_3_secs&#34;</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 注册监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 当服务端下发 采样率 配置变更的时候。会通过到 samplingRateWatcher.notify()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// samplingRateWatcher.notify()  会将数据传递到 this.handleSamplingRateChanged()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">ConfigurationDiscoveryService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                               <span class="o">.</span><span class="na">registerAgentConfigChangeWatcher</span><span class="o">(</span><span class="n">samplingRateWatcher</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 处理采样率更改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 为什么在boot 中调用这个方法？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 因为把初始化逻辑也放在 handleSamplingRateChanged 中了。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">handleSamplingRateChanged</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">scheduledFuture</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">scheduledFuture</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 8.9.0 之前，这个方法的注释都是过时的
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 准确的描述是 如果采样机制没有开启， 即 on = false， 那么就表示每一条采集到的链路都会上报给 OAP
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param operationName The first operation name of the new tracing context.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return true, if sampling mechanism is on, and getDefault the sampling factor successfully.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">trySampling</span><span class="o">(</span><span class="n">String</span> <span class="n">operationName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">on</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 开启采样，根据配置的采样率 来决定 链路数据是否上报
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">samplingFactorHolder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">factor</span> <span class="o">&lt;</span> <span class="n">samplingRateWatcher</span><span class="o">.</span><span class="na">getSamplingRate</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">samplingFactorHolder</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">factor</span><span class="o">,</span> <span class="n">factor</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 强制采样
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Increase the sampling factor by force, to avoid sampling too many traces. If many distributed traces require
</span></span></span><span class="line"><span class="cl"><span class="cm">     * sampled, the trace beginning at local, has less chance to be sampled.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forceSampled</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">on</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">samplingFactorHolder</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">resetSamplingFactor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">samplingFactorHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 处理 采样率变更
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Handle the samplingRate changed.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleSamplingRateChanged</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取当前采样率，如果大于0，根据配置的采样率进行采样
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">samplingRateWatcher</span><span class="o">.</span><span class="na">getSamplingRate</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果没工作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">on</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">on</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 重置 `累加3秒内已经采样的次数` 为 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">this</span><span class="o">.</span><span class="na">resetSamplingFactor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// 每3秒重置一次 `累加3秒内已经采样的次数`   resetSamplingFactor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                <span class="n">ScheduledExecutorService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="k">new</span> <span class="n">DefaultNamedThreadFactory</span><span class="o">(</span><span class="s">&#34;SamplingService&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="n">scheduledFuture</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="k">new</span> <span class="n">RunnableWithExceptionProtection</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">::</span><span class="n">resetSamplingFactor</span><span class="o">,</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;unexpected exception.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">)),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;Agent sampling mechanism started. Sample {} traces in 3 seconds.&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">samplingRateWatcher</span><span class="o">.</span><span class="na">getSamplingRate</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 不开启 采样。 就给他关了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">on</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">scheduledFuture</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">scheduledFuture</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">on</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 针对采样率这个配置，进行watcher
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SamplingRateWatcher</span> <span class="kd">extends</span> <span class="n">AgentConfigChangeWatcher</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">SamplingRateWatcher</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 每三秒能够采集的最大链路数
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">samplingRate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 持有引用
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 两个类互相持有引用
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">SamplingService</span> <span class="n">samplingService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">SamplingRateWatcher</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">propertyKey</span><span class="o">,</span> <span class="n">SamplingService</span> <span class="n">samplingService</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">propertyKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">samplingRate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">getDefaultValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">samplingService</span> <span class="o">=</span> <span class="n">samplingService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 通知
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param value of new.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    value() 变更时，发送通知
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">notify</span><span class="o">(</span><span class="kd">final</span> <span class="n">ConfigChangeEvent</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 删除了采样率，设置为默认值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">EventType</span><span class="o">.</span><span class="na">DELETE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">getEventType</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">activeSetting</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">getDefaultValue</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">activeSetting</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">getNewValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">activeSetting</span><span class="o">(</span><span class="n">String</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isDebugEnable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Updating using new static config: {}&#34;</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">samplingRate</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">config</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">             * We need to notify samplingService the samplingRate changed.
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span>
</span></span><span class="line"><span class="cl">            <span class="n">samplingService</span><span class="o">.</span><span class="na">handleSamplingRateChanged</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="s">&#34;Cannot load {} from: {}&#34;</span><span class="o">,</span> <span class="n">getPropertyKey</span><span class="o">(),</span> <span class="n">config</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">value</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">samplingRate</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">getDefaultValue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">SAMPLE_N_PER_3_SECS</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSamplingRate</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">samplingRate</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="jvmservice" class="headerLink">
    <a href="#jvmservice" class="header-mark"></a><code>JVMService</code></h4><img src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211143647084.png" alt="image-20221211143647084" style="zoom:150%;" />
<ol>
<li>两个定时任务
<ol>
<li>采集：1秒一次，通过各种<code>produce</code>采集jvm相关数据指标。<code>CPU,内存,内存池,GC,线程,class</code></li>
<li>发送：1秒一次，调用<code>JVMMetricsSender</code>。</li>
</ol>
</li>
<li>各种采集器：定义了一系列<code>Produce</code>,去做实际的数据采集工作。<code>感兴趣可以仔细看看</code></li>
<li><code>JVMMetricsSender</code>: 用来发送指标数据到OAP
<ol>
<li>网络状态监听： 实现监听器，在网络状态畅通的情况下，发送数据。</li>
<li><code>offer()</code>: 接收数据的入口。接到数据后，并没有立即发送，而是放到<code>指标信息队列</code>中。是在上面的定时任务中，执行<code>run()</code>，进行发送的。</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;JVMService&lt;/code&gt; represents a timer, which collectors JVM cpu, memory, memorypool, gc, thread and class info,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * and send the collected info to Collector through the channel provided by {@link GRPCChannelManager}
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * JVMService代表一个定时器，收集JVM cpu, memory, memorypool, gc, thread and class信息，
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 并通过GRPCChannelManager提供的通道发送给Collector采集JVM相关信息
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 采集JVM相关信息
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultImplementor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JVMService</span> <span class="kd">implements</span> <span class="n">BootService</span><span class="o">,</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">JVMService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 收集JVM信息的定时任务
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">ScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">collectMetricFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 发送JVM信息的定时任务
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">ScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">sendMetricFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * JVM信息的发送工具
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">JVMMetricsSender</span> <span class="n">sender</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sender</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">JVMMetricsSender</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 一秒执行一次 this.run()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">collectMetricFuture</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">DefaultNamedThreadFactory</span><span class="o">(</span><span class="s">&#34;JVMService-produce&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                       <span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="k">new</span> <span class="n">RunnableWithExceptionProtection</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                           <span class="k">this</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="k">new</span> <span class="n">RunnableWithExceptionProtection</span><span class="o">.</span><span class="na">CallbackWhenException</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                               <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                                               <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;JVMService produces metrics failure.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                                               <span class="o">}</span>
</span></span><span class="line"><span class="cl">                                           <span class="o">}</span>
</span></span><span class="line"><span class="cl">                                       <span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1秒执行一次 sender.run()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sendMetricFuture</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">DefaultNamedThreadFactory</span><span class="o">(</span><span class="s">&#34;JVMService-consume&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="k">new</span> <span class="n">RunnableWithExceptionProtection</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">sender</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">new</span> <span class="n">RunnableWithExceptionProtection</span><span class="o">.</span><span class="na">CallbackWhenException</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                                            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;JVMService consumes and upload failure.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">}</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">collectMetricFuture</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sendMetricFuture</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 当前时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">long</span> <span class="n">currentTimeMillis</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 构造数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 重点是各种 Provider
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">JVMMetric</span><span class="o">.</span><span class="na">Builder</span> <span class="n">jvmBuilder</span> <span class="o">=</span> <span class="n">JVMMetric</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">jvmBuilder</span><span class="o">.</span><span class="na">setTime</span><span class="o">(</span><span class="n">currentTimeMillis</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// CPU
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">jvmBuilder</span><span class="o">.</span><span class="na">setCpu</span><span class="o">(</span><span class="n">CPUProvider</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getCpuMetric</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">jvmBuilder</span><span class="o">.</span><span class="na">addAllMemory</span><span class="o">(</span><span class="n">MemoryProvider</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getMemoryMetricList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 内存池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">jvmBuilder</span><span class="o">.</span><span class="na">addAllMemoryPool</span><span class="o">(</span><span class="n">MemoryPoolProvider</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getMemoryPoolMetricsList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">jvmBuilder</span><span class="o">.</span><span class="na">addAllGc</span><span class="o">(</span><span class="n">GCProvider</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getGCList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">jvmBuilder</span><span class="o">.</span><span class="na">setThread</span><span class="o">(</span><span class="n">ThreadProvider</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getThreadMetrics</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// class
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">jvmBuilder</span><span class="o">.</span><span class="na">setClazz</span><span class="o">(</span><span class="n">ClassProvider</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getClassMetrics</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 交给sender
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">sender</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">jvmBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&#34;Collect JVM info fail.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * JVM信息的发送工具
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultImplementor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JVMMetricsSender</span> <span class="kd">implements</span> <span class="n">BootService</span><span class="o">,</span> <span class="n">Runnable</span><span class="o">,</span> <span class="n">GRPCChannelListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">JVMMetricsSender</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 网络状态
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">GRPCChannelStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">DISCONNECT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 请求构造器
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">JVMMetricReportServiceGrpc</span><span class="o">.</span><span class="na">JVMMetricReportServiceBlockingStub</span> <span class="n">stub</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 指标信息队列
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">JVMMetric</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 队列的数量限制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="n">Config</span><span class="o">.</span><span class="na">Jvm</span><span class="o">.</span><span class="na">BUFFER_SIZE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">addChannelListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 插入数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param metric
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">offer</span><span class="o">(</span><span class="n">JVMMetric</span> <span class="n">metric</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// drop last message and re-deliver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">metric</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">metric</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 网络连接是通的？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">CONNECTED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">JVMMetricCollection</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">JVMMetricCollection</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">JVMMetric</span><span class="o">&gt;</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">                <span class="n">queue</span><span class="o">.</span><span class="na">drainTo</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">builder</span><span class="o">.</span><span class="na">addAllMetrics</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">builder</span><span class="o">.</span><span class="na">setService</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">SERVICE_NAME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">builder</span><span class="o">.</span><span class="na">setServiceInstance</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">INSTANCE_NAME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 发送
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Commands</span> <span class="n">commands</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="na">withDeadlineAfter</span><span class="o">(</span><span class="n">GRPC_UPSTREAM_TIMEOUT</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 交给 CommandService 处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">CommandService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">receiveCommand</span><span class="o">(</span><span class="n">commands</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;send JVM metrics to Collector fail.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">reportError</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">statusChanged</span><span class="o">(</span><span class="n">GRPCChannelStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">CONNECTED</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">status</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">stub</span> <span class="o">=</span> <span class="n">JVMMetricReportServiceGrpc</span><span class="o">.</span><span class="na">newBlockingStub</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="kafkaxxxservice" class="headerLink">
    <a href="#kafkaxxxservice" class="header-mark"></a><code>KafkaXxxService</code></h4><blockquote>
<p>为了减轻Agent直连OAP的压力。skywlking实现了一条基于kafka的通信模式<code>当然GRPC直接通信还是有的，只是大部分数据走kafka</code>。</p>
<p>这涉及到了很多类。但是逻辑和上面的基本类似。</p>
<p><code>GRPCChannelManager  ==对应=&gt; 还KafkaProducerManager</code></p>
<p>感兴趣可以去仔细看看</p>
</blockquote>
<h4 id="statuscheckservice" class="headerLink">
    <a href="#statuscheckservice" class="header-mark"></a><code>StatusCheckService</code></h4><blockquote>
<p>状态检查服务，用来判断那些异常不算异常</p>
</blockquote>
<ul>
<li>
<p><code>Config.StatusCheck.IGNORED_EXCEPTIONS</code>: 有些异常是用来控制流程的,不应该当做错误的异常</p>
</li>
<li>
<p><code>Config.StatusCheck.MAX_RECURSIVE_DEPTH</code>: 最大递归程度。</p>
</li>
<li>
<p><code>StatusChecker</code>: 是个枚举，里面是具体的检查代码。<code>这里用到了策略模式</code></p>
<ul>
<li>
<p><code>OFF</code>: 全部当做错误来处理</p>
</li>
<li>
<p><code>HIERARCHY_MATCH</code>: 两个策略，<code>HierarchyMatch,AnnotationMatch</code></p>
<p>这里还用到<code>ExceptionCheckContext</code>。用来做忽略逻辑处理。</p>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;StatusCheckService&lt;/code&gt; determines whether the span should be tagged in error status if an exception
</span></span></span><span class="line"><span class="cl"><span class="cm"> * captured in the scope.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * StatusCheckService确定如果范围内捕获异常，是否应将跨度标记为错误状态。状态检查服务
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 状态检查服务
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 用来判断那些异常不算异常
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultImplementor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StatusCheckService</span> <span class="kd">implements</span> <span class="n">BootService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="n">ignoredExceptionNames</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 枚举
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">StatusChecker</span> <span class="n">statusChecker</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 一条链路如果某个环节出现了异常,默认情况会把异常信息发送给OAP,在SkyWalking UI中看到链路中那个地方出现了异常,方便排查问题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Config.StatusCheck.IGNORED_EXCEPTIONS. 不应该当做错误的异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ignoredExceptionNames 需要忽略的异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ignoredExceptionNames</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">StatusCheck</span><span class="o">.</span><span class="na">IGNORED_EXCEPTIONS</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">StringUtil</span><span class="o">::</span><span class="n">isNotEmpty</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">String</span><span class="o">[]::</span><span class="k">new</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查异常时的最大递归程度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// AException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  BException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//   CException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 如果IGNORED_EXCEPTIONS配置的是AException,此时抛出的是CException需要递归找一下是否属于AException的子类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">statusChecker</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="na">StatusCheck</span><span class="o">.</span><span class="na">MAX_RECURSIVE_DEPTH</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">HIERARCHY_MATCH</span> <span class="o">:</span> <span class="n">OFF</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 去检查
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param e
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">statusChecker</span><span class="o">.</span><span class="na">checkStatus</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@AllArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">StatusChecker</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * All exceptions would make the span tagged as the error status.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 任何异常都当做错误
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">OFF</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="k">new</span> <span class="n">OffExceptionCheckStrategy</span><span class="o">()),</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span><span class="n">isError</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Hierarchy check the status of the traced exception.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 层次结构检查跟踪异常的状态
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @see HierarchyMatchExceptionCheckStrategy
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @see AnnotationMatchExceptionCheckStrategy
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">HIERARCHY_MATCH</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 继承策略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">new</span> <span class="n">HierarchyMatchExceptionCheckStrategy</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 注解匹配策略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">new</span> <span class="n">AnnotationMatchExceptionCheckStrategy</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="o">(</span><span class="n">isError</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 是异常？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">isError</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ExceptionCheckContext</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">registerErrorStatusException</span><span class="o">(</span><span class="n">throwable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ExceptionCheckContext</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">registerIgnoredException</span><span class="o">(</span><span class="n">throwable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 放到了context中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 策略
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ExceptionCheckStrategy</span><span class="o">&gt;</span> <span class="n">strategies</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 回调
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ExceptionCheckCallback</span> <span class="n">callback</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkStatus</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">maxDepth</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="na">StatusCheck</span><span class="o">.</span><span class="na">MAX_RECURSIVE_DEPTH</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">isError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">isError</span> <span class="o">&amp;&amp;</span> <span class="n">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">maxDepth</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">isError</span> <span class="o">=</span> <span class="n">check</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">isError</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">check</span><span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 根据策略。调用context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">boolean</span> <span class="n">isError</span> <span class="o">=</span> <span class="n">ExceptionCheckContext</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">isChecked</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">?</span> <span class="n">ExceptionCheckContext</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">isError</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">:</span> <span class="n">strategies</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">allMatch</span><span class="o">(</span><span class="n">item</span> <span class="o">-&gt;</span> <span class="n">item</span><span class="o">.</span><span class="na">isError</span><span class="o">(</span><span class="n">e</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">callback</span><span class="o">.</span><span class="na">onChecked</span><span class="o">(</span><span class="n">isError</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">isError</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The callback function would be triggered after an exception is checked by StatusChecker.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@FunctionalInterface</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">interface</span> <span class="nc">ExceptionCheckCallback</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">onChecked</span><span class="o">(</span><span class="n">Boolean</span> <span class="n">isError</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ExceptionCheckContext contains the exceptions that have been checked by the exceptionCheckStrategies.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">ExceptionCheckContext</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Throwable</span><span class="o">&gt;&gt;</span> <span class="n">ignoredExceptions</span> <span class="o">=</span> <span class="n">ConcurrentHashMap</span><span class="o">.</span><span class="na">newKeySet</span><span class="o">(</span><span class="mi">32</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Throwable</span><span class="o">&gt;&gt;</span> <span class="n">errorStatusExceptions</span> <span class="o">=</span> <span class="n">ConcurrentHashMap</span><span class="o">.</span><span class="na">newKeySet</span><span class="o">(</span><span class="mi">128</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isChecked</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ignoredExceptions</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">throwable</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="o">||</span> <span class="n">errorStatusExceptions</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">throwable</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Throwable</span><span class="o">&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">errorStatusExceptions</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">clazz</span><span class="o">)</span> <span class="o">||</span> <span class="o">(!</span><span class="n">ignoredExceptions</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">clazz</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerIgnoredException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ignoredExceptions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">throwable</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerErrorStatusException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">errorStatusExceptions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">throwable</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="链路追踪" class="headerLink">
    <a href="#%e9%93%be%e8%b7%af%e8%bf%bd%e8%b8%aa" class="header-mark"></a>链路追踪</h3><h4 id="概念" class="headerLink">
    <a href="#%e6%a6%82%e5%bf%b5" class="header-mark"></a>概念</h4><ul>
<li>
<p><code>Trace</code>:  表示一整条链路，(跨线程、跨进程的所有 Segment 的集合)</p>
<ul>
<li>在skywalking中， Trace 不是一个具体的数据模型，而是多个 Segment 串起来表示的逻辑对象</li>
</ul>
</li>
<li>
<p><code>segment</code> : 表示一个JVM进程内的一个线程中的所有操作的集合。<code>(可以将 一个JVM进程 理解为 一个 微服务)</code></p>
</li>
<li>
<p><code>Span</code>: 表示一个具体<code>操作</code>。</p>
</li>
</ul>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211202317710.png" title="image-20221211202317710" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211202317710.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211202317710.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211202317710.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211202317710.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211202317710.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221211202317710.png">
    </a></p>
<h4 id="链路id的生成" class="headerLink">
    <a href="#%e9%93%be%e8%b7%afid%e7%9a%84%e7%94%9f%e6%88%90" class="header-mark"></a>链路ID的生成</h4><h4 id="image-20221213211722391httpsblog-1257196793cosap-beijingmyqcloudcomimage-20221213211722391png" class="headerLink">
    <a href="#image-20221213211722391httpsblog-1257196793cosap-beijingmyqcloudcomimage-20221213211722391png" class="header-mark"></a><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213211722391.png" title="image-20221213211722391" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213211722391.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213211722391.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213211722391.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213211722391.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213211722391.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213211722391.png">
    </a></h4><ul>
<li>
<p><code>DistributedTraceId</code> 顶级抽象父类。</p>
</li>
<li>
<p><code>PropagatedTraceId</code>: 跨线程时用的id生成器</p>
</li>
<li>
<p><code>NewDistributedTraceId</code>: 跨进程时用的id生成器</p>
</li>
<li>
<p><code>GlobalIdGenerator</code>:  <code>NewDistributedTraceId</code>构造函数调用的方法，以此创建id.</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequiredArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ToString</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EqualsAndHashCode</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">DistributedTraceId</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PropagatedTraceId</span> <span class="kd">extends</span> <span class="n">DistributedTraceId</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">PropagatedTraceId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewDistributedTraceId</span> <span class="kd">extends</span> <span class="n">DistributedTraceId</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NewDistributedTraceId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">GlobalIdGenerator</span><span class="o">.</span><span class="na">generate</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em><strong><code>GlobalIdGenerator</code></strong></em></p>
<p>id 生成器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * id 生成
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GlobalIdGenerator</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PROCESS_ID</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&#34;-&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这里初始化了 IDContext
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">IDContext</span><span class="o">&gt;</span> <span class="n">THREAD_ID_SEQUENCE</span> <span class="o">=</span> <span class="n">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">IDContext</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="mi">0</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">GlobalIdGenerator</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">generate</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. 应用实例id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 2. 线程id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 3. 有两部分，1）一个时间戳，以毫秒为单位 2）一个序列，在当前线程中，在 0（包括）和 9999（包括）之间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">StringUtil</span><span class="o">.</span><span class="na">join</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="sc">&#39;.&#39;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">PROCESS_ID</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()),</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">THREAD_ID_SEQUENCE</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">nextSeq</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">IDContext</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 上次生成 sequence 的时间戳
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">long</span> <span class="n">lastTimestamp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 线程的序列号
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">short</span> <span class="n">threadSeq</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Just for considering time-shift-back only.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 时钟回拨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="kt">long</span> <span class="n">lastShiftTimestamp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">lastShiftValue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="nf">IDContext</span><span class="o">(</span><span class="kt">long</span> <span class="n">lastTimestamp</span><span class="o">,</span> <span class="kt">short</span> <span class="n">threadSeq</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">lastTimestamp</span> <span class="o">=</span> <span class="n">lastTimestamp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">threadSeq</span> <span class="o">=</span> <span class="n">threadSeq</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 生成序号
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 有两部分，1）一个时间戳，以毫秒为单位 2）一个序列，在当前线程中，在 0（包括）和 9999（包括）之间
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">long</span> <span class="nf">nextSeq</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">timestamp</span><span class="o">()</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">+</span> <span class="n">nextThreadSeq</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">long</span> <span class="nf">timestamp</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">currentTimeMillis</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 发生了时钟回拨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">currentTimeMillis</span> <span class="o">&lt;</span> <span class="n">lastTimestamp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Just for considering time-shift-back by Ops or OS. @hanahmily &#39;s suggestion.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 只是为了考虑 Ops 或 OS 的时间倒退。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">lastShiftTimestamp</span> <span class="o">!=</span> <span class="n">currentTimeMillis</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 时钟回拨次数+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">lastShiftValue</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">lastShiftTimestamp</span> <span class="o">=</span> <span class="n">currentTimeMillis</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">lastShiftValue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 正常逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">lastTimestamp</span> <span class="o">=</span> <span class="n">currentTimeMillis</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">lastTimestamp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">short</span> <span class="nf">nextThreadSeq</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">threadSeq</span> <span class="o">==</span> <span class="mi">10000</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">threadSeq</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">threadSeq</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="tracesegment" class="headerLink">
    <a href="#tracesegment" class="header-mark"></a><code>TraceSegment</code></h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213656275.png" title="image-20221213213656275" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213656275.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213656275.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213656275.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213656275.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213656275.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213656275.png">
    </a></p>
<p>链路追踪的重要概念模型。前面说了，skywalking没有将Trace设计为数据模型。Trace只是概念，由多个segment串联而成的,<code>relatedGlobalTraceId</code>就是所属的trace的id,代码中可以看到，在构造函数就会生成一个id,但也可以调用<code>relatedGlobalTrace()</code>将该<code>Segment</code>关联到其他Trace上。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * segment
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Trace的组合部分。 多个segment组成一个trace
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Trace 不是一个具体的数据模型，而是多个 Segment 串起来表示的逻辑对象
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TraceSegment</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The id of this trace segment. Every segment has its unique-global-id.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 全局唯一的 segmentId
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">traceSegmentId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 指针，指向当前segment的parent segment 的指针
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TraceSegmentRef</span> <span class="n">ref</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * span
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractTracingSpan</span><span class="o">&gt;</span> <span class="n">spans</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *当前segment 所在 Trace 的 ID
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DistributedTraceId</span> <span class="n">relatedGlobalTraceId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">ignore</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isSizeLimited</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">createTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create a default/empty trace segment, with current time as start time, and generate a new segment id.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">TraceSegment</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">traceSegmentId</span> <span class="o">=</span> <span class="n">GlobalIdGenerator</span><span class="o">.</span><span class="na">generate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">spans</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 在 skywalking 中，Trace 不是一个具体的数据模型，而是多个 Segment 串起来表示的逻辑对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 这里在生成 Segment时，就创建了 traceId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="o">.</span><span class="na">relatedGlobalTraceId</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NewDistributedTraceId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">createTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Establish the link between this segment and its parents.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param refSegment {@link TraceSegmentRef}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">ref</span><span class="o">(</span><span class="n">TraceSegmentRef</span> <span class="n">refSegment</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">ref</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">ref</span> <span class="o">=</span> <span class="n">refSegment</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Establish the line between this segment and the relative global trace id.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 将当前segment 关联到 一个Trace上
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 就是把持有的traceId给换了。（relatedGlobalTraceId）
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  但是 跨进程id才行
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">relatedGlobalTrace</span><span class="o">(</span><span class="n">DistributedTraceId</span> <span class="n">distributedTraceId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">relatedGlobalTraceId</span> <span class="k">instanceof</span> <span class="n">NewDistributedTraceId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">relatedGlobalTraceId</span> <span class="o">=</span> <span class="n">distributedTraceId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 加入一个span
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">archive</span><span class="o">(</span><span class="n">AbstractTracingSpan</span> <span class="n">finishedSpan</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">spans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">finishedSpan</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Finish this {@link TraceSegment}. &lt;p&gt; return this, for chaining
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 结束方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     *关闭 segment时，要调用这个方法。
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * span 是否到达了上限，配置中的默认值 300
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TraceSegment</span> <span class="nf">finish</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">isSizeLimited</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">isSizeLimited</span> <span class="o">=</span> <span class="n">isSizeLimited</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em><strong><code>TraceSegmentRef</code></strong></em></p>
<p>是指向Parent Segment的指针。这是一个对象，里面存储了父<code>Segment</code>的基本信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TraceSegmentRef</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 类型 跨进程、跨线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">SegmentRefType</span> <span class="n">type</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// traceId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">traceId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// parent 的 traceSegmentId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">traceSegmentId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">spanId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Mall -&gt; Order 对于Order 服务来讲，parentService 就是Mail
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">parentService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// parentService  的具体一个实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">parentServiceInstance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 进入parentService 的那个请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">parentEndpoint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 记录的地址信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">addressUsedAtClient</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="span" class="headerLink">
    <a href="#span" class="header-mark"></a><code>span</code></h4><p><code>span</code>表示一个基本的操作，它的概念也是最多的。</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213944937.png" title="image-20221213213944937" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213944937.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213944937.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213944937.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213944937.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213944937.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213213944937.png">
    </a></p>
<h5 id="asyncspan" class="headerLink">
    <a href="#asyncspan" class="header-mark"></a><code>AsyncSpan</code></h5><p>最顶层的span,定义了基础的 <code>prepareForAsync() // 准备阶段</code>   和 <code>asyncFinish() // 结束阶段</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Span could use these APIs to active and extend its lift cycle across thread.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This is typical used in async plugin, especially RPC plugins.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * // 异步span
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 最顶层的span
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AsyncSpan</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The span finish at current tracing context, but the current span is still alive, until {@link #asyncFinish}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * called.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This method must be called
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 1. In original thread(tracing context). 2. Current span is active span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * During alive, tags, logs and attributes of the span could be changed, in any thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The execution times of {@link #prepareForAsync} and {@link #asyncFinish()} must match.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the current span
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * // 准备阶段
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">prepareForAsync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Notify the span, it could be finished.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The execution times of {@link #prepareForAsync} and {@link #asyncFinish()} must match.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the current span
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * // 结束阶段
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">asyncFinish</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="abstractspan" class="headerLink">
    <a href="#abstractspan" class="header-mark"></a><code>AbstractSpan</code></h5><p>继承 <code>AsyncSpan</code>,并定义了一些通用方法。</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214845385.png" title="image-20221213214845385" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214845385.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214845385.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214845385.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214845385.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214845385.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214845385.png">
    </a></p>
<p><strong>layer</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 指定当前Span 表示的操作所在的插件属于哪一种 skywalking 划分的类型
</span></span></span><span class="line"><span class="cl"><span class="cm"> * - 在skywalking中，将各种插件划分为5类，=&gt; DB(1), RPC_FRAMEWORK(2), HTTP(3), MQ(4), CACHE(5);。这个就可以理解为层
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param layer 枚举
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">AbstractSpan</span> <span class="nf">setLayer</span><span class="o">(</span><span class="n">SpanLayer</span> <span class="n">layer</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;AbstractSpan&lt;/code&gt; represents the span&#39;s skeleton, which contains all open methods.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * AbstractSpan表示跨度的骨架，定义了公用的方法
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AbstractSpan</span> <span class="kd">extends</span> <span class="n">AsyncSpan</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * - ComponentsDefine 将插件定义为一个对象
</span></span></span><span class="line"><span class="cl"><span class="cm">     * - 指定当前 Span 表示的操作发生在那个插件上
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set the component id, which defines in {@link ComponentsDefine}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the span for chaining.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">setComponent</span><span class="o">(</span><span class="n">Component</span> <span class="n">component</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 指定当前Span 表示的操作所在的插件属于哪一种 skywalking 划分的类型
</span></span></span><span class="line"><span class="cl"><span class="cm">     * - 在skywalking中，将各种插件划分为5类，=&gt; DB(1), RPC_FRAMEWORK(2), HTTP(3), MQ(4), CACHE(5);。这个就可以理解为层
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param layer 枚举
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">setLayer</span><span class="o">(</span><span class="n">SpanLayer</span> <span class="n">layer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set a key:value tag on the Span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return this Span instance, for chaining
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @deprecated use {@link #tag(AbstractTag, String)} in companion with {@link Tags#ofKey(String)} instead
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">tag</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 打标签
</span></span></span><span class="line"><span class="cl"><span class="cm">     * AbstractTag 增加了一个id
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">tag</span><span class="o">(</span><span class="n">AbstractTag</span><span class="o">&lt;?&gt;</span> <span class="n">tag</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 记录当前 挂钟时间 时间戳的异常事件。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * - 挂钟时间： 本机当前时间
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Record an exception event of the current walltime timestamp.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param t any subclass of {@link Throwable}, which occurs in this span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the Span, for chaining
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">log</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 抽象方法，在错误发生时执行
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">errorOccurred</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return true if the actual span is an entry span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">isEntry</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return true if the actual span is an exit span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">isExit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 在指定时间戳记录事件
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Record an event at a specific timestamp.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param timestamp The explicit timestamp for the log record.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param event     the events
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the Span, for chaining
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">log</span><span class="o">(</span><span class="kt">long</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">event</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Sets the string name for the logical operation this span represents.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 如果当前Span的操作是
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 一个 HTTP 请求，operationName 就是 请求的URL;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 一条 SQL 语句，operationName 就是 SQL 的类型
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 一个 Redis 操作， operationName 就是 Redis 命令
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return this Span instance, for chaining
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">setOperationName</span><span class="o">(</span><span class="n">String</span> <span class="n">operationName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Start a span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *动作开始的时候，调用这个方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return this Span instance, for chaining
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Get the id of span
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return id value.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">getSpanId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="nf">getOperationName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 跨 Segment 时，通过 ref  将Segment 关联起来
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Reference other trace segment.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param ref segment ref
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">ref</span><span class="o">(</span><span class="n">TraceSegmentRef</span> <span class="n">ref</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">start</span><span class="o">(</span><span class="kt">long</span> <span class="n">startTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  什么叫 peer， 就是对端地址
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  一个请求可能跨多个进程，操作多种中间件，那么每一个RPC, 对面的服务的地址就是 remotePeer
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  每一次中间件的操作，中间件的地址就是 remotePeer
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param remotePeer
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="nf">setPeer</span><span class="o">(</span><span class="n">String</span> <span class="n">remotePeer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return true if the span&#39;s owner(tracing context main thread) is been profiled.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">isProfiling</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 设置 span 发生到OAP后，要不要进行性能分析
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Should skip analysis in the backend.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">skipAnalysis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="abstracttracingspan" class="headerLink">
    <a href="#abstracttracingspan" class="header-mark"></a><code>AbstractTracingSpan</code></h5><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214936597.png" title="image-20221213214936597" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214936597.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214936597.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214936597.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214936597.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214936597.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213214936597.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;AbstractTracingSpan&lt;/code&gt; represents a group of {@link AbstractSpan} implementations, which belongs a real
</span></span></span><span class="line"><span class="cl"><span class="cm"> * distributed trace.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * AbstractTracingSpan代表了一组AbstractSpan的实现，属于真正的分布式trace。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractTracingSpan</span> <span class="kd">implements</span> <span class="n">AbstractSpan</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Span id starts from 0.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">spanId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Parent span id starts from 0. -1 means no parent span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 从0 开始， -1 表示没有父级
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">parentSpanId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 封装的tag
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TagValuePair</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">String</span> <span class="n">operationName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">SpanLayer</span> <span class="n">layer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The span has been tagged in async mode, required async stop to finish.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 表示当前异步操作，是否已经开始
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isInAsyncMode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The flag represents whether the span has been async stopped
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 表示当前异步操作，是否已经结束
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isAsyncStopped</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The context to which the span belongs
</span></span></span><span class="line"><span class="cl"><span class="cm">     * span所属的上下文
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 用来管理一条链路上的 segment 和  span
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">TracingContext</span> <span class="n">owner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The start time of this Span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">long</span> <span class="n">startTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The end time of this Span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">long</span> <span class="n">endTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Error has occurred in the scope of span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">errorOccurred</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">componentId</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Log is a concept from OpenTracing spec. https://github.com/opentracing/specification/blob/master/specification.md#log-structured-data
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">LogDataEntity</span><span class="o">&gt;</span> <span class="n">logs</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The refs of parent trace segments, except the primary one. For most RPC call, {@link #refs} contains only one
</span></span></span><span class="line"><span class="cl"><span class="cm">     * element, but if this segment is a start span of batch process, the segment faces multi parents, at this moment,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * we use this {@link #refs} to link them.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 用于当前 Span 指定自己的所在的 Segment 的前一个Segment, 除非这个 Span 所在的Segment 是整条链路上的第一个Segment
</span></span></span><span class="line"><span class="cl"><span class="cm">     * - 为什么是list?
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 正常情况下，list中只有一个元素。如果 segment 是批处理的话，就会有多个
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TraceSegmentRef</span><span class="o">&gt;</span> <span class="n">refs</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Tracing Mode. If true means represents all spans generated in this context should skip analysis.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 跟踪模式。如果为真，则表示在此上下文中生成的所有跨度应跳过分析。
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">skipAnalysis</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">AbstractTracingSpan</span><span class="o">(</span><span class="kt">int</span> <span class="n">spanId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">String</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">TracingContext</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">operationName</span> <span class="o">=</span> <span class="n">operationName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">spanId</span> <span class="o">=</span> <span class="n">spanId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">parentSpanId</span> <span class="o">=</span> <span class="n">parentSpanId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set a key:value tag on the Span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@inheritDoc}
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return this Span instance, for chaining
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">tag</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tag</span><span class="o">(</span><span class="n">Tags</span><span class="o">.</span><span class="na">ofKey</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">tag</span><span class="o">(</span><span class="n">AbstractTag</span><span class="o">&lt;?&gt;</span> <span class="n">tag</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">tags</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tags</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">8</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">isCanOverwrite</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">TagValuePair</span> <span class="n">pair</span> <span class="o">:</span> <span class="n">tags</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">sameWith</span><span class="o">(</span><span class="n">tag</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pair</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">tags</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">TagValuePair</span><span class="o">(</span><span class="n">tag</span><span class="o">,</span> <span class="n">value</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Finish the active Span. When it is finished, it will be archived by the given {@link TraceSegment}, which owners
</span></span></span><span class="line"><span class="cl"><span class="cm">     * it.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * span 结束时，要调用一下 finish
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param owner of the Span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">finish</span><span class="o">(</span><span class="n">TraceSegment</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 归档
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">owner</span><span class="o">.</span><span class="na">archive</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Record an exception event of the current walltime timestamp.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param t any subclass of {@link Throwable}, which occurs in this span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the Span, for chaining
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">log</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">logs</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">errorOccurred</span> <span class="o">&amp;&amp;</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">StatusCheckService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">isError</span><span class="o">(</span><span class="n">t</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">errorOccurred</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">logs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">LogDataEntity</span><span class="o">.</span><span class="na">Builder</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">KeyValuePair</span><span class="o">(</span><span class="s">&#34;event&#34;</span><span class="o">,</span> <span class="s">&#34;error&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">KeyValuePair</span><span class="o">(</span><span class="s">&#34;error.kind&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">KeyValuePair</span><span class="o">(</span><span class="s">&#34;message&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">KeyValuePair</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                                                <span class="s">&#34;stack&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">ThrowableTransformer</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">convert2String</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="mi">4000</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">))</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Record a common log with multi fields, for supporting opentracing-java
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the Span, for chaining
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">log</span><span class="o">(</span><span class="kt">long</span> <span class="n">timestampMicroseconds</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">fields</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">logs</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">LogDataEntity</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogDataEntity</span><span class="o">.</span><span class="na">Builder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">fields</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">KeyValuePair</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">logs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">timestampMicroseconds</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * In the scope of this span tracing context, error occurred, in auto-instrumentation mechanism, almost means throw
</span></span></span><span class="line"><span class="cl"><span class="cm">     * an exception.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return span instance, for chaining.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">errorOccurred</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">errorOccurred</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set the operation name, just because these is not compress dictionary value for this name. Use the entire string
</span></span></span><span class="line"><span class="cl"><span class="cm">     * temporarily, the agent will compress this name in async mode.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return span instance, for chaining.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">setOperationName</span><span class="o">(</span><span class="n">String</span> <span class="n">operationName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">operationName</span> <span class="o">=</span> <span class="n">operationName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSpanId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">spanId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getOperationName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">operationName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">setLayer</span><span class="o">(</span><span class="n">SpanLayer</span> <span class="n">layer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">layer</span> <span class="o">=</span> <span class="n">layer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set the component of this span, with internal supported. Highly recommend to use this way.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return span instance, for chaining.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">setComponent</span><span class="o">(</span><span class="n">Component</span> <span class="n">component</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">componentId</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractSpan</span> <span class="nf">start</span><span class="o">(</span><span class="kt">long</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">startTime</span> <span class="o">=</span> <span class="n">startTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">SpanObject</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">transform</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpanObject</span><span class="o">.</span><span class="na">Builder</span> <span class="n">spanBuilder</span> <span class="o">=</span> <span class="n">SpanObject</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setSpanId</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">spanId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setParentSpanId</span><span class="o">(</span><span class="n">parentSpanId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setStartTime</span><span class="o">(</span><span class="n">startTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setEndTime</span><span class="o">(</span><span class="n">endTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setOperationName</span><span class="o">(</span><span class="n">operationName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setSkipAnalysis</span><span class="o">(</span><span class="n">skipAnalysis</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">isEntry</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setSpanType</span><span class="o">(</span><span class="n">SpanType</span><span class="o">.</span><span class="na">Entry</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isExit</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setSpanType</span><span class="o">(</span><span class="n">SpanType</span><span class="o">.</span><span class="na">Exit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setSpanType</span><span class="o">(</span><span class="n">SpanType</span><span class="o">.</span><span class="na">Local</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">layer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setSpanLayerValue</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">layer</span><span class="o">.</span><span class="na">getCode</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">componentId</span> <span class="o">!=</span> <span class="n">DictionaryUtil</span><span class="o">.</span><span class="na">nullValue</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setComponentId</span><span class="o">(</span><span class="n">componentId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setIsError</span><span class="o">(</span><span class="n">errorOccurred</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tags</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">TagValuePair</span> <span class="n">tag</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">tags</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">spanBuilder</span><span class="o">.</span><span class="na">addTags</span><span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">transform</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">LogDataEntity</span> <span class="n">log</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">logs</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">spanBuilder</span><span class="o">.</span><span class="na">addLogs</span><span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">transform</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">refs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">TraceSegmentRef</span> <span class="n">ref</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">refs</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">spanBuilder</span><span class="o">.</span><span class="na">addRefs</span><span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="na">transform</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">spanBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">ref</span><span class="o">(</span><span class="n">TraceSegmentRef</span> <span class="n">ref</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">refs</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">refs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Provide the OOM protection if the entry span hosts too many references.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">refs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">Config</span><span class="o">.</span><span class="na">Agent</span><span class="o">.</span><span class="na">TRACE_SEGMENT_REF_LIMIT_PER_SPAN</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">refs</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">ref</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">refs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ref</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 异步开始前，要先调用这个方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractSpan</span> <span class="nf">prepareForAsync</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Prepare for async repeatedly. Span is already in async mode.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 等待异步完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ContextManager</span><span class="o">.</span><span class="na">awaitFinishAsync</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">isInAsyncMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 异步任务结束时，要调用这个方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractSpan</span> <span class="nf">asyncFinish</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Span is not in async mode, please use &#39;#prepareForAsync&#39; to active.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">isAsyncStopped</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Can not do async finish for the span repeatedly.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">owner</span><span class="o">.</span><span class="na">asyncStop</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">isAsyncStopped</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isProfiling</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">owner</span><span class="o">.</span><span class="na">profileStatus</span><span class="o">().</span><span class="na">isProfiling</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">skipAnalysis</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">skipAnalysis</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="stackbasedtracingspan" class="headerLink">
    <a href="#stackbasedtracingspan" class="header-mark"></a><code>StackBasedTracingSpan</code></h5><p>抽象类，基于栈的Span。实际上没有栈结构。而是通过<code>stackDepth// 当前栈深度</code> 来模拟。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;StackBasedTracingSpan&lt;/code&gt; represents a span with an inside stack construction.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This kind of span can start and finish multi times in a stack-like invoke line.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 基于栈的span
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">StackBasedTracingSpan</span> <span class="kd">extends</span> <span class="n">AbstractTracingSpan</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 当前栈深
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">stackDepth</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">String</span> <span class="n">peer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">StackBasedTracingSpan</span><span class="o">(</span><span class="kt">int</span> <span class="n">spanId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">String</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">TracingContext</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">spanId</span><span class="o">,</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">owner</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">stackDepth</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">peer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="nf">StackBasedTracingSpan</span><span class="o">(</span><span class="kt">int</span> <span class="n">spanId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">String</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">String</span> <span class="n">peer</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">TracingContext</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">spanId</span><span class="o">,</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">owner</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">peer</span> <span class="o">=</span> <span class="n">peer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">SpanObject</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">transform</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpanObject</span><span class="o">.</span><span class="na">Builder</span> <span class="n">spanBuilder</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">transform</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtil</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">peer</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">spanBuilder</span><span class="o">.</span><span class="na">setPeer</span><span class="o">(</span><span class="n">peer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">spanBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">finish</span><span class="o">(</span><span class="n">TraceSegment</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(--</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">finish</span><span class="o">(</span><span class="n">owner</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractSpan</span> <span class="nf">setPeer</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">remotePeer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">peer</span> <span class="o">=</span> <span class="n">remotePeer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="entryspan-和-exitspan-" class="headerLink">
    <a href="#entryspan-%e5%92%8c-exitspan-" class="header-mark"></a><code>EntrySpan 和 ExitSpan </code></h5><p>这两个才是真正干活的Span,上面的都是抽象类和接口。</p>
<p><strong>调用逻辑</strong></p>
<p>一个简单的接口请求，会经过很多框架，比如 tomcat、spring mvc ，skywalking 也针对这些框架开发了对应的插件。那么第一个运行到的插件，就会创建<code>EntrySpan</code>，而后面的插件就会复用这个<code>EntrySpan</code>，只是会覆盖一些数据。而<code>ExitSpan</code>就不是复用了，在一个<code>Segment</code>中可能存在多个。</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213220920150.png" title="image-20221213220920150" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213220920150.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213220920150.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213220920150.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213220920150.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213220920150.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20221213220920150.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;EntrySpan&lt;/code&gt; represents a service provider point, such as Tomcat server entrance.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * It is a start point of {@link TraceSegment}, even in a complex application, there maybe have multi-layer entry point,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * the &lt;code&gt;EntrySpan&lt;/code&gt; only represents the first one.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * But with the last &lt;code&gt;EntrySpan&lt;/code&gt;&#39;s tags and logs, which have more details about a service provider.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Such as: Tomcat Embed - Dubbox The &lt;code&gt;EntrySpan&lt;/code&gt; represents the Dubbox span.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EntrySpan</span> <span class="kd">extends</span> <span class="n">StackBasedTracingSpan</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 当前最大栈深
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kt">int</span> <span class="n">currentMaxDepth</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">EntrySpan</span><span class="o">(</span><span class="kt">int</span> <span class="n">spanId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">String</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">TracingContext</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">spanId</span><span class="o">,</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">owner</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">currentMaxDepth</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set the {@link #startTime}, when the first start, which means the first service provided.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * EntrySpan 只会由第一个插件创建， 但是后面的插件复用 EntrySpan 时 都要来调用一次 start() 方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 因为每一个插件都以为自己是第一个创建这个 EntrySpan 的
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">EntrySpan</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((</span><span class="n">currentMaxDepth</span> <span class="o">=</span> <span class="o">++</span><span class="n">stackDepth</span><span class="o">)</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">super</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">clearWhenRestart</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">EntrySpan</span> <span class="nf">tag</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="n">currentMaxDepth</span> <span class="o">||</span> <span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">super</span><span class="o">.</span><span class="na">tag</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">setLayer</span><span class="o">(</span><span class="n">SpanLayer</span> <span class="n">layer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="n">currentMaxDepth</span> <span class="o">||</span> <span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setLayer</span><span class="o">(</span><span class="n">layer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">setComponent</span><span class="o">(</span><span class="n">Component</span> <span class="n">component</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="n">currentMaxDepth</span> <span class="o">||</span> <span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setComponent</span><span class="o">(</span><span class="n">component</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">setOperationName</span><span class="o">(</span><span class="n">String</span> <span class="n">operationName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="n">currentMaxDepth</span> <span class="o">||</span> <span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setOperationName</span><span class="o">(</span><span class="n">operationName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">EntrySpan</span> <span class="nf">log</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEntry</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isExit</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">clearWhenRestart</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">componentId</span> <span class="o">=</span> <span class="n">DictionaryUtil</span><span class="o">.</span><span class="na">nullValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">layer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">logs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">tags</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;ExitSpan&lt;/code&gt; represents a service consumer point, such as Feign, Okhttp client for an Http service.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * It is an exit point or a leaf span(our old name) of trace tree. In a single rpc call, because of a combination of
</span></span></span><span class="line"><span class="cl"><span class="cm"> * discovery libs, there maybe contain multi-layer exit point:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The &lt;code&gt;ExitSpan&lt;/code&gt; only presents the first one.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Such as: Dubbox - Apache Httpcomponent - ...(Remote) The &lt;code&gt;ExitSpan&lt;/code&gt; represents the Dubbox span, and ignore
</span></span></span><span class="line"><span class="cl"><span class="cm"> * the httpcomponent span&#39;s info.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 退出span  代表消费侧
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 区别就是
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  EntrySpan 代表的是更靠近服务这一侧的信息
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  ExitSpan 代表的是更靠近消费这一侧的信息
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ExitSpan代表一个服务消费点，比如Feign，Okhttp客户端为一个Http服务。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 它是跟踪树的出口点或叶子跨度（我们的旧名称）。在单个 rpc 调用中，由于发现库的组合，可能包含多层出口点：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ExitSpan仅显示第一个。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 如：Dubbox - Apache Httpcomponent - ...(Remote) ExitSpan代表Dubbox span，忽略httpcomponent span的信息。退出跨度
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExitSpan</span> <span class="kd">extends</span> <span class="n">StackBasedTracingSpan</span> <span class="kd">implements</span> <span class="n">ExitTypeSpan</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">ExitSpan</span><span class="o">(</span><span class="kt">int</span> <span class="n">spanId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">String</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">String</span> <span class="n">peer</span><span class="o">,</span> <span class="n">TracingContext</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">spanId</span><span class="o">,</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">peer</span><span class="o">,</span> <span class="n">owner</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">ExitSpan</span><span class="o">(</span><span class="kt">int</span> <span class="n">spanId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">String</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">TracingContext</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">spanId</span><span class="o">,</span> <span class="n">parentSpanId</span><span class="o">,</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">owner</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set the {@link #startTime}, when the first start, which means the first service provided.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ExitSpan</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 当前栈深时 是1 的情况下，才允许
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// exitSpan 刚创建时， 栈深才会是1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(++</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">super</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ExitSpan</span> <span class="nf">tag</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">super</span><span class="o">.</span><span class="na">tag</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">tag</span><span class="o">(</span><span class="n">AbstractTag</span><span class="o">&lt;?&gt;</span> <span class="n">tag</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">tag</span><span class="o">.</span><span class="na">isCanOverwrite</span><span class="o">()</span> <span class="o">||</span> <span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">super</span><span class="o">.</span><span class="na">tag</span><span class="o">(</span><span class="n">tag</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">setLayer</span><span class="o">(</span><span class="n">SpanLayer</span> <span class="n">layer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setLayer</span><span class="o">(</span><span class="n">layer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">setComponent</span><span class="o">(</span><span class="n">Component</span> <span class="n">component</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setComponent</span><span class="o">(</span><span class="n">component</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ExitSpan</span> <span class="nf">log</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractTracingSpan</span> <span class="nf">setOperationName</span><span class="o">(</span><span class="n">String</span> <span class="n">operationName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">isInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setOperationName</span><span class="o">(</span><span class="n">operationName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPeer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">peer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ExitSpan</span> <span class="nf">inject</span><span class="o">(</span><span class="kd">final</span> <span class="n">ContextCarrier</span> <span class="n">carrier</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">owner</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">carrier</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEntry</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isExit</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="链路追踪上下文" class="headerLink">
    <a href="#%e9%93%be%e8%b7%af%e8%bf%bd%e8%b8%aa%e4%b8%8a%e4%b8%8b%e6%96%87" class="header-mark"></a>链路追踪上下文</h4><ul>
<li><code>AbstractTracerContext</code>: 接口，定义了基础方法</li>
<li><code>TracingContext</code>: 核心的链路追踪逻辑控制器，管理当前 Segment 和<code>前后</code>Segment</li>
</ul>
<h5 id="abstracttracercontext" class="headerLink">
    <a href="#abstracttracercontext" class="header-mark"></a><code>AbstractTracerContext</code></h5><h6 id="跨进程传输数据" class="headerLink">
    <a href="#%e8%b7%a8%e8%bf%9b%e7%a8%8b%e4%bc%a0%e8%be%93%e6%95%b0%e6%8d%ae" class="header-mark"></a>跨进程传输数据</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// **** 在跨进程的情况下，传递数据。 inject 打包数据。extract 解压数据 ***
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Prepare for the cross-process propagation. How to initialize the carrier, depends on the implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 注入，将一些数据放到 carrier 中
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param carrier to carry the context for crossing process.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">ContextCarrier</span> <span class="n">carrier</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Build the reference between this segment and a cross-process segment. How to build, depends on the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 提取 从 carrier 中提取一些数据
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param carrier carried the context from a cross-process segment.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">extract</span><span class="o">(</span><span class="n">ContextCarrier</span> <span class="n">carrier</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="跨线程传输数据" class="headerLink">
    <a href="#%e8%b7%a8%e7%ba%bf%e7%a8%8b%e4%bc%a0%e8%be%93%e6%95%b0%e6%8d%ae" class="header-mark"></a>跨线程传输数据</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// **** 在跨线程的情况下，传递数据。 capture 打包数据。continued 解压数据 ***
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 生成快照
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Capture a snapshot for cross-thread propagation. It&#39;s a similar concept with ActiveSpan.Continuation in
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OpenTracing-java How to build, depends on the implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return the {@link ContextSnapshot} , which includes the reference context.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">ContextSnapshot</span> <span class="nf">capture</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 延续这个快照， 继续
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Build the reference between this segment and a cross-thread segment. How to build, depends on the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param snapshot from {@link #capture()} in the parent thread.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">continued</span><span class="o">(</span><span class="n">ContextSnapshot</span> <span class="n">snapshot</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="tracingcontext" class="headerLink">
    <a href="#tracingcontext" class="header-mark"></a><code>TracingContext</code></h5><blockquote>
<ul>
<li>一个 TracingContext 对应一个 Segment (管理)</li>
<li>管理当前 Segment 和自己前后的 Segment 的引用 TraceSegmentRef</li>
<li>当前Segment 内的所有 span</li>
</ul>
</blockquote>
<h6 id="activespanstack" class="headerLink">
    <a href="#activespanstack" class="header-mark"></a>activeSpanStack</h6><p><code>activeSpanStack</code> 是一个重要属性，作者使用 <code>LinkedList</code> 模仿栈，用于储存 <code>span</code>。每一个创建的 Span 都会放入 <code>activeSpanStack</code>（先进后出）。以此理解，栈顶的 Span 就是 <code>currentSpan</code>（<code>activeSpan</code>）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> activeSpanStack栈顶的span就是activeSpan
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return the active span of current context, the top element of {@link #activeSpanStack}
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">AbstractSpan</span> <span class="nf">activeSpan</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="n">span</span> <span class="o">=</span> <span class="n">peek</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">span</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;No active span.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">span</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return the top element of &#39;ActiveSpanStack&#39; only.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">AbstractSpan</span> <span class="nf">peek</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">activeSpanStack</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">activeSpanStack</span><span class="o">.</span><span class="na">getLast</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="createentryspan" class="headerLink">
    <a href="#createentryspan" class="header-mark"></a><code>createEntrySpan()</code></h6><ol>
<li>限制检查: 如果需要限制，就创建 <code>NoopSpan</code></li>
<li>设置父级: 从<code>activeSpanStack</code>中取出栈顶的<code>Span</code>(<code>activeSpan</code>)，取其id作为 <code>parentSpanId</code>。如果不存在就设置为-1。</li>
<li>数据复用：<code>EntrySpan</code>和<code>ExitSpan</code>，创建时会判断<code>parentSpan</code>也是同类型的<code>Span</code>则复用，否则才会初始化并入栈。<code>LocalSpan</code>不会做检查，直接初始化并入栈</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">   <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Create an entry span
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param operationName most likely a service name
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return span instance. Ref to {@link EntrySpan}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AbstractSpan</span> <span class="nf">createEntrySpan</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">operationName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 限制机制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// spanLimit配置项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">isLimitMechanismWorking</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">NoopSpan</span> <span class="n">span</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NoopSpan</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">push</span><span class="o">(</span><span class="n">span</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">AbstractSpan</span> <span class="n">entrySpan</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">TracingContext</span> <span class="n">owner</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 弹出一个span作为父级。这里的peek 不会删除元素
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">final</span> <span class="n">AbstractSpan</span> <span class="n">parentSpan</span> <span class="o">=</span> <span class="n">peek</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 拿到父级span的ID，如果不存在父级，赋值为-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">parentSpanId</span> <span class="o">=</span> <span class="n">parentSpan</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">parentSpan</span><span class="o">.</span><span class="na">getSpanId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 不为null 复用span，覆写信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">parentSpan</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">parentSpan</span><span class="o">.</span><span class="na">isEntry</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">             * Only add the profiling recheck on creating entry span,
</span></span></span><span class="line"><span class="cl"><span class="cm">             * as the operation name could be overrided.
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span>
</span></span><span class="line"><span class="cl">            <span class="n">profilingRecheck</span><span class="o">(</span><span class="n">parentSpan</span><span class="o">,</span> <span class="n">operationName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">parentSpan</span><span class="o">.</span><span class="na">setOperationName</span><span class="o">(</span><span class="n">operationName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">entrySpan</span> <span class="o">=</span> <span class="n">parentSpan</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">entrySpan</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 巧了，没有父级，创建 EntrySpan。并入栈
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">entrySpan</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EntrySpan</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">spanIdGenerator</span><span class="o">++,</span> <span class="n">parentSpanId</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">operationName</span><span class="o">,</span> <span class="n">owner</span>
</span></span><span class="line"><span class="cl">            <span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">entrySpan</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">push</span><span class="o">(</span><span class="n">entrySpan</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="stopspan" class="headerLink">
    <a href="#stopspan" class="header-mark"></a><code>stopSpan()</code></h6><ol>
<li>传入的Span必须是activeSpanStack栈顶的Span，否则抛出异常</li>
<li>栈顶的Span出栈，如果栈顶的Span是AbstractTracingSpan，调用Span自身的finish方法</li>
<li>如果栈已经空了且当前TracingContext还在运行状态
<ol>
<li>关闭当前TraceSegment</li>
<li>将当前TraceSegment交给TracingContextListener去处理，TracingContextListener会将TraceSegment发送到OAP</li>
<li>修改当前TracingContext运行状态为false</li>
</ol>
</li>
</ol>
<blockquote>
<p><a href="https://blog.csdn.net/qq_40378034/article/details/125040223?spm=1001.2014.3001.5502" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/qq_40378034/article/details/125040223?spm=1001.2014.3001.5502</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> *停止， 只能停止栈顶的span。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &gt;按照子父级的概念 要先把子级关闭，才能去关闭父级
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Stop the given span, if and only if this one is the top element of {@link #activeSpanStack}. Because the tracing
</span></span></span><span class="line"><span class="cl"><span class="cm"> * core must make sure the span must match in a stack module, like any program did.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param span to finish
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">stopSpan</span><span class="o">(</span><span class="n">AbstractSpan</span> <span class="n">span</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractSpan</span> <span class="n">lastSpan</span> <span class="o">=</span> <span class="n">peek</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">lastSpan</span> <span class="o">==</span> <span class="n">span</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">lastSpan</span> <span class="k">instanceof</span> <span class="n">AbstractTracingSpan</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">AbstractTracingSpan</span> <span class="n">toFinishSpan</span> <span class="o">=</span> <span class="o">(</span><span class="n">AbstractTracingSpan</span><span class="o">)</span> <span class="n">lastSpan</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">toFinishSpan</span><span class="o">.</span><span class="na">finish</span><span class="o">(</span><span class="n">segment</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Stopping the unexpected span = &#34;</span> <span class="o">+</span> <span class="n">span</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">finish</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">activeSpanStack</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="上下文适配器-contextmanager" class="headerLink">
    <a href="#%e4%b8%8a%e4%b8%8b%e6%96%87%e9%80%82%e9%85%8d%e5%99%a8-contextmanager" class="header-mark"></a>上下文适配器 <code>ContextManager</code></h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@link ContextManager} controls the whole context of {@link TraceSegment}. Any {@link TraceSegment} relates to
</span></span></span><span class="line"><span class="cl"><span class="cm"> * single-thread, so this context use {@link ThreadLocal} to maintain the context, and make sure, since a {@link
</span></span></span><span class="line"><span class="cl"><span class="cm"> * TraceSegment} starts, all ChildOf spans are in the same context. &lt;p&gt; What is &#39;ChildOf&#39;?
</span></span></span><span class="line"><span class="cl"><span class="cm"> * https://github.com/opentracing/specification/blob/master/specification.md#references-between-spans
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt; Also, {@link ContextManager} delegates to all {@link AbstractTracerContext}&#39;s major methods.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ContextManager代理了AbstractTracerContext主要的方法
</span></span></span><span class="line"><span class="cl"><span class="cm"> * TraceSegment及其所包含的Span都在同一个线程内，ContextManager使用ThreadLocal来管理TraceSegment的上下文（也就是AbstractTracerContext）
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContextManager</span> <span class="kd">implements</span> <span class="n">BootService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">EMPTY_TRACE_CONTEXT_ID</span> <span class="o">=</span> <span class="s">&#34;N/A&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ContextManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">AbstractTracerContext</span><span class="o">&gt;</span> <span class="n">CONTEXT</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">AbstractTracerContext</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">RuntimeContext</span><span class="o">&gt;</span> <span class="n">RUNTIME_CONTEXT</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">RuntimeContext</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ContextManagerExtendService</span> <span class="n">EXTEND_SERVICE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">AbstractTracerContext</span> <span class="nf">getOrCreate</span><span class="o">(</span><span class="n">String</span> <span class="n">operationName</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">forceSampling</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 从 threadLocal 中获取 AbstractTracerContext, 存在就返回，不存在就创建。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AbstractTracerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">CONTEXT</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// operationName为空创建IgnoredTracerContext
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">operationName</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isDebugEnable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;No operation name, ignore this trace.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IgnoredTracerContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 初始化 ContextManagerExtendService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 调用ContextManagerExtendService的createTraceContext方法创建AbstractTracerContext,并设置到ThreadLocal中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">EXTEND_SERVICE</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">EXTEND_SERVICE</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">ContextManagerExtendService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span> <span class="o">=</span> <span class="n">EXTEND_SERVICE</span><span class="o">.</span><span class="na">createTraceContext</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="n">forceSampling</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">CONTEXT</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">context</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">AbstractTracerContext</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">CONTEXT</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the first global trace id when tracing. Otherwise, &#34;N/A&#34;.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getGlobalTraceId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractTracerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">CONTEXT</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">context</span><span class="o">)</span> <span class="o">?</span> <span class="n">context</span><span class="o">.</span><span class="na">getReadablePrimaryTraceId</span><span class="o">()</span> <span class="o">:</span> <span class="n">EMPTY_TRACE_CONTEXT_ID</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the current segment id when tracing. Otherwise, &#34;N/A&#34;.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getSegmentId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractTracerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">CONTEXT</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">context</span><span class="o">)</span> <span class="o">?</span> <span class="n">context</span><span class="o">.</span><span class="na">getSegmentId</span><span class="o">()</span> <span class="o">:</span> <span class="n">EMPTY_TRACE_CONTEXT_ID</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the current span id when tracing. Otherwise, the value is -1.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getSpanId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractTracerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">CONTEXT</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">context</span><span class="o">)</span> <span class="o">?</span> <span class="n">context</span><span class="o">.</span><span class="na">getSpanId</span><span class="o">()</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">AbstractSpan</span> <span class="nf">createEntrySpan</span><span class="o">(</span><span class="n">String</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">ContextCarrier</span> <span class="n">carrier</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractSpan</span> <span class="n">span</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractTracerContext</span> <span class="n">context</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">operationName</span> <span class="o">=</span> <span class="n">StringUtil</span><span class="o">.</span><span class="na">cut</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="n">OPERATION_NAME_THRESHOLD</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">carrier</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">carrier</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SamplingService</span> <span class="n">samplingService</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">SamplingService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">samplingService</span><span class="o">.</span><span class="na">forceSampled</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 一定要强制采样,因为链路中的前置TraceSegment已经存在,否则链路就可能会断开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">context</span> <span class="o">=</span> <span class="n">getOrCreate</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">span</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">createEntrySpan</span><span class="o">(</span><span class="n">operationName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="o">.</span><span class="na">extract</span><span class="o">(</span><span class="n">carrier</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 不需要强制采样,根据采样率来决定当前链路是否要采样
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">context</span> <span class="o">=</span> <span class="n">getOrCreate</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">span</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">createEntrySpan</span><span class="o">(</span><span class="n">operationName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">span</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">AbstractSpan</span> <span class="nf">createLocalSpan</span><span class="o">(</span><span class="n">String</span> <span class="n">operationName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">operationName</span> <span class="o">=</span> <span class="n">StringUtil</span><span class="o">.</span><span class="na">cut</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="n">OPERATION_NAME_THRESHOLD</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractTracerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">getOrCreate</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">createLocalSpan</span><span class="o">(</span><span class="n">operationName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">AbstractSpan</span> <span class="nf">createExitSpan</span><span class="o">(</span><span class="n">String</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">ContextCarrier</span> <span class="n">carrier</span><span class="o">,</span> <span class="n">String</span> <span class="n">remotePeer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">carrier</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;ContextCarrier can&#39;t be null.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">operationName</span> <span class="o">=</span> <span class="n">StringUtil</span><span class="o">.</span><span class="na">cut</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="n">OPERATION_NAME_THRESHOLD</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractTracerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">getOrCreate</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractSpan</span> <span class="n">span</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">createExitSpan</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="n">remotePeer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">carrier</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">span</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">AbstractSpan</span> <span class="nf">createExitSpan</span><span class="o">(</span><span class="n">String</span> <span class="n">operationName</span><span class="o">,</span> <span class="n">String</span> <span class="n">remotePeer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">operationName</span> <span class="o">=</span> <span class="n">StringUtil</span><span class="o">.</span><span class="na">cut</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="n">OPERATION_NAME_THRESHOLD</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractTracerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">getOrCreate</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">createExitSpan</span><span class="o">(</span><span class="n">operationName</span><span class="o">,</span> <span class="n">remotePeer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">ContextCarrier</span> <span class="n">carrier</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">get</span><span class="o">().</span><span class="na">inject</span><span class="o">(</span><span class="n">carrier</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">extract</span><span class="o">(</span><span class="n">ContextCarrier</span> <span class="n">carrier</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">carrier</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;ContextCarrier can&#39;t be null.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">carrier</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">get</span><span class="o">().</span><span class="na">extract</span><span class="o">(</span><span class="n">carrier</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">ContextSnapshot</span> <span class="nf">capture</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">get</span><span class="o">().</span><span class="na">capture</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">continued</span><span class="o">(</span><span class="n">ContextSnapshot</span> <span class="n">snapshot</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">snapshot</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;ContextSnapshot can&#39;t be null.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">snapshot</span><span class="o">.</span><span class="na">isFromCurrent</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">get</span><span class="o">().</span><span class="na">continued</span><span class="o">(</span><span class="n">snapshot</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">AbstractTracerContext</span> <span class="nf">awaitFinishAsync</span><span class="o">(</span><span class="n">AbstractSpan</span> <span class="n">span</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">AbstractTracerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractSpan</span> <span class="n">activeSpan</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">activeSpan</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">span</span> <span class="o">!=</span> <span class="n">activeSpan</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Span is not the active in current context.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">awaitFinishAsync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If not sure has the active span, use this method, will be cause NPE when has no active span, use
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ContextManager::isActive method to determine whether there has the active span.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">AbstractSpan</span> <span class="nf">activeSpan</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">get</span><span class="o">().</span><span class="na">activeSpan</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Recommend use ContextManager::stopSpan(AbstractSpan span), because in that way, the TracingContext core could
</span></span></span><span class="line"><span class="cl"><span class="cm">     * verify this span is the active one, in order to avoid stop unexpected span. If the current span is hard to get or
</span></span></span><span class="line"><span class="cl"><span class="cm">     * only could get by low-performance way, this stop way is still acceptable.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stopSpan</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">AbstractTracerContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">stopSpan</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">activeSpan</span><span class="o">(),</span> <span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stopSpan</span><span class="o">(</span><span class="n">AbstractSpan</span> <span class="n">span</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">stopSpan</span><span class="o">(</span><span class="n">span</span><span class="o">,</span> <span class="n">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stopSpan</span><span class="o">(</span><span class="n">AbstractSpan</span> <span class="n">span</span><span class="o">,</span> <span class="kd">final</span> <span class="n">AbstractTracerContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">stopSpan</span><span class="o">(</span><span class="n">span</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">CONTEXT</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">RUNTIME_CONTEXT</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isActive</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">get</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">RuntimeContext</span> <span class="nf">getRuntimeContext</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">RuntimeContext</span> <span class="n">runtimeContext</span> <span class="o">=</span> <span class="n">RUNTIME_CONTEXT</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">runtimeContext</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">runtimeContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RuntimeContext</span><span class="o">(</span><span class="n">RUNTIME_CONTEXT</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">RUNTIME_CONTEXT</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">runtimeContext</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">runtimeContext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CorrelationContext</span> <span class="nf">getCorrelationContext</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">AbstractTracerContext</span> <span class="n">tracerContext</span> <span class="o">=</span> <span class="n">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">tracerContext</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tracerContext</span><span class="o">.</span><span class="na">getCorrelationContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="-datacarrier" class="headerLink">
    <a href="#-datacarrier" class="header-mark"></a><code> DataCarrier</code></h4><blockquote>
<p>Agent采集到的链路数据会先放到DataCarrier中，由消费者线程读取DataCarrier中的数据上报到OAP</p>
</blockquote>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102202626977.png" title="image-20230102202626977" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102202626977.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102202626977.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102202626977.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102202626977.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102202626977.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102202626977.png">
    </a></p>
<p><em><strong>相关数据的结构图示</strong></em></p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215335270.png" title="image-20230102215335270" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215335270.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215335270.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215335270.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215335270.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215335270.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215335270.png">
    </a></p>
<h5 id="基础buffer" class="headerLink">
    <a href="#%e5%9f%ba%e7%a1%80buffer" class="header-mark"></a><code>基础Buffer</code></h5><p>底层是一个数组<a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102212012381.png" title="image-20230102212012381" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102212012381.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102212012381.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102212012381.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102212012381.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102212012381.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102212012381.png">
    </a></p>
<h6 id="buffer" class="headerLink">
    <a href="#buffer" class="header-mark"></a><code>Buffer</code></h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Self implementation ring queue.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 自行实现环形队列。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * // jdk 知识。 jdk 9 之后
</span></span></span><span class="line"><span class="cl"><span class="cm"> * AtomicIntegerArray 中 VarHandle 替代以往的直接使用 Unsafe, 目的是为了更安全的去操作内存，提升性能
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 屏蔽了 Unsafe 的危险性
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Buffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">QueueBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 数据的数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">buffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 策略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">BufferStrategy</span> <span class="n">strategy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 数组 buffer 的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">AtomicRangeInteger</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Buffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">bufferSize</span><span class="o">,</span> <span class="n">BufferStrategy</span> <span class="n">strategy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">bufferSize</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">strategy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">index</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicRangeInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">bufferSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStrategy</span><span class="o">(</span><span class="n">BufferStrategy</span> <span class="n">strategy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">strategy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 环状队列。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * getAndIncrement(),会为data分配下标。如果数组已经满了，会从0开始。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 在arr[index] 的 value 不为空的情况下，根据策略来决定是否覆盖。
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param data to add.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">save</span><span class="o">(</span><span class="n">T</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 策略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">switch</span> <span class="o">(</span><span class="n">strategy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="n">IF_POSSIBLE</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getBufferSize</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">obtain</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">consumeList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">consumeList</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">obtain</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">consumeList</span><span class="o">,</span> <span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">consumeList</span><span class="o">.</span><span class="na">add</span><span class="o">((</span><span class="n">T</span><span class="o">)</span> <span class="n">buffer</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">                <span class="n">buffer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">BufferStrategy</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 阻塞，等待队列有空位置
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLOCKING</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 能放就放，不能放就算了
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">IF_POSSIBLE</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="arrayblockingqueuebuffer" class="headerLink">
    <a href="#arrayblockingqueuebuffer" class="header-mark"></a><code>ArrayBlockingQueueBuffer</code></h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The buffer implementation based on JDK ArrayBlockingQueue.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This implementation has better performance in server side. We are still trying to research whether this is suitable
</span></span></span><span class="line"><span class="cl"><span class="cm"> * for agent side, which is more sensitive about blocks.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 阻塞队列实现的 Buffer
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 作者说 在 OAP 中 使用 ArrayBlockingQueue 拥有更高的性能。就想在agent 端试试
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayBlockingQueueBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">QueueBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">BufferStrategy</span> <span class="n">strategy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ArrayBlockingQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ArrayBlockingQueueBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">bufferSize</span><span class="o">,</span> <span class="n">BufferStrategy</span> <span class="n">strategy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">strategy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayBlockingQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">bufferSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">bufferSize</span> <span class="o">=</span> <span class="n">bufferSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">save</span><span class="o">(</span><span class="n">T</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//only BufferStrategy.BLOCKING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">queue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Ignore the error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStrategy</span><span class="o">(</span><span class="n">BufferStrategy</span> <span class="n">strategy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">strategy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">obtain</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">consumeList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">queue</span><span class="o">.</span><span class="na">drainTo</span><span class="o">(</span><span class="n">consumeList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getBufferSize</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">bufferSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="channels" class="headerLink">
    <a href="#channels" class="header-mark"></a><code>Channels</code></h5><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215615091.png" title="image-20230102215615091" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215615091.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215615091.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215615091.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215615091.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215615091.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215615091.png">
    </a></p>
<blockquote>
<p>对一组 Buffer  进行管理</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Channels of Buffer It contains all buffer data which belongs to this channel. It supports several strategy when
</span></span></span><span class="line"><span class="cl"><span class="cm"> * buffer is full. The Default is BLOCKING &lt;p&gt; Created by wusheng on 2016/10/25.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Buffer Channels 包含属于该通道的所有缓冲区数据。当缓冲区已满时，它支持多种策略。默认为阻塞
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Channels</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 被管理的 buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">QueueBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;[]</span> <span class="n">bufferChannels</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 分区器 1. 滚动分区。2.线程id取模
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">IDataPartitioner</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">dataPartitioner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 策略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BufferStrategy</span> <span class="n">strategy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Channels</span><span class="o">(</span><span class="kt">int</span> <span class="n">channelSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="o">,</span> <span class="n">IDataPartitioner</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">partitioner</span><span class="o">,</span> <span class="n">BufferStrategy</span> <span class="n">strategy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">dataPartitioner</span> <span class="o">=</span> <span class="n">partitioner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">strategy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufferChannels</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueueBuffer</span><span class="o">[</span><span class="n">channelSize</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">channelSize</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">BufferStrategy</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">strategy</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">bufferChannels</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayBlockingQueueBuffer</span><span class="o">&lt;&gt;(</span><span class="n">bufferSize</span><span class="o">,</span> <span class="n">strategy</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">bufferChannels</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Buffer</span><span class="o">&lt;&gt;(</span><span class="n">bufferSize</span><span class="o">,</span> <span class="n">strategy</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// noinspection PointlessArithmeticExpression
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">size</span> <span class="o">=</span> <span class="mi">1L</span> <span class="o">*</span> <span class="n">channelSize</span> <span class="o">*</span> <span class="n">bufferSize</span><span class="o">;</span> <span class="c1">// it&#39;s not pointless, it prevents numeric overflow before assigning an integer to a long
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">save</span><span class="o">(</span><span class="n">T</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Buffer 的索引。即选择那个 Buffer 来储存数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">dataPartitioner</span><span class="o">.</span><span class="na">partition</span><span class="o">(</span><span class="n">bufferChannels</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">retryCountDown</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">BufferStrategy</span><span class="o">.</span><span class="na">IF_POSSIBLE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">strategy</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">maxRetryCount</span> <span class="o">=</span> <span class="n">dataPartitioner</span><span class="o">.</span><span class="na">maxRetryCount</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">maxRetryCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">retryCountDown</span> <span class="o">=</span> <span class="n">maxRetryCount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;</span> <span class="n">retryCountDown</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span> <span class="n">retryCountDown</span><span class="o">--)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">bufferChannels</span><span class="o">[</span><span class="n">index</span><span class="o">].</span><span class="na">save</span><span class="o">(</span><span class="n">data</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPartitioner</span><span class="o">(</span><span class="n">IDataPartitioner</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">dataPartitioner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">dataPartitioner</span> <span class="o">=</span> <span class="n">dataPartitioner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * override the strategy at runtime. Notice, this will override several channels one by one. So, when running
</span></span></span><span class="line"><span class="cl"><span class="cm">     * setStrategy, each channel may use different BufferStrategy
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStrategy</span><span class="o">(</span><span class="n">BufferStrategy</span> <span class="n">strategy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">QueueBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buffer</span> <span class="o">:</span> <span class="n">bufferChannels</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">setStrategy</span><span class="o">(</span><span class="n">strategy</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * get channelSize
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getChannelSize</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bufferChannels</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">QueueBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">getBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bufferChannels</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="消费-consumer" class="headerLink">
    <a href="#%e6%b6%88%e8%b4%b9-consumer" class="header-mark"></a><code>消费 Consumer</code></h5><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215631893.png" title="image-20230102215631893" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215631893.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215631893.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215631893.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215631893.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215631893.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102215631893.png">
    </a></p>
<p>消费者读取DataCarrier中的数据上报到OAP，IConsumer是消费者的顶层接口，定义了基本方案。</p>
<h6 id="consumerthread" class="headerLink">
    <a href="#consumerthread" class="header-mark"></a><code>ConsumerThread</code></h6><blockquote>
<p>一个ConsumerThread中包含多个DataSource，DataSource里包装了Buffer。同时一个ConsumerThread绑定了一个Consumer，Consumer会消费ConsumerThread中的DataSource</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 一个线程，绑定一个消费者
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 一个消费者，绑定多个 Buffer
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param &lt;T&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsumerThread</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">running</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSource</span><span class="o">&gt;</span> <span class="n">dataSources</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 本次消费没有取到数据时，现成 sleep 的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kt">long</span> <span class="n">consumeCycle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ConsumerThread</span><span class="o">(</span><span class="n">String</span> <span class="n">threadName</span><span class="o">,</span> <span class="n">IConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">,</span> <span class="kt">long</span> <span class="n">consumeCycle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">threadName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">consumer</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataSources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DataSource</span><span class="o">&gt;(</span><span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">consumeCycle</span> <span class="o">=</span> <span class="n">consumeCycle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * add whole buffer to consume
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">addDataSource</span><span class="o">(</span><span class="n">QueueBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">sourceBuffer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">dataSources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">DataSource</span><span class="o">(</span><span class="n">sourceBuffer</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">consumeList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="mi">1500</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 没取到数据？ 睡一会
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">consume</span><span class="o">(</span><span class="n">consumeList</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">consumeCycle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// consumer thread is going to stop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// consume the last time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 在结束时，再消费一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">consume</span><span class="o">(</span><span class="n">consumeList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">consumer</span><span class="o">.</span><span class="na">onExit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 将数据 放到 consumeList。 并消费
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param consumeList
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">consume</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">consumeList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">DataSource</span> <span class="n">dataSource</span> <span class="o">:</span> <span class="n">dataSources</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dataSource</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">consumeList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">consumeList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">consumer</span><span class="o">.</span><span class="na">consume</span><span class="o">(</span><span class="n">consumeList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">consumer</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">consumeList</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">consumeList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">consumer</span><span class="o">.</span><span class="na">nothingToConsume</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 适配器
</span></span></span><span class="line"><span class="cl"><span class="cm">     * DataSource is a refer to {@link Buffer}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">class</span> <span class="nc">DataSource</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">QueueBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">sourceBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">DataSource</span><span class="o">(</span><span class="n">QueueBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">sourceBuffer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">sourceBuffer</span> <span class="o">=</span> <span class="n">sourceBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">obtain</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">consumeList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sourceBuffer</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">consumeList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="multiplechannelsconsumer" class="headerLink">
    <a href="#multiplechannelsconsumer" class="header-mark"></a><code>MultipleChannelsConsumer</code></h6><blockquote>
<p>一个单消费者线程，但支持多个Channels和它们的消费者。</p>
<p>一个Group中包含一个Consumer和一个Channels，一个Channels包含多个Buffer，Consumer会消费Channels中所有的Buffer</p>
<p>一个MultipleChannelsConsumer包含多个Group，实际上是管理多个Consumer以及它们对应的Buffer</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Licensed to the Apache Software Foundation (ASF) under one or more
</span></span></span><span class="line"><span class="cl"><span class="cm"> * contributor license agreements.  See the NOTICE file distributed with
</span></span></span><span class="line"><span class="cl"><span class="cm"> * this work for additional information regarding copyright ownership.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The ASF licenses this file to You under the Apache License, Version 2.0
</span></span></span><span class="line"><span class="cl"><span class="cm"> * (the &#34;License&#34;); you may not use this file except in compliance with
</span></span></span><span class="line"><span class="cl"><span class="cm"> * the License.  You may obtain a copy of the License at
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Unless required by applicable law or agreed to in writing, software
</span></span></span><span class="line"><span class="cl"><span class="cm"> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * See the License for the specific language governing permissions and
</span></span></span><span class="line"><span class="cl"><span class="cm"> * limitations under the License.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">org.apache.skywalking.apm.commons.datacarrier.consumer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.commons.datacarrier.buffer.Channels</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.skywalking.apm.commons.datacarrier.buffer.QueueBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * MultipleChannelsConsumer represent a single consumer thread, but support multiple channels with their {@link
</span></span></span><span class="line"><span class="cl"><span class="cm"> * IConsumer}s
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 一个单消费者线程,但支持多个channels和它们的消费者
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultipleChannelsConsumer</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">running</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="n">consumeTargets</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;NonAtomicVolatileUpdate&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">consumeCycle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">MultipleChannelsConsumer</span><span class="o">(</span><span class="n">String</span> <span class="n">threadName</span><span class="o">,</span> <span class="kt">long</span> <span class="n">consumeCycle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">threadName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">consumeTargets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">consumeCycle</span> <span class="o">=</span> <span class="n">consumeCycle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">List</span> <span class="n">consumeList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">hasData</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Group</span> <span class="n">target</span> <span class="o">:</span> <span class="n">consumeTargets</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">boolean</span> <span class="n">consume</span> <span class="o">=</span> <span class="n">consume</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">consumeList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">hasData</span> <span class="o">=</span> <span class="n">hasData</span> <span class="o">||</span> <span class="n">consume</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">hasData</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">consumeCycle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// consumer thread is going to stop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// consume the last time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">Group</span> <span class="n">target</span> <span class="o">:</span> <span class="n">consumeTargets</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">consume</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">consumeList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="o">.</span><span class="na">consumer</span><span class="o">.</span><span class="na">onExit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">consume</span><span class="o">(</span><span class="n">Group</span> <span class="n">target</span><span class="o">,</span> <span class="n">List</span> <span class="n">consumeList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 遍历channels中的buffer,将buffer中的数据放到consumeList中,并清空buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">.</span><span class="na">channels</span><span class="o">.</span><span class="na">getChannelSize</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">QueueBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">channels</span><span class="o">.</span><span class="na">getBuffer</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">consumeList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">consumeList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 调用消费者的消费逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">target</span><span class="o">.</span><span class="na">consumer</span><span class="o">.</span><span class="na">consume</span><span class="o">(</span><span class="n">consumeList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">target</span><span class="o">.</span><span class="na">consumer</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">consumeList</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">consumeList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span><span class="o">.</span><span class="na">consumer</span><span class="o">.</span><span class="na">nothingToConsume</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Add a new target channels.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addNewTarget</span><span class="o">(</span><span class="n">Channels</span> <span class="n">channels</span><span class="o">,</span> <span class="n">IConsumer</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Group</span><span class="o">(</span><span class="n">channels</span><span class="o">,</span> <span class="n">consumer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Recreate the new list to avoid change list while the list is used in consuming.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="n">newList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Group</span> <span class="n">target</span> <span class="o">:</span> <span class="n">consumeTargets</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">newList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">newList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">consumeTargets</span> <span class="o">=</span> <span class="n">newList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">+=</span> <span class="n">channels</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Group</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 一个channels对应多个buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="n">Channels</span> <span class="n">channels</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// consumer会消费channels中所有的buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="n">IConsumer</span> <span class="n">consumer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="nf">Group</span><span class="o">(</span><span class="n">Channels</span> <span class="n">channels</span><span class="o">,</span> <span class="n">IConsumer</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">consumer</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="消费驱动-drive" class="headerLink">
    <a href="#%e6%b6%88%e8%b4%b9%e9%a9%b1%e5%8a%a8-drive" class="header-mark"></a><code>消费驱动 Drive</code></h5><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102220905069.png" title="image-20230102220905069" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102220905069.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102220905069.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102220905069.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102220905069.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102220905069.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/image-20230102220905069.png">
    </a></p>
<h6 id="consumedriver" class="headerLink">
    <a href="#consumedriver" class="header-mark"></a><code>ConsumeDriver</code></h6><blockquote>
<p>一个ConsumeDriver包含多个ConsumerThread</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Pool of consumers &lt;p&gt; Created by wusheng on 2016/10/25.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  一堆消费者线程，拿着一堆 buffer ， 按照 allocateBuffer2Thread() 的策略 进行分配消费。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsumeDriver</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">IDriver</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">running</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ConsumerThread</span><span class="o">[]</span> 
</span></span><span class="line"><span class="cl">      <span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Channels</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">channels</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ReentrantLock</span> <span class="n">lock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">ConsumeDriver</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Channels</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">channels</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">IConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">consumerClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">num</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">consumeCycle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">channels</span><span class="o">,</span> <span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">consumerThreads</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumerThread</span><span class="o">(</span><span class="s">&#34;DataCarrier.&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;.Consumer.&#34;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&#34;.Thread&#34;</span><span class="o">,</span> <span class="n">getNewConsumerInstance</span><span class="o">(</span><span class="n">consumerClass</span><span class="o">),</span> <span class="n">consumeCycle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">consumerThreads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">ConsumeDriver</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Channels</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">channels</span><span class="o">,</span> <span class="n">IConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">prototype</span><span class="o">,</span> <span class="kt">int</span> <span class="n">num</span><span class="o">,</span> <span class="kt">long</span> <span class="n">consumeCycle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">channels</span><span class="o">,</span> <span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">prototype</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">consumerThreads</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumerThread</span><span class="o">(</span><span class="s">&#34;DataCarrier.&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;.Consumer.&#34;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&#34;.Thread&#34;</span><span class="o">,</span> <span class="n">prototype</span><span class="o">,</span> <span class="n">consumeCycle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">consumerThreads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">ConsumeDriver</span><span class="o">(</span><span class="n">Channels</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">channels</span><span class="o">,</span> <span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">consumerThreads</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumerThread</span><span class="o">[</span><span class="n">num</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">getNewConsumerInstance</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">IConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">consumerClass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">IConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">inst</span> <span class="o">=</span> <span class="n">consumerClass</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">().</span><span class="na">newInstance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">inst</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">inst</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ConsumerCannotBeCreatedException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ConsumerCannotBeCreatedException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ConsumerCannotBeCreatedException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ConsumerCannotBeCreatedException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">begin</span><span class="o">(</span><span class="n">Channels</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// begin只能调用一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">allocateBuffer2Thread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">ConsumerThread</span> <span class="n">consumerThread</span> <span class="o">:</span> <span class="n">consumerThreads</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">consumerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isRunning</span><span class="o">(</span><span class="n">Channels</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">running</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">allocateBuffer2Thread</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">channelSize</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">channels</span><span class="o">.</span><span class="na">getChannelSize</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 因为channels里面有多个buffer,同时这里也有多个消费者线程
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 这一步的操作就是将这些buffer分配给不同的消费者线程去消费
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 
</span></span></span><span class="line"><span class="cl"><span class="cm">         * if consumerThreads.length &lt; channelSize
</span></span></span><span class="line"><span class="cl"><span class="cm">         * each consumer will process several channels.
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * if consumerThreads.length == channelSize
</span></span></span><span class="line"><span class="cl"><span class="cm">         * each consumer will process one channel.
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * if consumerThreads.length &gt; channelSize
</span></span></span><span class="line"><span class="cl"><span class="cm">         * there will be some threads do nothing.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">channelIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">channelIndex</span> <span class="o">&lt;</span> <span class="n">channelSize</span><span class="o">;</span> <span class="n">channelIndex</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 消费者线程索引 = buffer的下标和消费者线程数取模
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">consumerIndex</span> <span class="o">=</span> <span class="n">channelIndex</span> <span class="o">%</span> <span class="n">consumerThreads</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">consumerThreads</span><span class="o">[</span><span class="n">consumerIndex</span><span class="o">].</span><span class="na">addDataSource</span><span class="o">(</span><span class="n">channels</span><span class="o">.</span><span class="na">getBuffer</span><span class="o">(</span><span class="n">channelIndex</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="n">Channels</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">ConsumerThread</span> <span class="n">consumerThread</span> <span class="o">:</span> <span class="n">consumerThreads</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">consumerThread</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="bulkconsumepool" class="headerLink">
    <a href="#bulkconsumepool" class="header-mark"></a><code>BulkConsumePool</code></h6><blockquote>
<p>一个BulkConsumePool包含多个MultipleChannelsConsumer</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * BulkConsumePool works for consuming data from multiple channels(DataCarrier instances), with multiple {@link
</span></span></span><span class="line"><span class="cl"><span class="cm"> * MultipleChannelsConsumer}s.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * In typical case, the number of {@link MultipleChannelsConsumer} should be less than the number of channels.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * BulkConsumePool 用于使用多个MultipleChannelsConsumer消耗来自多个通道（DataCarrier 实例）的数据。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 在典型情况下， MultipleChannelsConsumer的数量应该小于通道的数量
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BulkConsumePool</span> <span class="kd">implements</span> <span class="n">ConsumerPool</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MultipleChannelsConsumer</span><span class="o">&gt;</span> <span class="n">allConsumers</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isStarted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">BulkConsumePool</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="kt">long</span> <span class="n">consumeCycle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="n">EnvUtil</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#34;_THREAD&#34;</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">allConsumers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">MultipleChannelsConsumer</span><span class="o">&gt;(</span><span class="n">size</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建消费者线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">MultipleChannelsConsumer</span> <span class="n">multipleChannelsConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MultipleChannelsConsumer</span><span class="o">(</span><span class="s">&#34;DataCarrier.&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;.BulkConsumePool.&#34;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&#34;.Thread&#34;</span><span class="o">,</span> <span class="n">consumeCycle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">multipleChannelsConsumer</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">allConsumers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">multipleChannelsConsumer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Channels</span> <span class="n">channels</span><span class="o">,</span> <span class="n">IConsumer</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 拿到负载最低的线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">MultipleChannelsConsumer</span> <span class="n">multipleChannelsConsumer</span> <span class="o">=</span> <span class="n">getLowestPayload</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">multipleChannelsConsumer</span><span class="o">.</span><span class="na">addNewTarget</span><span class="o">(</span><span class="n">channels</span><span class="o">,</span> <span class="n">consumer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Get the lowest payload consumer thread based on current allocate status.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return the lowest consumer.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">MultipleChannelsConsumer</span> <span class="nf">getLowestPayload</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MultipleChannelsConsumer</span> <span class="n">winner</span> <span class="o">=</span> <span class="n">allConsumers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 找出持有 buffer 数量最少的线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">allConsumers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">MultipleChannelsConsumer</span> <span class="n">option</span> <span class="o">=</span> <span class="n">allConsumers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">option</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">winner</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">winner</span> <span class="o">=</span> <span class="n">option</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">winner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isRunning</span><span class="o">(</span><span class="n">Channels</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">isStarted</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="n">Channels</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">MultipleChannelsConsumer</span> <span class="n">consumer</span> <span class="o">:</span> <span class="n">allConsumers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">consumer</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">begin</span><span class="o">(</span><span class="n">Channels</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">isStarted</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">MultipleChannelsConsumer</span> <span class="n">consumer</span> <span class="o">:</span> <span class="n">allConsumers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">consumer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">isStarted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The creator for {@link BulkConsumePool}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Creator</span> <span class="kd">implements</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">ConsumerPool</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">long</span> <span class="n">consumeCycle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="nf">Creator</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">poolSize</span><span class="o">,</span> <span class="kt">long</span> <span class="n">consumeCycle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">poolSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">consumeCycle</span> <span class="o">=</span> <span class="n">consumeCycle</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ConsumerPool</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">BulkConsumePool</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">consumeCycle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">recommendMaxSize</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">()</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="链路数据发送的-oap" class="headerLink">
    <a href="#%e9%93%be%e8%b7%af%e6%95%b0%e6%8d%ae%e5%8f%91%e9%80%81%e7%9a%84-oap" class="header-mark"></a>链路数据发送的 OAP</h4><p>TracingContext的<code>finish()</code>方法关闭当前TraceSegment后，会调用ListenerManager的<code>notifyFinish()</code>方法传入当前关闭的TraceSegment。ListenerManager的<code>notifyFinish()</code>方法会迭代所有注册的TracingContextListener调用它们的<code>afterFinished()</code>方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TracingContext</span> <span class="kd">implements</span> <span class="n">AbstractTracerContext</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 结束TracingContext
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Finish this context, and notify all {@link TracingContextListener}s, managed by {@link
</span></span></span><span class="line"><span class="cl"><span class="cm">     * TracingContext.ListenerManager} and {@link TracingContext.TracingThreadListenerManager}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">finish</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">isRunningInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">asyncFinishLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 栈已经空了 且 当前TracingContext还在运行状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">boolean</span> <span class="n">isFinishedInMainThread</span> <span class="o">=</span> <span class="n">activeSpanStack</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">running</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">isFinishedInMainThread</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * Notify after tracing finished in the main thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">                 */</span>
</span></span><span class="line"><span class="cl">                <span class="n">TracingThreadListenerManager</span><span class="o">.</span><span class="na">notifyFinish</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">isFinishedInMainThread</span> <span class="o">&amp;&amp;</span> <span class="o">(!</span><span class="n">isRunningInAsyncMode</span> <span class="o">||</span> <span class="n">asyncSpanCounter</span> <span class="o">==</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 关闭当前TraceSegment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">TraceSegment</span> <span class="n">finishedSegment</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="na">finish</span><span class="o">(</span><span class="n">isLimitMechanismWorking</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 将当前TraceSegment交给TracingContextListener去处理,TracingContextListener会将TraceSegment发送到OAP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">TracingContext</span><span class="o">.</span><span class="na">ListenerManager</span><span class="o">.</span><span class="na">notifyFinish</span><span class="o">(</span><span class="n">finishedSegment</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 修改当前TracingContext运行状态为false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">isRunningInAsyncMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">asyncFinishLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The &lt;code&gt;ListenerManager&lt;/code&gt; represents an event notify for every registered listener, which are notified
</span></span></span><span class="line"><span class="cl"><span class="cm">     * when the &lt;code&gt;TracingContext&lt;/code&gt; finished, and {@link #segment} is ready for further process.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ListenerManager</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TracingContextListener</span><span class="o">&gt;</span> <span class="n">LISTENERS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Add the given {@link TracingContextListener} to {@link #LISTENERS} list.
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @param listener the new listener.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">TracingContextListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LISTENERS</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Notify the {@link TracingContext.ListenerManager} about the given {@link TraceSegment} have finished. And
</span></span></span><span class="line"><span class="cl"><span class="cm">         * trigger {@link TracingContext.ListenerManager} to notify all {@link #LISTENERS} &#39;s {@link
</span></span></span><span class="line"><span class="cl"><span class="cm">         * TracingContextListener#afterFinished(TraceSegment)}
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @param finishedSegment the segment that has finished
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="kt">void</span> <span class="nf">notifyFinish</span><span class="o">(</span><span class="n">TraceSegment</span> <span class="n">finishedSegment</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">TracingContextListener</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">LISTENERS</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">listener</span><span class="o">.</span><span class="na">afterFinished</span><span class="o">(</span><span class="n">finishedSegment</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Clear the given {@link TracingContextListener}
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">TracingContextListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LISTENERS</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>  
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="tracesegmentserviceclient" class="headerLink">
    <a href="#tracesegmentserviceclient" class="header-mark"></a><code>TraceSegmentServiceClient</code></h6><blockquote>
<p><code>TraceSegmentServiceClient</code> 注册了 <code>TracingContextListener</code>的监听。</p>
<p>在 TracingContext.finish() 方法 会通过监听器的逻辑，调用到这个方法。
即，一个Segment 要关闭的时候，会把自己传到这里，这里会将其放入carrier。最后消费</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 向OAP 发送数据
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultImplementor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TraceSegmentServiceClient</span> <span class="kd">implements</span> <span class="n">BootService</span><span class="o">,</span> <span class="n">IConsumer</span><span class="o">&lt;</span><span class="n">TraceSegment</span><span class="o">&gt;,</span> <span class="n">TracingContextListener</span><span class="o">,</span> <span class="n">GRPCChannelListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">TraceSegmentServiceClient</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 上一次打印传输traceSegment情况的日志的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kt">long</span> <span class="n">lastLogTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 成功发送的traceSegment数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kt">long</span> <span class="n">segmentUplinkedCounter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 因网络原因丢弃的traceSegment数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kt">long</span> <span class="n">segmentAbandonedCounter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">DataCarrier</span><span class="o">&lt;</span><span class="n">TraceSegment</span><span class="o">&gt;</span> <span class="n">carrier</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">TraceSegmentReportServiceGrpc</span><span class="o">.</span><span class="na">TraceSegmentReportServiceStub</span> <span class="n">serviceStub</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">GRPCChannelStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">GRPCChannelStatus</span><span class="o">.</span><span class="na">DISCONNECT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">addChannelListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boot</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lastLogTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">segmentUplinkedCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">segmentAbandonedCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">carrier</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataCarrier</span><span class="o">&lt;&gt;(</span><span class="n">CHANNEL_SIZE</span><span class="o">,</span> <span class="n">BUFFER_SIZE</span><span class="o">,</span> <span class="n">BufferStrategy</span><span class="o">.</span><span class="na">IF_POSSIBLE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">carrier</span><span class="o">.</span><span class="na">consume</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TracingContext</span><span class="o">.</span><span class="na">ListenerManager</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TracingContext</span><span class="o">.</span><span class="na">ListenerManager</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">carrier</span><span class="o">.</span><span class="na">shutdownConsumers</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consume</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">TraceSegment</span><span class="o">&gt;</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">CONNECTED</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">status</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">GRPCStreamServiceStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GRPCStreamServiceStatus</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">SegmentObject</span><span class="o">&gt;</span> <span class="n">upstreamSegmentStreamObserver</span> <span class="o">=</span> <span class="n">serviceStub</span><span class="o">.</span><span class="na">withDeadlineAfter</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">Config</span><span class="o">.</span><span class="na">Collector</span><span class="o">.</span><span class="na">GRPC_UPSTREAM_TIMEOUT</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span>
</span></span><span class="line"><span class="cl">            <span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">Commands</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="n">Commands</span> <span class="n">commands</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">CommandService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                           <span class="o">.</span><span class="na">receiveCommand</span><span class="o">(</span><span class="n">commands</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">status</span><span class="o">.</span><span class="na">finished</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isErrorEnable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">throwable</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                            <span class="s">&#34;Send UpstreamSegment to collector fail with a grpc internal exception.&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">reportError</span><span class="o">(</span><span class="n">throwable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">status</span><span class="o">.</span><span class="na">finished</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="n">TraceSegment</span> <span class="n">segment</span> <span class="o">:</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">SegmentObject</span> <span class="n">upstreamSegment</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="na">transform</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 发送到OAP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">upstreamSegmentStreamObserver</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">upstreamSegment</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;Transform and send UpstreamSegment to collector fail.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">upstreamSegmentStreamObserver</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 强制等待所有的traceSegment都发送完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">status</span><span class="o">.</span><span class="na">wait4Finish</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">segmentUplinkedCounter</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">segmentAbandonedCounter</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">printUplinkStatus</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">printUplinkStatus</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">currentTimeMillis</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">currentTimeMillis</span> <span class="o">-</span> <span class="n">lastLogTime</span> <span class="o">&gt;</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lastLogTime</span> <span class="o">=</span> <span class="n">currentTimeMillis</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">segmentUplinkedCounter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} trace segments have been sent to collector.&#34;</span><span class="o">,</span> <span class="n">segmentUplinkedCounter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">segmentUplinkedCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">segmentAbandonedCounter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;{} trace segments have been abandoned, cause by no available channel.&#34;</span><span class="o">,</span> <span class="n">segmentAbandonedCounter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">segmentAbandonedCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">TraceSegment</span><span class="o">&gt;</span> <span class="n">data</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="s">&#34;Try to send {} trace segments to collector, with unexpected exception.&#34;</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onExit</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 监听方法。 TracingContext.finish() 方法 会通过监听器的逻辑，调用到这个方法。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 即，一个Segment 要关闭的时候，会把自己传到这里，这里会将其放入carrier。最后消费
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param traceSegment
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterFinished</span><span class="o">(</span><span class="n">TraceSegment</span> <span class="n">traceSegment</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">traceSegment</span><span class="o">.</span><span class="na">isIgnore</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将traceSegment放到dataCarrier中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">carrier</span><span class="o">.</span><span class="na">produce</span><span class="o">(</span><span class="n">traceSegment</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isDebugEnable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;One trace segment has been abandoned, cause by buffer is full.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">statusChanged</span><span class="o">(</span><span class="n">GRPCChannelStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">CONNECTED</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">status</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">findService</span><span class="o">(</span><span class="n">GRPCChannelManager</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">serviceStub</span> <span class="o">=</span> <span class="n">TraceSegmentReportServiceGrpc</span><span class="o">.</span><span class="na">newStub</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></div>

        

<div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-03-20</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.md target="_blank" rel="noopener noreferrer">阅读原始文档</a>
                    </span></div>
            <div class="post-info-share">
                <span><a href="#" title="分享到 Twitter" data-sharer="twitter" data-url="http://yanghx.vip/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="Skywalking 8.7.0 源码分析学习笔记" data-via="xxxx" data-hashtags="Skywalking"><i class="fab fa-twitter fa-fw"></i></a><a href="#" title="分享到 Facebook" data-sharer="facebook" data-url="http://yanghx.vip/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-hashtag="Skywalking"><i class="fab fa-facebook-square fa-fw"></i></a><a href="#" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="http://yanghx.vip/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="Skywalking 8.7.0 源码分析学习笔记" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="#" title="分享到 Line" data-sharer="line" data-url="http://yanghx.vip/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="Skywalking 8.7.0 源码分析学习笔记"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="#" title="分享到 微博" data-sharer="weibo" data-url="http://yanghx.vip/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="Skywalking 8.7.0 源码分析学习笔记"><i class="fab fa-weibo fa-fw"></i></a><a href="#" title="分享到 Myspace" data-sharer="myspace" data-url="http://yanghx.vip/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="Skywalking 8.7.0 源码分析学习笔记" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="#" title="分享到 Blogger" data-sharer="blogger" data-url="http://yanghx.vip/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="Skywalking 8.7.0 源码分析学习笔记" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="#" title="分享到 Evernote" data-sharer="evernote" data-url="http://yanghx.vip/skywalking8.7.0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="Skywalking 8.7.0 源码分析学习笔记"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/skywalking/">Skywalking</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/readme/" class="prev" rel="prev" title=""><i class="fas fa-angle-left fa-fw"></i></a>
            <a href="/mysql%E5%9F%BA%E7%A1%80-%E9%BB%91%E9%A9%AC/" class="next" rel="next" title="mysql基础-黑马">mysql基础-黑马<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.111.3">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.3.0"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer">yanghx</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp"><a  target="_blank" href="https://beian.miit.gov.cn/">京ICP备2023005717号-1</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div id="cookieconsent-container"></div><div class="assets"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"sharerjs":true,"table":{"sort":true}};</script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script type="text/javascript" src="/js/cookieconsent.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>
</body>

</html>