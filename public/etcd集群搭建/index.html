<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title> - yanghx blog</title><meta name="Description" content="yanghx blog"><meta property="og:title" content="" />
<meta property="og:description" content="Ectd 集群搭建引导etcd群集：静态、etcd发现和DNS发现 一、Ectd 集群搭建 1.1 概述静态启动etcd集群需要集群中的每个成员都知道另一个成员" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://yanghx.vip/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" /><meta property="og:image" content="http://yanghx.vip/logo.png"/><meta property="article:section" content="posts" />

<meta property="og:site_name" content="yanghx blog" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://yanghx.vip/logo.png"/>

<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Ectd 集群搭建引导etcd群集：静态、etcd发现和DNS发现 一、Ectd 集群搭建 1.1 概述静态启动etcd集群需要集群中的每个成员都知道另一个成员"/>
<meta name="application-name" content="DoIt">
<meta name="apple-mobile-web-app-title" content="DoIt">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://yanghx.vip/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" /><link rel="prev" href="http://yanghx.vip/grpc/" /><link rel="next" href="http://yanghx.vip/k8s%E5%85%A5%E9%97%A8/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/yanghx.vip\/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA\/"
        },"genre": "posts","wordcount":  12202 ,
        "url": "http:\/\/yanghx.vip\/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA\/","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "yanghx"
            },"description": ""
    }
    </script><script src="//instant.page/5.1.1" defer type="module" integrity="sha384-MWfCL6g1OTGsbSwfuMHc8+8J2u71/LA8dzlIN3ycajckxuZZmF+DNjdm7O6H3PSq"></script>
</head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="yanghx blog">yanghx blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/series/"> 系列 </a><a class="menu-item" href="/posts/mysql/mysql45/"> mysql45讲 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" class="menu-item theme-select" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="切换主题">
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                        <option value="black">黑色</option>
                        <option value="auto">跟随系统</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="yanghx blog">yanghx blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/series/" title="">系列</a><a class="menu-item" href="/posts/mysql/mysql45/" title="">mysql45讲</a><a href="#" class="menu-item theme-select" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="切换主题">
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                    <option value="black">黑色</option>
                    <option value="auto">跟随系统</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content always-active" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#ectd-集群搭建">Ectd 集群搭建</a></li>
        <li><a href="#一ectd-集群搭建">一、Ectd 集群搭建</a>
          <ul>
            <li><a href="#11-概述">1.1 概述</a></li>
            <li><a href="#12-state">1.2 State</a></li>
            <li><a href="#13-tls">1.3 TLS</a></li>
            <li><a href="#14-自动证书">1.4 自动证书</a></li>
            <li><a href="#15-发现-discovery">1.5 发现 （Discovery）</a>
              <ul>
                <li><a href="#151-etcd-发现">1.5.1 etcd 发现</a></li>
                <li><a href="#152-发现-url-的生命周期">1.5.2 发现 URL 的生命周期</a></li>
                <li><a href="#153-自定义-etcd-发现服务">1.5.3 自定义 etcd 发现服务</a></li>
                <li><a href="#154-公共-etcd-发现服务">1.5.4 公共 etcd 发现服务</a></li>
                <li><a href="#155-dns-发现">1.5.5 DNS 发现</a></li>
                <li><a href="#156-创建-dns-srv-记录">1.5.6 创建 DNS SRV 记录</a></li>
                <li><a href="#157-使用-dns-引导-etcd-集群">1.5.7 使用 DNS 引导 etcd 集群</a></li>
              </ul>
            </li>
            <li><a href="#16-mac-m1---etcd-集群搭建">1.6 MAC M1   ETCD 集群搭建</a>
              <ul>
                <li><a href="#161-创建etcd1sh">1.6.1 <strong>创建etcd1.sh</strong></a></li>
                <li><a href="#162-创建etcd2sh">1.6.2 <strong>创建etcd2.sh</strong></a></li>
                <li><a href="#163-创建etcd3sh">1.6.3 <strong>创建etcd3.sh</strong></a></li>
                <li><a href="#164-创建etcd_serversh用于启动其他三个脚本">1.6.4 <strong>创建etcd_server.sh</strong>，用于启动其他三个脚本</a></li>
                <li><a href="#165-创建客户端连接服务端命令">1.6.5 <strong>创建客户端连接服务端命令</strong></a></li>
                <li><a href="#166-结果如下表示etcd集群搭建成功">1.6.6 结果如下，表示ETCD集群搭建成功</a></li>
              </ul>
            </li>
            <li><a href="#17-如何访问etcd">1.7 如何访问etcd</a>
              <ul>
                <li><a href="#171-put-写命令">1.7.1 put 写命令：</a></li>
                <li><a href="#172-get-从etcd中读取">1.7.2 get 从etcd中读取：</a></li>
              </ul>
            </li>
            <li><a href="#18-如何通过前缀批量获取-keys">1.8 如何通过前缀批量获取 keys</a></li>
            <li><a href="#19-如何删除-keys">1.9 如何删除 keys</a></li>
            <li><a href="#110-如何在事务中进行多次写入">1.10 如何在事务中进行多次写入</a></li>
            <li><a href="#111-监控-keys">1.11 监控 keys</a></li>
            <li><a href="#112-设置过期时间-keys">1.12 设置过期时间 keys</a></li>
            <li><a href="#113-如何创建锁">1.13 如何创建锁</a></li>
            <li><a href="#114-etcd集群中如何进行leader选举">1.14 etcd集群中如何进行leader选举</a></li>
            <li><a href="#115-如何检查集群状态">1.15 如何检查集群状态</a></li>
            <li><a href="#116-如何保存数据库">1.16 如何保存数据库</a></li>
            <li><a href="#117-如何将-etcd-从-v2-迁移到-v3">1.17 如何将 etcd 从 v2 迁移到 v3</a></li>
            <li><a href="#118-如何添加和删除成员">1.18 如何添加和删除成员</a></li>
          </ul>
        </li>
        <li><a href="#二在容器中运行etcd">二、在容器中运行Etcd</a>
          <ul>
            <li><a href="#21-运行单节点-etcd">2.1 运行单节点 etcd</a></li>
            <li><a href="#22-运行-3-节点-etcd-集群">2.2 运行 3 节点 etcd 集群</a></li>
          </ul>
        </li>
        <li><a href="#三故障模式">三、故障模式</a>
          <ul>
            <li><a href="#31-minor-followers-failure">3.1 Minor followers failure</a></li>
            <li><a href="#32-leader-failure">3.2 Leader failure</a></li>
            <li><a href="#33-majority-failure">3.3 Majority failure</a></li>
            <li><a href="#34-网络分区">3.4 网络分区</a></li>
            <li><a href="#35-引导期间失败">3.5 引导期间失败</a></li>
          </ul>
        </li>
        <li><a href="#四灾难恢复">四、灾难恢复</a>
          <ul>
            <li><a href="#41-对键空间进行快照">4.1 对键空间进行快照</a></li>
            <li><a href="#42-恢复集群">4.2 恢复集群</a></li>
            <li><a href="#43-使用错误的-url-从成员错误重新配置中恢复集群">4.3 使用错误的 URL 从成员错误重新配置中恢复集群</a></li>
          </ul>
        </li>
        <li><a href="#五etcd-网关">五、etcd 网关</a>
          <ul>
            <li><a href="#51-什么是etcd网关">5.1 什么是etcd网关</a></li>
            <li><a href="#52-何时使用-etcd-网关">5.2 何时使用 etcd 网关</a></li>
            <li><a href="#53-何时不使用-etcd-网关">5.3 何时不使用 etcd 网关</a></li>
            <li><a href="#54-启动-etcd-网关">5.4 启动 etcd 网关</a></li>
            <li><a href="#55-配置标志">5.5 配置标志</a>
              <ul>
                <li><a href="#551-etcd-集群">5.5.1 etcd 集群</a></li>
                <li><a href="#端点">–端点</a></li>
                <li><a href="#--发现-srv">&ndash;发现-srv</a></li>
                <li><a href="#网络">网络</a></li>
                <li><a href="#--listen-addr">&ndash;listen-addr</a></li>
                <li><a href="#--重试延迟">&ndash;重试延迟</a></li>
                <li><a href="#安全">安全</a></li>
                <li><a href="#不安全的发现">–不安全的发现</a></li>
                <li><a href="#--trusted-ca-文件">&ndash;trusted-ca 文件</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#六grpc-代理">六、gRPC 代理</a>
          <ul>
            <li><a href="#61-可扩展的手表-api">6.1 可扩展的手表 API</a></li>
            <li><a href="#62-限制">6.2 限制</a></li>
            <li><a href="#63-可扩展的租赁-api">6.3 可扩展的租赁 API</a></li>
            <li><a href="#64-滥用客户保护">6.4 滥用客户保护</a></li>
            <li><a href="#65-启动-etcd-grpc-代理">6.5 启动 etcd gRPC 代理</a></li>
            <li><a href="#66-客户端端点同步和名称解析">6.6 客户端端点同步和名称解析</a></li>
            <li><a href="#67-命名空间">6.7 命名空间</a></li>
            <li><a href="#68-tls-终止">6.8 TLS 终止</a></li>
            <li><a href="#69-指标和健康">6.9 指标和健康</a></li>
            <li><a href="#610-已知问题">6.10 已知问题</a></li>
          </ul>
        </li>
        <li><a href="#配置文件和启动参数说明">。、配置文件和启动参数说明</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX"></h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="/" title="Author" rel=" author" class="author">yanghx</a>
                </span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="0001-01-01">0001-01-01</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="0001-01-01">0001-01-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 12202 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 25 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#ectd-集群搭建">Ectd 集群搭建</a></li>
        <li><a href="#一ectd-集群搭建">一、Ectd 集群搭建</a>
          <ul>
            <li><a href="#11-概述">1.1 概述</a></li>
            <li><a href="#12-state">1.2 State</a></li>
            <li><a href="#13-tls">1.3 TLS</a></li>
            <li><a href="#14-自动证书">1.4 自动证书</a></li>
            <li><a href="#15-发现-discovery">1.5 发现 （Discovery）</a>
              <ul>
                <li><a href="#151-etcd-发现">1.5.1 etcd 发现</a></li>
                <li><a href="#152-发现-url-的生命周期">1.5.2 发现 URL 的生命周期</a></li>
                <li><a href="#153-自定义-etcd-发现服务">1.5.3 自定义 etcd 发现服务</a></li>
                <li><a href="#154-公共-etcd-发现服务">1.5.4 公共 etcd 发现服务</a></li>
                <li><a href="#155-dns-发现">1.5.5 DNS 发现</a></li>
                <li><a href="#156-创建-dns-srv-记录">1.5.6 创建 DNS SRV 记录</a></li>
                <li><a href="#157-使用-dns-引导-etcd-集群">1.5.7 使用 DNS 引导 etcd 集群</a></li>
              </ul>
            </li>
            <li><a href="#16-mac-m1---etcd-集群搭建">1.6 MAC M1   ETCD 集群搭建</a>
              <ul>
                <li><a href="#161-创建etcd1sh">1.6.1 <strong>创建etcd1.sh</strong></a></li>
                <li><a href="#162-创建etcd2sh">1.6.2 <strong>创建etcd2.sh</strong></a></li>
                <li><a href="#163-创建etcd3sh">1.6.3 <strong>创建etcd3.sh</strong></a></li>
                <li><a href="#164-创建etcd_serversh用于启动其他三个脚本">1.6.4 <strong>创建etcd_server.sh</strong>，用于启动其他三个脚本</a></li>
                <li><a href="#165-创建客户端连接服务端命令">1.6.5 <strong>创建客户端连接服务端命令</strong></a></li>
                <li><a href="#166-结果如下表示etcd集群搭建成功">1.6.6 结果如下，表示ETCD集群搭建成功</a></li>
              </ul>
            </li>
            <li><a href="#17-如何访问etcd">1.7 如何访问etcd</a>
              <ul>
                <li><a href="#171-put-写命令">1.7.1 put 写命令：</a></li>
                <li><a href="#172-get-从etcd中读取">1.7.2 get 从etcd中读取：</a></li>
              </ul>
            </li>
            <li><a href="#18-如何通过前缀批量获取-keys">1.8 如何通过前缀批量获取 keys</a></li>
            <li><a href="#19-如何删除-keys">1.9 如何删除 keys</a></li>
            <li><a href="#110-如何在事务中进行多次写入">1.10 如何在事务中进行多次写入</a></li>
            <li><a href="#111-监控-keys">1.11 监控 keys</a></li>
            <li><a href="#112-设置过期时间-keys">1.12 设置过期时间 keys</a></li>
            <li><a href="#113-如何创建锁">1.13 如何创建锁</a></li>
            <li><a href="#114-etcd集群中如何进行leader选举">1.14 etcd集群中如何进行leader选举</a></li>
            <li><a href="#115-如何检查集群状态">1.15 如何检查集群状态</a></li>
            <li><a href="#116-如何保存数据库">1.16 如何保存数据库</a></li>
            <li><a href="#117-如何将-etcd-从-v2-迁移到-v3">1.17 如何将 etcd 从 v2 迁移到 v3</a></li>
            <li><a href="#118-如何添加和删除成员">1.18 如何添加和删除成员</a></li>
          </ul>
        </li>
        <li><a href="#二在容器中运行etcd">二、在容器中运行Etcd</a>
          <ul>
            <li><a href="#21-运行单节点-etcd">2.1 运行单节点 etcd</a></li>
            <li><a href="#22-运行-3-节点-etcd-集群">2.2 运行 3 节点 etcd 集群</a></li>
          </ul>
        </li>
        <li><a href="#三故障模式">三、故障模式</a>
          <ul>
            <li><a href="#31-minor-followers-failure">3.1 Minor followers failure</a></li>
            <li><a href="#32-leader-failure">3.2 Leader failure</a></li>
            <li><a href="#33-majority-failure">3.3 Majority failure</a></li>
            <li><a href="#34-网络分区">3.4 网络分区</a></li>
            <li><a href="#35-引导期间失败">3.5 引导期间失败</a></li>
          </ul>
        </li>
        <li><a href="#四灾难恢复">四、灾难恢复</a>
          <ul>
            <li><a href="#41-对键空间进行快照">4.1 对键空间进行快照</a></li>
            <li><a href="#42-恢复集群">4.2 恢复集群</a></li>
            <li><a href="#43-使用错误的-url-从成员错误重新配置中恢复集群">4.3 使用错误的 URL 从成员错误重新配置中恢复集群</a></li>
          </ul>
        </li>
        <li><a href="#五etcd-网关">五、etcd 网关</a>
          <ul>
            <li><a href="#51-什么是etcd网关">5.1 什么是etcd网关</a></li>
            <li><a href="#52-何时使用-etcd-网关">5.2 何时使用 etcd 网关</a></li>
            <li><a href="#53-何时不使用-etcd-网关">5.3 何时不使用 etcd 网关</a></li>
            <li><a href="#54-启动-etcd-网关">5.4 启动 etcd 网关</a></li>
            <li><a href="#55-配置标志">5.5 配置标志</a>
              <ul>
                <li><a href="#551-etcd-集群">5.5.1 etcd 集群</a></li>
                <li><a href="#端点">–端点</a></li>
                <li><a href="#--发现-srv">&ndash;发现-srv</a></li>
                <li><a href="#网络">网络</a></li>
                <li><a href="#--listen-addr">&ndash;listen-addr</a></li>
                <li><a href="#--重试延迟">&ndash;重试延迟</a></li>
                <li><a href="#安全">安全</a></li>
                <li><a href="#不安全的发现">–不安全的发现</a></li>
                <li><a href="#--trusted-ca-文件">&ndash;trusted-ca 文件</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#六grpc-代理">六、gRPC 代理</a>
          <ul>
            <li><a href="#61-可扩展的手表-api">6.1 可扩展的手表 API</a></li>
            <li><a href="#62-限制">6.2 限制</a></li>
            <li><a href="#63-可扩展的租赁-api">6.3 可扩展的租赁 API</a></li>
            <li><a href="#64-滥用客户保护">6.4 滥用客户保护</a></li>
            <li><a href="#65-启动-etcd-grpc-代理">6.5 启动 etcd gRPC 代理</a></li>
            <li><a href="#66-客户端端点同步和名称解析">6.6 客户端端点同步和名称解析</a></li>
            <li><a href="#67-命名空间">6.7 命名空间</a></li>
            <li><a href="#68-tls-终止">6.8 TLS 终止</a></li>
            <li><a href="#69-指标和健康">6.9 指标和健康</a></li>
            <li><a href="#610-已知问题">6.10 已知问题</a></li>
          </ul>
        </li>
        <li><a href="#配置文件和启动参数说明">。、配置文件和启动参数说明</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h3 id="ectd-集群搭建" class="headerLink">
    <a href="#ectd-%e9%9b%86%e7%be%a4%e6%90%ad%e5%bb%ba" class="header-mark"></a>Ectd 集群搭建</h3><p>引导etcd群集：静态、etcd发现和DNS发现</p>
<h3 id="一ectd-集群搭建" class="headerLink">
    <a href="#%e4%b8%80ectd-%e9%9b%86%e7%be%a4%e6%90%ad%e5%bb%ba" class="header-mark"></a>一、Ectd 集群搭建</h3><h4 id="11-概述" class="headerLink">
    <a href="#11-%e6%a6%82%e8%bf%b0" class="header-mark"></a>1.1 概述</h4><p>静态启动etcd集群需要集群中的每个成员都知道另一个成员。在许多情况下，集群成员的IP可能提前未知。在这些情况下，可以在发现服务的帮助下引导etcd集群。</p>
<p>一旦etcd集群启动并运行，就可以通过运行时重新配置来添加或删除成员。为了更好地理解<a href="https://etcd.io/docs/v3.5/op-guide/runtime-configuration/" target="_blank" rel="noopener noreferrer">运行时重新配置</a>背后的设计，我们建议阅读<a href="https://etcd.io/docs/v3.5/op-guide/runtime-reconf-design/" target="_blank" rel="noopener noreferrer">运行时配置设计文档</a></p>
<p>本指南将介绍以下3中引导etcd集群的机制：</p>
<ul>
<li><strong>Static</strong></li>
<li><strong>etcd Discovery</strong></li>
<li><strong>DNS Discovery</strong></li>
</ul>
<p>每个引导机制都将用于创建一个三机etcd集群，其中包含以下详细信息：</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Address</th>
<th>Hostname</th>
</tr>
</thead>
<tbody>
<tr>
<td>machine-1</td>
<td>127.0.0.1</td>
<td>machine0.example.com</td>
</tr>
<tr>
<td>machine-2</td>
<td>127.0.0.1</td>
<td>machine1.example.com</td>
</tr>
<tr>
<td>machine-3</td>
<td>127.0.0.1</td>
<td>machine2.example.com</td>
</tr>
</tbody>
</table>
<h4 id="12-state" class="headerLink">
    <a href="#12-state" class="header-mark"></a>1.2 State</h4><p>由于我们在启动之前知道集群成员、它们的地址和集群的大小，我们可以通过设置初始集群标志来使用离线引导配置。每台机器将获得以下环境变量或命令行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">&#34;etcd0=http://127.0.0.1:12380,etcd1=http://127.0.0.1:22380,etcd2=http://127.0.0.1:32380&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span>new
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">--initial-cluster <span class="nv">etcd0</span><span class="o">=</span>http://127.0.0.1:12380,etcd1<span class="o">=</span>http://127.0.0.1:22380,etcd2<span class="o">=</span>http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--initial-cluster-state new
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意，在初始集群中指定的URL是播发对等URL，即它们应该与<code>initial-advertise-peer-urls</code>(相应节点上的初始播发对等URL)的值匹配。</p>
<p>如果出于测试目的使用相同的配置启动多个集群（或创建和销毁单个集群），强烈建议为每个集群提供唯一的<code>initial-cluster-token</code>。通过这样做，即使集群具有完全相同的配置，etcd也可以为集群生成唯一的集群ID和成员ID。这可以保护etcd免受跨集群交互的影响，这可能会损坏集群</p>
<p>etcd 侦听<a href="https://etcd.io/docs/v3.5/op-guide/configuration/#member" target="_blank" rel="noopener noreferrer"><code>listen-client-urls</code></a>以接受客户端流量。etcd 成员将指定的 URL 通告<a href="https://etcd.io/docs/v3.5/op-guide/configuration/#clustering" target="_blank" rel="noopener noreferrer"><code>advertise-client-urls</code></a>给其他成员、代理、客户端。请确保<code>advertise-client-urls</code>目标客户可以访问它们。<code>advertise-client-urls</code>如果远程客户端应该访问 etcd，一个常见的错误是设置为 localhost 或将其保留为默认值。</p>
<p>在每台机器上，使用以下标志启动 etcd：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-0 --initial-advertise-peer-urls http://127.0.0.1:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:12379,http://127.0.0.1:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">etcd0</span><span class="o">=</span>http://127.0.0.1:12380,etcd1<span class="o">=</span>http://127.0.0.1:22380,etcd2<span class="o">=</span>http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state new
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-1 --initial-advertise-peer-urls http://127.0.0.1:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:22379,http://127.0.0.1:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">etcd0</span><span class="o">=</span>http://127.0.0.1:12380,etcd1<span class="o">=</span>http://127.0.0.1:22380,etcd2<span class="o">=</span>http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state new
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-2 --initial-advertise-peer-urls http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:32379,http://127.0.0.1:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">etcd0</span><span class="o">=</span>http://127.0.0.1:12380,etcd1<span class="o">=</span>http://127.0.0.1:22380,etcd2<span class="o">=</span>http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state new
</span></span></code></pre></td></tr></table>
</div>
</div><p>以 开头的命令行参数<code>--initial-cluster</code>将在 etcd 的后续运行中被忽略。在初始引导过程之后随意删除环境变量或命令行标志。如果稍后需要更改配置（例如，在集群中添加或删除成员），请参阅<a href="https://etcd.io/docs/v3.5/op-guide/runtime-configuration/" target="_blank" rel="noopener noreferrer">运行时配置</a>指南。</p>
<h4 id="13-tls" class="headerLink">
    <a href="#13-tls" class="header-mark"></a>1.3 TLS</h4><p>etcd 支持通过 TLS 协议进行加密通信。TLS 通道可用于对等点之间的加密内部集群通信以及加密的客户端流量。本节提供了使用对等和客户端 TLS 设置集群的示例。可以在<a href="https://etcd.io/docs/v3.5/op-guide/security/" target="_blank" rel="noopener noreferrer">安全指南</a>中找到详细说明 etcd 的 TLS 支持的其他信息。</p>
<p>在每台机器上，etcd 将使用以下标志启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-0 --initial-advertise-peer-urls http://127.0.0.1:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:12379,http://127.0.0.1:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">etcd0</span><span class="o">=</span>http://127.0.0.1:12380,etcd1<span class="o">=</span>http://127.0.0.1:22380,etcd2<span class="o">=</span>http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --client-cert-auth --trusted-ca-file<span class="o">=</span>/path/to/ca-client.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --cert-file<span class="o">=</span>/path/to/infra0-client.crt --key-file<span class="o">=</span>/path/to/infra0-client.key <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --peer-client-cert-auth --peer-trusted-ca-file<span class="o">=</span>ca-peer.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --peer-cert-file<span class="o">=</span>/path/to/infra0-peer.crt --peer-key-file<span class="o">=</span>/path/to/infra0-peer.key
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-0 --initial-advertise-peer-urls http://127.0.0.1:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:22379,http://127.0.0.1:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">etcd0</span><span class="o">=</span>http://127.0.0.1:12380,etcd1<span class="o">=</span>http://127.0.0.1:22380,etcd2<span class="o">=</span>http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --client-cert-auth --trusted-ca-file<span class="o">=</span>/path/to/ca-client.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --cert-file<span class="o">=</span>/path/to/infra0-client.crt --key-file<span class="o">=</span>/path/to/infra0-client.key <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --peer-client-cert-auth --peer-trusted-ca-file<span class="o">=</span>ca-peer.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --peer-cert-file<span class="o">=</span>/path/to/infra0-peer.crt --peer-key-file<span class="o">=</span>/path/to/infra0-peer.key
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-0 --initial-advertise-peer-urls http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:32379,http://127.0.0.1:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">etcd0</span><span class="o">=</span>http://127.0.0.1:12380,etcd1<span class="o">=</span>http://127.0.0.1:22380,etcd2<span class="o">=</span>http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --client-cert-auth --trusted-ca-file<span class="o">=</span>/path/to/ca-client.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --cert-file<span class="o">=</span>/path/to/infra0-client.crt --key-file<span class="o">=</span>/path/to/infra0-client.key <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --peer-client-cert-auth --peer-trusted-ca-file<span class="o">=</span>ca-peer.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --peer-cert-file<span class="o">=</span>/path/to/infra0-peer.crt --peer-key-file<span class="o">=</span>/path/to/infra0-peer.key
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="14-自动证书" class="headerLink">
    <a href="#14-%e8%87%aa%e5%8a%a8%e8%af%81%e4%b9%a6" class="header-mark"></a>1.4 自动证书</h4><p>如果集群需要加密通信但不需要经过身份验证的连接，则可以将 etcd 配置为自动生成其密钥。在初始化时，每个成员都会根据其公布的 IP 地址和主机创建自己的一组密钥。</p>
<p>在每台机器上，etcd 将使用以下标志启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-0 --initial-advertise-peer-urls http://127.0.0.1:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:12379,http://127.0.0.1:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">etcd0</span><span class="o">=</span>http://127.0.0.1:12380,etcd1<span class="o">=</span>http://127.0.0.1:22380,etcd2<span class="o">=</span>http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --auto-tls <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --peer-auto-tls
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-1 --initial-advertise-peer-urls http://127.0.0.1:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:22379,http://127.0.0.1:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">etcd0</span><span class="o">=</span>http://127.0.0.1:12380,etcd1<span class="o">=</span>http://127.0.0.1:22380,etcd2<span class="o">=</span>http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --auto-tls <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --peer-auto-tls
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-2 --initial-advertise-peer-urls http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:32379,http://127.0.0.1:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">etcd0</span><span class="o">=</span>http://127.0.0.1:12380,etcd1<span class="o">=</span>http://127.0.0.1:22380,etcd2<span class="o">=</span>http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --auto-tls <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --peer-auto-tls
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="15-发现-discovery" class="headerLink">
    <a href="#15-%e5%8f%91%e7%8e%b0-discovery" class="header-mark"></a>1.5 发现 （Discovery）</h4><p>在许多情况下，可能无法提前知道集群对等方的 IP。这在使用云提供商或网络使用 DHCP 时很常见。在这些情况下，不要指定静态配置，而是使用现有的 etcd 集群来引导一个新的。这个过程称为“发现”。</p>
<p>有两种方法可用于发现：</p>
<ul>
<li>etcd 发现服务</li>
<li>DNS SRV 记录</li>
</ul>
<h5 id="151-etcd-发现" class="headerLink">
    <a href="#151-etcd-%e5%8f%91%e7%8e%b0" class="header-mark"></a>1.5.1 etcd 发现</h5><p>为了更好地理解发现服务协议的设计，我们建议阅读发现服务协议<a href="https://etcd.io/docs/v3.5/dev-internal/discovery_protocol/" target="_blank" rel="noopener noreferrer">文档</a>。</p>
<h5 id="152-发现-url-的生命周期" class="headerLink">
    <a href="#152-%e5%8f%91%e7%8e%b0-url-%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" class="header-mark"></a>1.5.2 发现 URL 的生命周期</h5><p>一个发现 URL 标识一个唯一的 etcd 集群。每个 etcd 实例都共享一个新的发现 URL 来引导新集群，而不是重用现有的发现 URL。</p>
<p>此外，发现 URL 应仅用于集群的初始引导。要在集群已经运行后更改集群成员资格，请参阅<a href="https://etcd.io/docs/v3.5/op-guide/runtime-configuration/" target="_blank" rel="noopener noreferrer">运行时重新配置</a>指南。</p>
<h5 id="153-自定义-etcd-发现服务" class="headerLink">
    <a href="#153-%e8%87%aa%e5%ae%9a%e4%b9%89-etcd-%e5%8f%91%e7%8e%b0%e6%9c%8d%e5%8a%a1" class="header-mark"></a>1.5.3 自定义 etcd 发现服务</h5><p>Discovery 使用现有集群来引导自身。如果使用私有 etcd 集群，请创建如下 URL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl -X PUT https://myetcd.local/v2/keys/discovery/6c007a14875d53d9bf0ef5a6fc0257c817f0fb83/_config/size -d <span class="nv">value</span><span class="o">=</span><span class="m">3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过将大小键设置为 URL，将创建一个预期集群大小为 3 的发现 URL。</p>
<p>在这种情况下使用的 URL 将是<code>https://myetcd.local/v2/keys/discovery/6c007a14875d53d9bf0ef5a6fc0257c817f0fb83</code>，并且 etcd 成员将在<code>https://myetcd.local/v2/keys/discovery/6c007a14875d53d9bf0ef5a6fc0257c817f0fb83</code>开始时使用该目录进行注册。</p>
<p><strong>每个成员必须指定不同的名称标志。<code>Hostname</code>或者<code>machine-id</code>可以是一个不错的选择。否则发现会因名称重复而失败。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-0 --initial-advertise-peer-urls http://127.0.0.1:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:12379,http://127.0.0.1:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> --discovery https://myetcd.local/v2/keys/discovery/6c007a14875d53d9bf0ef5a6fc0257c817f0fb83
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-1 --initial-advertise-peer-urls http://127.0.0.1:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:22379,http://127.0.0.1:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--discovery https://myetcd.local/v2/keys/discovery/6c007a14875d53d9bf0ef5a6fc0257c817f0fb83
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-2 --initial-advertise-peer-urls http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:32379,http://127.0.0.1:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--discovery https://myetcd.local/v2/keys/discovery/6c007a14875d53d9bf0ef5a6fc0257c817f0fb83
</span></span></code></pre></td></tr></table>
</div>
</div><p>这将导致每个成员向自定义 etcd 发现服务注册自己，并在所有机器都注册后启动集群。</p>
<h5 id="154-公共-etcd-发现服务" class="headerLink">
    <a href="#154-%e5%85%ac%e5%85%b1-etcd-%e5%8f%91%e7%8e%b0%e6%9c%8d%e5%8a%a1" class="header-mark"></a>1.5.4 公共 etcd 发现服务</h5><p>如果没有可用的现有集群，请使用托管在 的公共发现服务<code>discovery.etcd.io</code>。要使用“新”端点创建私有发现 URL，请使用以下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl https://discovery.etcd.io/new?size<span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">https://discovery.etcd.io/3e86b59982e49066c5d813af1c2e2579cbf573de
</span></span></code></pre></td></tr></table>
</div>
</div><p>这将创建初始大小为 3 个成员的集群。如果未指定大小，则使用默认值 3。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">ETCD_DISCOVERY</span><span class="o">=</span>https://discovery.etcd.io/3e86b59982e49066c5d813af1c2e2579cbf573de
</span></span><span class="line"><span class="cl">--discovery https://discovery.etcd.io/3e86b59982e49066c5d813af1c2e2579cbf573de
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>每个成员必须指定不同的名称标志，否则发现将由于名称重复而失败。<code>Hostname</code>或者<code>machine-id</code>可以是一个不错的选择。</strong></p>
<p>现在我们使用每个成员的相关标志启动 etcd：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-0 --initial-advertise-peer-urls http://127.0.0.1:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:12379,http://127.0.0.1:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--discovery https://discovery.etcd.io/3e86b59982e49066c5d813af1c2e2579cbf573de
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-1 --initial-advertise-peer-urls http://127.0.0.1:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:22379,http://127.0.0.1:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--discovery https://discovery.etcd.io/3e86b59982e49066c5d813af1c2e2579cbf573de
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd --name machine-2 --initial-advertise-peer-urls http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://127.0.0.1:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://127.0.0.1:32379,http://127.0.0.1:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://127.0.0.1:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--discovery https://discovery.etcd.io/3e86b59982e49066c5d813af1c2e2579cbf573de
</span></span></code></pre></td></tr></table>
</div>
</div><p>这将导致每个成员向发现服务注册自己，并在所有成员都注册后启动集群。</p>
<p>使用环境变量<code>ETCD_DISCOVERY_PROXY</code>使 etcd 使用 HTTP 代理连接到发现服务。</p>
<h5 id="155-dns-发现" class="headerLink">
    <a href="#155-dns-%e5%8f%91%e7%8e%b0" class="header-mark"></a>1.5.5 DNS 发现</h5><p>DNS <a href="http://www.ietf.org/rfc/rfc2052.txt" target="_blank" rel="noopener noreferrer">SRV 记录</a>可用作发现机制。该<code>--discovery-srv</code>标志可用于设置可以找到发现 SRV 记录的 DNS 域名。设置<code>--discovery-srv example.com</code>会导致按列出的顺序查找 DNS SRV 记录：</p>
<ul>
<li>_etcd-server-ssl._tcp.example.com</li>
<li>_etcd-server._tcp.example.com</li>
</ul>
<p>如果<code>_etcd-server-ssl._tcp.example.com</code>找到，则 etcd 将尝试通过 TLS 进行引导过程。</p>
<p>为了帮助客户端发现 etcd 集群，按照列出的顺序查找以下 DNS SRV 记录：</p>
<ul>
<li>_etcd-client._tcp.example.com</li>
<li>_etcd-client-ssl._tcp.example.com</li>
</ul>
<p>如果<code>_etcd-client-ssl._tcp.example.com</code>找到，客户端将尝试通过 SSL/TLS 与 etcd 集群通信。</p>
<p>如果 etcd 使用 TLS，则发现 SRV 记录（例如<code>example.com</code>）必须与主机名一起包含在 SSL 证书 DNS SAN 中，否则集群将失败并显示如下日志消息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span> rejected connection from <span class="s2">&#34;10.0.1.11:53162&#34;</span> <span class="o">(</span>error <span class="s2">&#34;remote error: tls: bad certificate&#34;</span>, ServerName <span class="s2">&#34;example.com&#34;</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果 etcd 在没有自定义证书授权的情况下使用 TLS，则发现域（例如，example.com）必须与 SRV 记录域（例如，infra1.example.com）匹配。这是为了减轻伪造 SRV 记录以指向不同域的攻击；该域将具有 PKI 下的有效证书，但由未知的第三方控制。</p>
<p>该<code>-discovery-srv-name</code>标志还为在发现期间查询的 SRV 名称配置了后缀。使用此标志来区分同一域下的多个 etcd 集群。例如，如果设置了<code>discovery-srv=example.com</code>和，<code>-discovery-srv-name=foo</code>则会进行以下 DNS SRV 查询：</p>
<ul>
<li>_etcd-server-ssl-foo._tcp.example.com</li>
<li>_etcd-server-foo._tcp.example.com</li>
</ul>
<h5 id="156-创建-dns-srv-记录" class="headerLink">
    <a href="#156-%e5%88%9b%e5%bb%ba-dns-srv-%e8%ae%b0%e5%bd%95" class="header-mark"></a>1.5.6 创建 DNS SRV 记录</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ dig +noall +answer SRV _etcd-server._tcp.example.com
</span></span><span class="line"><span class="cl">_etcd-server._tcp.example.com. 300 IN  SRV  0 0 2380 infra0.example.com.
</span></span><span class="line"><span class="cl">_etcd-server._tcp.example.com. 300 IN  SRV  0 0 2380 infra1.example.com.
</span></span><span class="line"><span class="cl">_etcd-server._tcp.example.com. 300 IN  SRV  0 0 2380 infra2.example.com.
</span></span><span class="line"><span class="cl">$ dig +noall +answer SRV _etcd-client._tcp.example.com
</span></span><span class="line"><span class="cl">_etcd-client._tcp.example.com. 300 IN SRV 0 0 2379 infra0.example.com.
</span></span><span class="line"><span class="cl">_etcd-client._tcp.example.com. 300 IN SRV 0 0 2379 infra1.example.com.
</span></span><span class="line"><span class="cl">_etcd-client._tcp.example.com. 300 IN SRV 0 0 2379 infra2.example.com.
</span></span><span class="line"><span class="cl">$ dig +noall +answer infra0.example.com infra1.example.com infra2.example.com
</span></span><span class="line"><span class="cl">infra0.example.com.  300  IN  A  10.0.1.10
</span></span><span class="line"><span class="cl">infra1.example.com.  300  IN  A  10.0.1.11
</span></span><span class="line"><span class="cl">infra2.example.com.  300  IN  A  10.0.1.12
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="157-使用-dns-引导-etcd-集群" class="headerLink">
    <a href="#157-%e4%bd%bf%e7%94%a8-dns-%e5%bc%95%e5%af%bc-etcd-%e9%9b%86%e7%be%a4" class="header-mark"></a>1.5.7 使用 DNS 引导 etcd 集群</h5><p>etcd 集群成员可以发布域名或 IP 地址，引导过程将解析 DNS A 记录。从 3.2（3.1 打印警告）开始<code>--listen-peer-urls</code>，<code>--listen-client-urls</code>将拒绝网络接口绑定的域名。</p>
<p>中的已解析地址<code>--initial-advertise-peer-urls</code> <em>必须与</em>SRV 目标中的已解析地址之一匹配。etcd 成员读取解析后的地址，以确定它是否属于 SRV 记录中定义的集群。</p>
<h4 id="16-mac-m1---etcd-集群搭建" class="headerLink">
    <a href="#16-mac-m1---etcd-%e9%9b%86%e7%be%a4%e6%90%ad%e5%bb%ba" class="header-mark"></a>1.6 MAC M1   ETCD 集群搭建</h4><h5 id="161-创建etcd1sh" class="headerLink">
    <a href="#161-%e5%88%9b%e5%bb%baetcd1sh" class="header-mark"></a>1.6.1 <strong>创建etcd1.sh</strong></h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">TOKEN</span><span class="o">=</span>token-01
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
</span></span><span class="line"><span class="cl"><span class="nv">NAME_1</span><span class="o">=</span>machine-1
</span></span><span class="line"><span class="cl"><span class="nv">NAME_2</span><span class="o">=</span>machine-2
</span></span><span class="line"><span class="cl"><span class="nv">NAME_3</span><span class="o">=</span>machine-3
</span></span><span class="line"><span class="cl"><span class="nv">HOST_1</span><span class="o">=</span>127.0.0.1
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_1</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>:12380,<span class="si">${</span><span class="nv">NAME_2</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>:22380,<span class="si">${</span><span class="nv">NAME_3</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>:32380
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For machine 1</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_1</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_IP</span><span class="o">=</span><span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">etcd --data-dir<span class="o">=</span>/var/lib/etcd1/data.etcd --name <span class="si">${</span><span class="nv">THIS_NAME</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:12380 --listen-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:12380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--advertise-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:12379 --listen-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:12379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-state <span class="si">${</span><span class="nv">CLUSTER_STATE</span><span class="si">}</span> --initial-cluster-token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="162-创建etcd2sh" class="headerLink">
    <a href="#162-%e5%88%9b%e5%bb%baetcd2sh" class="header-mark"></a>1.6.2 <strong>创建etcd2.sh</strong></h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">TOKEN</span><span class="o">=</span>token-01
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
</span></span><span class="line"><span class="cl"><span class="nv">NAME_1</span><span class="o">=</span>machine-1
</span></span><span class="line"><span class="cl"><span class="nv">NAME_2</span><span class="o">=</span>machine-2
</span></span><span class="line"><span class="cl"><span class="nv">NAME_3</span><span class="o">=</span>machine-3
</span></span><span class="line"><span class="cl"><span class="nv">HOST_2</span><span class="o">=</span>127.0.0.1
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_1</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>:12380,<span class="si">${</span><span class="nv">NAME_2</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>:22380,<span class="si">${</span><span class="nv">NAME_3</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>:32380
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">THIS_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_2</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_IP</span><span class="o">=</span><span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">etcd --data-dir<span class="o">=</span>/var/lib/etcd2/data.etcd  --name <span class="si">${</span><span class="nv">THIS_NAME</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:22380 --listen-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:22380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--advertise-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:22379 --listen-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:22379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-state <span class="si">${</span><span class="nv">CLUSTER_STATE</span><span class="si">}</span> --initial-cluster-token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="163-创建etcd3sh" class="headerLink">
    <a href="#163-%e5%88%9b%e5%bb%baetcd3sh" class="header-mark"></a>1.6.3 <strong>创建etcd3.sh</strong></h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">TOKEN</span><span class="o">=</span>token-01
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
</span></span><span class="line"><span class="cl"><span class="nv">NAME_1</span><span class="o">=</span>machine-1
</span></span><span class="line"><span class="cl"><span class="nv">NAME_2</span><span class="o">=</span>machine-2
</span></span><span class="line"><span class="cl"><span class="nv">NAME_3</span><span class="o">=</span>machine-3
</span></span><span class="line"><span class="cl"><span class="nv">HOST_3</span><span class="o">=</span>127.0.0.1
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_1</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_3</span><span class="si">}</span>:12380,<span class="si">${</span><span class="nv">NAME_2</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_3</span><span class="si">}</span>:22380,<span class="si">${</span><span class="nv">NAME_3</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_3</span><span class="si">}</span>:32380
</span></span><span class="line"><span class="cl"><span class="c1"># For machine 3</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_3</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_IP</span><span class="o">=</span><span class="si">${</span><span class="nv">HOST_3</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">etcd --data-dir<span class="o">=</span>/var/lib/etcd3/data.etcd  --name <span class="si">${</span><span class="nv">THIS_NAME</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:32380 --listen-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:32380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--advertise-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:32379 --listen-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:32379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-state <span class="si">${</span><span class="nv">CLUSTER_STATE</span><span class="si">}</span> --initial-cluster-token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="164-创建etcd_serversh用于启动其他三个脚本" class="headerLink">
    <a href="#164-%e5%88%9b%e5%bb%baetcd_serversh%e7%94%a8%e4%ba%8e%e5%90%af%e5%8a%a8%e5%85%b6%e4%bb%96%e4%b8%89%e4%b8%aa%e8%84%9a%e6%9c%ac" class="header-mark"></a>1.6.4 <strong>创建etcd_server.sh</strong>，用于启动其他三个脚本</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">open -a Terminal.app /Users/yooome/etcd/etcd1.sh
</span></span><span class="line"><span class="cl">open -a Terminal.app /Users/yooome/etcd/etcd2.sh
</span></span><span class="line"><span class="cl">open -a Terminal.app /Users/yooome/etcd/etcd3.sh
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="165-创建客户端连接服务端命令" class="headerLink">
    <a href="#165-%e5%88%9b%e5%bb%ba%e5%ae%a2%e6%88%b7%e7%ab%af%e8%bf%9e%e6%8e%a5%e6%9c%8d%e5%8a%a1%e7%ab%af%e5%91%bd%e4%bb%a4" class="header-mark"></a>1.6.5 <strong>创建客户端连接服务端命令</strong></h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="nv">HOST_1</span><span class="o">=</span>127.0.0.1
</span></span><span class="line"><span class="cl"><span class="nv">HOST_2</span><span class="o">=</span>127.0.0.1
</span></span><span class="line"><span class="cl"><span class="nv">HOST_3</span><span class="o">=</span>127.0.0.1
</span></span><span class="line"><span class="cl"><span class="nv">ENDPOINTS</span><span class="o">=</span><span class="nv">$HOST_1</span>:12379,<span class="nv">$HOST_2</span>:22379,<span class="nv">$HOST_3</span>:32379
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> member list -w table
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="166-结果如下表示etcd集群搭建成功" class="headerLink">
    <a href="#166-%e7%bb%93%e6%9e%9c%e5%a6%82%e4%b8%8b%e8%a1%a8%e7%a4%baetcd%e9%9b%86%e7%be%a4%e6%90%ad%e5%bb%ba%e6%88%90%e5%8a%9f" class="header-mark"></a>1.6.6 结果如下，表示ETCD集群搭建成功</h5><p><a class="lightgallery" href="../../../../../../TEMP/golang/etcd%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b/images/1.png" title="1" data-thumbnail="../../../../../../TEMP/golang/etcd详细教程/images/1.png">
        <img
            
            loading="lazy"
            src="../../../../../../TEMP/golang/etcd%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b/images/1.png"
            srcset="../../../../../../TEMP/golang/etcd%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b/images/1.png, ../../../../../../TEMP/golang/etcd%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b/images/1.png 1.5x, ../../../../../../TEMP/golang/etcd%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b/images/1.png 2x"
            sizes="auto"
            alt="../../../../../../TEMP/golang/etcd详细教程/images/1.png">
    </a></p>
<h4 id="17-如何访问etcd" class="headerLink">
    <a href="#17-%e5%a6%82%e4%bd%95%e8%ae%bf%e9%97%aeetcd" class="header-mark"></a>1.7 如何访问etcd</h4><h5 id="171-put-写命令" class="headerLink">
    <a href="#171-put-%e5%86%99%e5%91%bd%e4%bb%a4" class="header-mark"></a>1.7.1 put 写命令：</h5><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/02_etcdctl_access_etcd_2016051001.png" title="02_etcdctl_access_etcd_2016051001" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/02_etcdctl_access_etcd_2016051001.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/02_etcdctl_access_etcd_2016051001.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/02_etcdctl_access_etcd_2016051001.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/02_etcdctl_access_etcd_2016051001.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/02_etcdctl_access_etcd_2016051001.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/02_etcdctl_access_etcd_2016051001.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put foo <span class="s2">&#34;Hello World!&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="172-get-从etcd中读取" class="headerLink">
    <a href="#172-get-%e4%bb%8eetcd%e4%b8%ad%e8%af%bb%e5%8f%96" class="header-mark"></a>1.7.2 get 从etcd中读取：</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> get foo
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> --write-out<span class="o">=</span><span class="s2">&#34;json&#34;</span> get foo
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="18-如何通过前缀批量获取-keys" class="headerLink">
    <a href="#18-%e5%a6%82%e4%bd%95%e9%80%9a%e8%bf%87%e5%89%8d%e7%bc%80%e6%89%b9%e9%87%8f%e8%8e%b7%e5%8f%96-keys" class="header-mark"></a>1.8 如何通过前缀批量获取 keys</h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/03_etcdctl_get_by_prefix_2016050501.png" title="03_etcdctl_get_by_prefix_2016050501" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/03_etcdctl_get_by_prefix_2016050501.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/03_etcdctl_get_by_prefix_2016050501.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/03_etcdctl_get_by_prefix_2016050501.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/03_etcdctl_get_by_prefix_2016050501.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/03_etcdctl_get_by_prefix_2016050501.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/03_etcdctl_get_by_prefix_2016050501.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put web1 value1
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put web2 value2
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put web3 value3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> get web --prefix
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="19-如何删除-keys" class="headerLink">
    <a href="#19-%e5%a6%82%e4%bd%95%e5%88%a0%e9%99%a4-keys" class="header-mark"></a>1.9 如何删除 keys</h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/04_etcdctl_delete_2016050601.png" title="04_etcdctl_delete_2016050601" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/04_etcdctl_delete_2016050601.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/04_etcdctl_delete_2016050601.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/04_etcdctl_delete_2016050601.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/04_etcdctl_delete_2016050601.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/04_etcdctl_delete_2016050601.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/04_etcdctl_delete_2016050601.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put key myvalue
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> del key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put k1 value1
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put k2 value2
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> del k --prefix
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="110-如何在事务中进行多次写入" class="headerLink">
    <a href="#110-%e5%a6%82%e4%bd%95%e5%9c%a8%e4%ba%8b%e5%8a%a1%e4%b8%ad%e8%bf%9b%e8%a1%8c%e5%a4%9a%e6%ac%a1%e5%86%99%e5%85%a5" class="header-mark"></a>1.10 如何在事务中进行多次写入</h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/05_etcdctl_transaction_2016050501.png" title="05_etcdctl_transaction_2016050501" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/05_etcdctl_transaction_2016050501.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/05_etcdctl_transaction_2016050501.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/05_etcdctl_transaction_2016050501.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/05_etcdctl_transaction_2016050501.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/05_etcdctl_transaction_2016050501.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/05_etcdctl_transaction_2016050501.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"></code></pre></td></tr></table>
</div>
</div><h4 id="111-监控-keys" class="headerLink">
    <a href="#111-%e7%9b%91%e6%8e%a7-keys" class="header-mark"></a>1.11 监控 keys</h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/06_etcdctl_watch_2016050501.png" title="06_etcdctl_watch_2016050501" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/06_etcdctl_watch_2016050501.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/06_etcdctl_watch_2016050501.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/06_etcdctl_watch_2016050501.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/06_etcdctl_watch_2016050501.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/06_etcdctl_watch_2016050501.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/06_etcdctl_watch_2016050501.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> watch stock1
</span></span><span class="line"><span class="cl"><span class="c1"># 新开一个窗口，然后输入该值，就会发现 前的面的窗口就会有相应的值改变。</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put stock1 <span class="m">1000</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 监控前缀为 stock 的 keys</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> watch stock --prefix
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put stock1 <span class="m">10</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put stock2 <span class="m">20</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="112-设置过期时间-keys" class="headerLink">
    <a href="#112-%e8%ae%be%e7%bd%ae%e8%bf%87%e6%9c%9f%e6%97%b6%e9%97%b4-keys" class="header-mark"></a>1.12 设置过期时间 keys</h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/07_etcdctl_lease_2016050501.png" title="07_etcdctl_lease_2016050501" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/07_etcdctl_lease_2016050501.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/07_etcdctl_lease_2016050501.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/07_etcdctl_lease_2016050501.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/07_etcdctl_lease_2016050501.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/07_etcdctl_lease_2016050501.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/07_etcdctl_lease_2016050501.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> lease grant <span class="m">300</span>
</span></span><span class="line"><span class="cl"><span class="c1"># lease 2be7547fbc6a5afa granted with TTL(300s)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 给当前的 key 设置过期时间</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> put sample value --lease<span class="o">=</span>2be7547fbc6a5afa
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> get sample
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> lease keep-alive 2be7547fbc6a5afa
</span></span><span class="line"><span class="cl"><span class="c1"># 取消过期时间</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> lease revoke 2be7547fbc6a5afa
</span></span><span class="line"><span class="cl"><span class="c1"># or after 300 seconds</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> get sample
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="113-如何创建锁" class="headerLink">
    <a href="#113-%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba%e9%94%81" class="header-mark"></a>1.13 如何创建锁</h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/08_etcdctl_lock_2016050501.png" title="08_etcdctl_lock_2016050501" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/08_etcdctl_lock_2016050501.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/08_etcdctl_lock_2016050501.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/08_etcdctl_lock_2016050501.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/08_etcdctl_lock_2016050501.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/08_etcdctl_lock_2016050501.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/08_etcdctl_lock_2016050501.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> lock mutex1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># another client with the same name blocks</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> lock mutex1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="114-etcd集群中如何进行leader选举" class="headerLink">
    <a href="#114-etcd%e9%9b%86%e7%be%a4%e4%b8%ad%e5%a6%82%e4%bd%95%e8%bf%9b%e8%a1%8cleader%e9%80%89%e4%b8%be" class="header-mark"></a>1.14 etcd集群中如何进行leader选举</h4><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/09_etcdctl_elect_2016050501.png" title="09_etcdctl_elect_2016050501" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/09_etcdctl_elect_2016050501.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/09_etcdctl_elect_2016050501.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/09_etcdctl_elect_2016050501.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/09_etcdctl_elect_2016050501.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/09_etcdctl_elect_2016050501.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/09_etcdctl_elect_2016050501.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> elect one p1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># another client with the same name blocks</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> elect one p2
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="115-如何检查集群状态" class="headerLink">
    <a href="#115-%e5%a6%82%e4%bd%95%e6%a3%80%e6%9f%a5%e9%9b%86%e7%be%a4%e7%8a%b6%e6%80%81" class="header-mark"></a>1.15 如何检查集群状态</h4><p>检查 etcd 集群状态的指南</p>
<p>为每台机器指定初始集群配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl --write-out<span class="o">=</span>table --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> endpoint status
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/5.png" title="5" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/5.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/5.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/5.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/5.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/5.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/5.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yooome@192 etcd % etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> endpoint health
</span></span><span class="line"><span class="cl">127.0.0.1:12379 is healthy: successfully committed proposal: <span class="nv">took</span> <span class="o">=</span> 2.374209ms
</span></span><span class="line"><span class="cl">127.0.0.1:32379 is healthy: successfully committed proposal: <span class="nv">took</span> <span class="o">=</span> 2.496333ms
</span></span><span class="line"><span class="cl">127.0.0.1:22379 is healthy: successfully committed proposal: <span class="nv">took</span> <span class="o">=</span> 2.452208ms
</span></span><span class="line"><span class="cl">yooome@192 etcd % 
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="116-如何保存数据库" class="headerLink">
    <a href="#116-%e5%a6%82%e4%bd%95%e4%bf%9d%e5%ad%98%e6%95%b0%e6%8d%ae%e5%ba%93" class="header-mark"></a>1.16 如何保存数据库</h4><p>获取 etcd 数据库快照的指南</p>
<p><code>snapshot</code>保存 etcd 数据库的时间点快照：</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/11_etcdctl_snapshot_2016051001.png" title="11_etcdctl_snapshot_2016051001" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/11_etcdctl_snapshot_2016051001.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/11_etcdctl_snapshot_2016051001.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/11_etcdctl_snapshot_2016051001.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/11_etcdctl_snapshot_2016051001.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/11_etcdctl_snapshot_2016051001.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/11_etcdctl_snapshot_2016051001.png">
    </a></p>
<p>快照只能从一个 etcd 节点请求，因此<code>--endpoints</code>flag 应该只包含一个端点。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">ENDPOINTS</span><span class="o">=</span><span class="nv">$HOST_1</span>:2379
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> snapshot save my.db
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Snapshot saved at my.db
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="117-如何将-etcd-从-v2-迁移到-v3" class="headerLink">
    <a href="#117-%e5%a6%82%e4%bd%95%e5%b0%86-etcd-%e4%bb%8e-v2-%e8%bf%81%e7%a7%bb%e5%88%b0-v3" class="header-mark"></a>1.17 如何将 etcd 从 v2 迁移到 v3</h4><p><code>migrate</code>将 etcd v2 转换为 v3 数据：</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/12_etcdctl_migrate_2016061602.png" title="12_etcdctl_migrate_2016061602" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/12_etcdctl_migrate_2016061602.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/12_etcdctl_migrate_2016061602.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/12_etcdctl_migrate_2016061602.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/12_etcdctl_migrate_2016061602.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/12_etcdctl_migrate_2016061602.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/12_etcdctl_migrate_2016061602.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># write key in etcd version 2 store</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span>http://<span class="nv">$ENDPOINT</span> <span class="nb">set</span> foo bar
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># read key in etcd v2</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> --output<span class="o">=</span><span class="s2">&#34;json&#34;</span> get foo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># stop etcd node to migrate, one by one</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># migrate v2 data</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINT</span> migrate --data-dir<span class="o">=</span><span class="s2">&#34;default.etcd&#34;</span> --wal-dir<span class="o">=</span><span class="s2">&#34;default.etcd/member/wal&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># restart etcd node after migrate, one by one</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># confirm that the key got migrated</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="nv">$ENDPOINTS</span> get /foo
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="118-如何添加和删除成员" class="headerLink">
    <a href="#118-%e5%a6%82%e4%bd%95%e6%b7%bb%e5%8a%a0%e5%92%8c%e5%88%a0%e9%99%a4%e6%88%90%e5%91%98" class="header-mark"></a>1.18 如何添加和删除成员</h4><p><code>member</code>添加、删除、更新成员资格：</p>
<p><a class="lightgallery" href="https://blog-1257196793.cos.ap-beijing.myqcloud.com/13_etcdctl_member_2016062301.png" title="13_etcdctl_member_2016062301" data-thumbnail="https://blog-1257196793.cos.ap-beijing.myqcloud.com/13_etcdctl_member_2016062301.png">
        <img
            
            loading="lazy"
            src="https://blog-1257196793.cos.ap-beijing.myqcloud.com/13_etcdctl_member_2016062301.png"
            srcset="https://blog-1257196793.cos.ap-beijing.myqcloud.com/13_etcdctl_member_2016062301.png, https://blog-1257196793.cos.ap-beijing.myqcloud.com/13_etcdctl_member_2016062301.png 1.5x, https://blog-1257196793.cos.ap-beijing.myqcloud.com/13_etcdctl_member_2016062301.png 2x"
            sizes="auto"
            alt="https://blog-1257196793.cos.ap-beijing.myqcloud.com/13_etcdctl_member_2016062301.png">
    </a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># For each machine</span>
</span></span><span class="line"><span class="cl"><span class="nv">TOKEN</span><span class="o">=</span>my-etcd-token-1
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
</span></span><span class="line"><span class="cl"><span class="nv">NAME_1</span><span class="o">=</span>etcd-node-1
</span></span><span class="line"><span class="cl"><span class="nv">NAME_2</span><span class="o">=</span>etcd-node-2
</span></span><span class="line"><span class="cl"><span class="nv">NAME_3</span><span class="o">=</span>etcd-node-3
</span></span><span class="line"><span class="cl"><span class="nv">HOST_1</span><span class="o">=</span>10.240.0.13
</span></span><span class="line"><span class="cl"><span class="nv">HOST_2</span><span class="o">=</span>10.240.0.14
</span></span><span class="line"><span class="cl"><span class="nv">HOST_3</span><span class="o">=</span>10.240.0.15
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_1</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>:2380,<span class="si">${</span><span class="nv">NAME_2</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>:2380,<span class="si">${</span><span class="nv">NAME_3</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_3</span><span class="si">}</span>:2380
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For node 1</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_1</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_IP</span><span class="o">=</span><span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">etcd --data-dir<span class="o">=</span>data.etcd --name <span class="si">${</span><span class="nv">THIS_NAME</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--listen-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--advertise-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--listen-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-state <span class="si">${</span><span class="nv">CLUSTER_STATE</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For node 2</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_2</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_IP</span><span class="o">=</span><span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">etcd --data-dir<span class="o">=</span>data.etcd --name <span class="si">${</span><span class="nv">THIS_NAME</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--listen-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--advertise-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--listen-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-state <span class="si">${</span><span class="nv">CLUSTER_STATE</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For node 3</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_3</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_IP</span><span class="o">=</span><span class="si">${</span><span class="nv">HOST_3</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">etcd --data-dir<span class="o">=</span>data.etcd --name <span class="si">${</span><span class="nv">THIS_NAME</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--listen-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--advertise-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--listen-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-state <span class="si">${</span><span class="nv">CLUSTER_STATE</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>member remove</code>然后用和<code>member add</code>命令替换一个成员：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># get member ID</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="nv">HOST_1</span><span class="o">=</span>10.240.0.13
</span></span><span class="line"><span class="cl"><span class="nv">HOST_2</span><span class="o">=</span>10.240.0.14
</span></span><span class="line"><span class="cl"><span class="nv">HOST_3</span><span class="o">=</span>10.240.0.15
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>:2379,<span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>:2379,<span class="si">${</span><span class="nv">HOST_3</span><span class="si">}</span>:2379 member list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># remove the member</span>
</span></span><span class="line"><span class="cl"><span class="nv">MEMBER_ID</span><span class="o">=</span>278c654c9a6dfd3b
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>:2379,<span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>:2379,<span class="si">${</span><span class="nv">HOST_3</span><span class="si">}</span>:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	member remove <span class="si">${</span><span class="nv">MEMBER_ID</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># add a new member (node 4)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="nv">NAME_1</span><span class="o">=</span>etcd-node-1
</span></span><span class="line"><span class="cl"><span class="nv">NAME_2</span><span class="o">=</span>etcd-node-2
</span></span><span class="line"><span class="cl"><span class="nv">NAME_4</span><span class="o">=</span>etcd-node-4
</span></span><span class="line"><span class="cl"><span class="nv">HOST_1</span><span class="o">=</span>10.240.0.13
</span></span><span class="line"><span class="cl"><span class="nv">HOST_2</span><span class="o">=</span>10.240.0.14
</span></span><span class="line"><span class="cl"><span class="nv">HOST_4</span><span class="o">=</span>10.240.0.16 <span class="c1"># new member</span>
</span></span><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span><span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>:2379,<span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	member add <span class="si">${</span><span class="nv">NAME_4</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--peer-urls<span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_4</span><span class="si">}</span>:2380
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>--initial-cluster-state existing</code>接下来，使用标志启动新成员：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># [WARNING] If the new member starts from the same disk space,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># make sure to remove the data directory of the old member</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># restart with &#39;existing&#39; flag</span>
</span></span><span class="line"><span class="cl"><span class="nv">TOKEN</span><span class="o">=</span>my-etcd-token-1
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_STATE</span><span class="o">=</span>existing
</span></span><span class="line"><span class="cl"><span class="nv">NAME_1</span><span class="o">=</span>etcd-node-1
</span></span><span class="line"><span class="cl"><span class="nv">NAME_2</span><span class="o">=</span>etcd-node-2
</span></span><span class="line"><span class="cl"><span class="nv">NAME_4</span><span class="o">=</span>etcd-node-4
</span></span><span class="line"><span class="cl"><span class="nv">HOST_1</span><span class="o">=</span>10.240.0.13
</span></span><span class="line"><span class="cl"><span class="nv">HOST_2</span><span class="o">=</span>10.240.0.14
</span></span><span class="line"><span class="cl"><span class="nv">HOST_4</span><span class="o">=</span>10.240.0.16 <span class="c1"># new member</span>
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_1</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>:2380,<span class="si">${</span><span class="nv">NAME_2</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>:2380,<span class="si">${</span><span class="nv">NAME_4</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_4</span><span class="si">}</span>:2380
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">THIS_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_4</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_IP</span><span class="o">=</span><span class="si">${</span><span class="nv">HOST_4</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">etcd --data-dir<span class="o">=</span>data.etcd --name <span class="si">${</span><span class="nv">THIS_NAME</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--listen-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--advertise-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--listen-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-state <span class="si">${</span><span class="nv">CLUSTER_STATE</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--initial-cluster-token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="二在容器中运行etcd" class="headerLink">
    <a href="#%e4%ba%8c%e5%9c%a8%e5%ae%b9%e5%99%a8%e4%b8%ad%e8%bf%90%e8%a1%8cetcd" class="header-mark"></a>二、在容器中运行Etcd</h3><p>为了向 Docker 主机之外的客户端公开 etcd API，请使用容器的主机 IP 地址。<a href="https://docs.docker.com/engine/reference/commandline/inspect" target="_blank" rel="noopener noreferrer"><code>docker inspect</code></a>有关如何获取 IP 地址的更多详细信息，请参阅。或者，为命令指定<code>--net=host</code>标志以<code>docker run</code>跳过将容器放置在单独的网络堆栈中。</p>
<h4 id="21-运行单节点-etcd" class="headerLink">
    <a href="#21-%e8%bf%90%e8%a1%8c%e5%8d%95%e8%8a%82%e7%82%b9-etcd" class="header-mark"></a>2.1 运行单节点 etcd</h4><p>配置 etcd 时使用主机 IP 地址：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NODE1</span><span class="o">=</span>192.168.1.21
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置一个 Docker 卷来存储 etcd 数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker volume create --name etcd-data
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DATA_DIR</span><span class="o">=</span><span class="s2">&#34;etcd-data&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行最新版本的 etcd：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">REGISTRY</span><span class="o">=</span>quay.io/coreos/etcd
</span></span><span class="line"><span class="cl"><span class="c1"># available from v3.2.5</span>
</span></span><span class="line"><span class="cl"><span class="nv">REGISTRY</span><span class="o">=</span>gcr.io/etcd-development/etcd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">docker run <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 2379:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 2380:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --volume<span class="o">=</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span>:/etcd-data <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name etcd <span class="si">${</span><span class="nv">REGISTRY</span><span class="si">}</span>:latest <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  /usr/local/bin/etcd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data-dir<span class="o">=</span>/etcd-data --name node1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">NODE1</span><span class="si">}</span>:2380 --listen-peer-urls http://0.0.0.0:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://<span class="si">${</span><span class="nv">NODE1</span><span class="si">}</span>:2379 --listen-client-urls http://0.0.0.0:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">node1</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">NODE1</span><span class="si">}</span>:2380
</span></span></code></pre></td></tr></table>
</div>
</div><p>列出集群成员：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl --endpoints<span class="o">=</span>http://<span class="si">${</span><span class="nv">NODE1</span><span class="si">}</span>:2379 member list
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="22-运行-3-节点-etcd-集群" class="headerLink">
    <a href="#22-%e8%bf%90%e8%a1%8c-3-%e8%8a%82%e7%82%b9-etcd-%e9%9b%86%e7%be%a4" class="header-mark"></a>2.2 运行 3 节点 etcd 集群</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">REGISTRY</span><span class="o">=</span>quay.io/coreos/etcd
</span></span><span class="line"><span class="cl"><span class="c1"># available from v3.2.5</span>
</span></span><span class="line"><span class="cl"><span class="nv">REGISTRY</span><span class="o">=</span>gcr.io/etcd-development/etcd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For each machine</span>
</span></span><span class="line"><span class="cl"><span class="nv">ETCD_VERSION</span><span class="o">=</span>latest
</span></span><span class="line"><span class="cl"><span class="nv">TOKEN</span><span class="o">=</span>my-etcd-token
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
</span></span><span class="line"><span class="cl"><span class="nv">NAME_1</span><span class="o">=</span>etcd-node-0
</span></span><span class="line"><span class="cl"><span class="nv">NAME_2</span><span class="o">=</span>etcd-node-1
</span></span><span class="line"><span class="cl"><span class="nv">NAME_3</span><span class="o">=</span>etcd-node-2
</span></span><span class="line"><span class="cl"><span class="nv">HOST_1</span><span class="o">=</span>10.20.30.1
</span></span><span class="line"><span class="cl"><span class="nv">HOST_2</span><span class="o">=</span>10.20.30.2
</span></span><span class="line"><span class="cl"><span class="nv">HOST_3</span><span class="o">=</span>10.20.30.3
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_1</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>:2380,<span class="si">${</span><span class="nv">NAME_2</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>:2380,<span class="si">${</span><span class="nv">NAME_3</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">HOST_3</span><span class="si">}</span>:2380
</span></span><span class="line"><span class="cl"><span class="nv">DATA_DIR</span><span class="o">=</span>/var/lib/etcd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For node 1</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_1</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_IP</span><span class="o">=</span><span class="si">${</span><span class="nv">HOST_1</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">docker run <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 2379:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 2380:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --volume<span class="o">=</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span>:/etcd-data <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name etcd <span class="si">${</span><span class="nv">REGISTRY</span><span class="si">}</span>:<span class="si">${</span><span class="nv">ETCD_VERSION</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  /usr/local/bin/etcd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data-dir<span class="o">=</span>/etcd-data --name <span class="si">${</span><span class="nv">THIS_NAME</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 --listen-peer-urls http://0.0.0.0:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 --listen-client-urls http://0.0.0.0:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state <span class="si">${</span><span class="nv">CLUSTER_STATE</span><span class="si">}</span> --initial-cluster-token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For node 2</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_2</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_IP</span><span class="o">=</span><span class="si">${</span><span class="nv">HOST_2</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">docker run <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 2379:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 2380:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --volume<span class="o">=</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span>:/etcd-data <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name etcd <span class="si">${</span><span class="nv">REGISTRY</span><span class="si">}</span>:<span class="si">${</span><span class="nv">ETCD_VERSION</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  /usr/local/bin/etcd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data-dir<span class="o">=</span>/etcd-data --name <span class="si">${</span><span class="nv">THIS_NAME</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 --listen-peer-urls http://0.0.0.0:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 --listen-client-urls http://0.0.0.0:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state <span class="si">${</span><span class="nv">CLUSTER_STATE</span><span class="si">}</span> --initial-cluster-token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For node 3</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAME_3</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">THIS_IP</span><span class="o">=</span><span class="si">${</span><span class="nv">HOST_3</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">docker run <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 2379:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 2380:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --volume<span class="o">=</span><span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span>:/etcd-data <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name etcd <span class="si">${</span><span class="nv">REGISTRY</span><span class="si">}</span>:<span class="si">${</span><span class="nv">ETCD_VERSION</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  /usr/local/bin/etcd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --data-dir<span class="o">=</span>/etcd-data --name <span class="si">${</span><span class="nv">THIS_NAME</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-advertise-peer-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2380 --listen-peer-urls http://0.0.0.0:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://<span class="si">${</span><span class="nv">THIS_IP</span><span class="si">}</span>:2379 --listen-client-urls http://0.0.0.0:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-state <span class="si">${</span><span class="nv">CLUSTER_STATE</span><span class="si">}</span> --initial-cluster-token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>要<code>etcdctl</code>使用 API 版本 3 运行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker <span class="nb">exec</span> etcd /bin/sh -c <span class="s2">&#34;export ETCDCTL_API=3 &amp;&amp; /usr/local/bin/etcdctl put foo bar&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="三故障模式" class="headerLink">
    <a href="#%e4%b8%89%e6%95%85%e9%9a%9c%e6%a8%a1%e5%bc%8f" class="header-mark"></a>三、故障模式</h3><p>失败的种类和 ectd 对它们的容忍度</p>
<p>在大型机器部署中，故障很常见。当机器的硬件或软件出现故障时，机器就会出现故障。当出现电源故障或网络问题时，多台机器会同时出现故障。多种故障也可能同时发生；列举所有可能的失败案例几乎是不可能的。</p>
<p>在本节中，我们对故障类型进行分类并讨论 etcd 是如何设计来容忍这些故障的。大多数用户（如果不是全部）都可以将特定故障映射为一种故障。要为罕见或<a href="https://etcd.io/docs/v3.5/op-guide/recovery/" target="_blank" rel="noopener noreferrer">不可恢复的故障</a>做准备，请始终<a href="https://etcd.io/docs/v3.5/op-guide/maintenance/#snapshot-backup" target="_blank" rel="noopener noreferrer">备份</a>etcd 集群。</p>
<h4 id="31-minor-followers-failure" class="headerLink">
    <a href="#31-minor-followers-failure" class="header-mark"></a>3.1 Minor followers failure</h4><p>当不到一半的追随者失败时，etcd集群仍然可以接受请求并在没有任何重大中断的情况下取得进展。例如，两个跟随器故障不会影响五成员etcd集群的运行。但是，客户端将失去与故障成员的连接。客户端库应该通过自动重新连接到其他成员来对用户的读取请求隐藏这些中断。操作员应预计由于重新连接，其他构件上的系统负载会增加。</p>
<h4 id="32-leader-failure" class="headerLink">
    <a href="#32-leader-failure" class="header-mark"></a>3.2 Leader failure</h4><p>当一个leader失败时，etcd集群会自动选举一个新的leader。一旦领导者失败，选举不会立即发生。因为故障检测模型是基于超时的，所以选举一个新的领导者需要一个选举超时。</p>
<p>在领导者选举期间，集群无法处理任何写入。在选举期间发送的写入请求将排队等待处理，直到选出新的领导者。</p>
<p>已经发送给旧领导但尚未提交的写入可能会丢失。新领导者有权重写前领导者的任何未提交条目。从用户的角度来看，一些写请求可能会在新的领导者选举后超时。但是，不会丢失任何已提交的写入。</p>
<p>新领导者自动延长所有租约的超时时间。这种机制确保租约不会在授予的 TTL 之前到期，即使它是由旧领导者授予的。</p>
<h4 id="33-majority-failure" class="headerLink">
    <a href="#33-majority-failure" class="header-mark"></a>3.3 Majority failure</h4><p>当集群的大多数成员发生故障时，etcd 集群会发生故障并且无法接受更多的写入。</p>
<p>一旦大多数成员可用，etcd 集群只能从多数失败中恢复。如果大多数成员无法重新上线，则操作员必须启动<a href="https://etcd.io/docs/v3.5/op-guide/recovery/" target="_blank" rel="noopener noreferrer">灾难恢复</a>来恢复集群。</p>
<p>一旦大多数成员工作，etcd 集群会自动选举一个新的领导者并恢复到健康状态。新领导者自动延长所有租约的超时时间。此机制确保不会由于服务器端不可用而导致租约到期。</p>
<h4 id="34-网络分区" class="headerLink">
    <a href="#34-%e7%bd%91%e7%bb%9c%e5%88%86%e5%8c%ba" class="header-mark"></a>3.4 网络分区</h4><p>网络分区类似于次要跟随者故障或领导者故障。网络分区将 etcd 集群分为两部分；一个成员占多数，另一个成员占少数。多数方成为可用集群，少数方不可用。etcd 中没有“裂脑”，因为集群成员是显式添加/删除的，每次此类更改都得到当前大多数成员的批准。</p>
<p>如果领导者站在多数人一边，那么从多数人的角度来看，失败是少数跟随者失败。如果领导者在少数方面，那么它就是领导者失败。少数党领袖下台，多数党选举新领袖。</p>
<p>一旦网络分区清除，少数方会自动识别多数方的领导者并恢复其状态。</p>
<h4 id="35-引导期间失败" class="headerLink">
    <a href="#35-%e5%bc%95%e5%af%bc%e6%9c%9f%e9%97%b4%e5%a4%b1%e8%b4%a5" class="header-mark"></a>3.5 引导期间失败</h4><p>只有当所有必需的成员都成功启动时，集群引导才会成功。如果在引导期间发生任何故障，请删除所有成员上的数据目录并使用新的集群令牌或新的发现令牌重新引导集群。</p>
<p>当然，可以像恢复正在运行的集群一样恢复失败的引导集群。但是，恢复该集群几乎总是比引导一个新集群花费更多的时间和资源，因为没有要恢复的数据。</p>
<h3 id="四灾难恢复" class="headerLink">
    <a href="#%e5%9b%9b%e7%81%be%e9%9a%be%e6%81%a2%e5%a4%8d" class="header-mark"></a>四、灾难恢复</h3><p>etcd v3 快照和恢复工具</p>
<p>etcd 旨在承受机器故障。一个 etcd 集群会自动从临时故障（例如，机器重启）中恢复，并且对于 N 个成员的集群最多可以容忍*(N-1)/2 个<em>永久故障。当成员永久失败时，无论是由于硬件故障还是磁盘损坏，它都会失去对集群的访问权限。如果集群永久失去超过</em>(N-1)/2 个*成员，那么它会灾难性地失败，不可挽回地失去法定人数。一旦失去仲裁，集群就无法达成共识，因此无法继续接受更新。</p>
<p>为了从灾难性故障中恢复，etcd v3 提供了快照和恢复工具来重新创建集群，而不会丢失 v3 关键数据。要恢复 v2 密钥，请参阅<a href="https://etcd.io/docs/v2.3/admin_guide#disaster-recovery" target="_blank" rel="noopener noreferrer">v2 管理员指南</a>。</p>
<h4 id="41-对键空间进行快照" class="headerLink">
    <a href="#41-%e5%af%b9%e9%94%ae%e7%a9%ba%e9%97%b4%e8%bf%9b%e8%a1%8c%e5%bf%ab%e7%85%a7" class="header-mark"></a>4.1 对键空间进行快照</h4><p>恢复集群首先需要来自 etcd 成员的密钥空间快照。可以使用命令从活动成员获取快照，也可以通过从 etcd 数据目录<code>etcdctl snapshot save</code>复制文件来获取快照。<code>member/snap/db</code>例如，以下命令将提供的密钥空间快照<code>$ENDPOINT</code>到文件<code>snapshot.db</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints <span class="nv">$ENDPOINT</span> snapshot save snapshot.db
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="42-恢复集群" class="headerLink">
    <a href="#42-%e6%81%a2%e5%a4%8d%e9%9b%86%e7%be%a4" class="header-mark"></a>4.2 恢复集群</h4><p>要恢复集群，只需要一个快照“db”文件。集群恢复<code>etcdutl snapshot restore</code>创建新的 etcd 数据目录；所有成员都应使用相同的快照进行还原。恢复会覆盖一些快照元数据（特别是成员 ID 和集群 ID）；该成员失去了以前的身份。此元数据覆盖可防止新成员无意中加入现有集群。因此，为了从快照启动集群，恢复必须启动一个新的逻辑集群。</p>
<p>可以选择在还原时验证快照完整性。如果快照是用 拍摄的<code>etcdctl snapshot save</code>，它将有一个由 . 检查的完整性哈希<code>etcdutl snapshot restore</code>。如果快照是从数据目录复制的，则没有完整性哈希，只能使用<code>--skip-hash-check</code>.</p>
<p>恢复初始化新集群的新成员，使用新的集群配置使用<code>etcd</code>集群配置标志，但保留 etcd 键空间的内容。继续上一个示例，以下为三成员集群创建新的 etcd 数据目录 ( <code>m1.etcd</code>, <code>m2.etcd</code>, )：<code>m3.etcd</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ etcdutl snapshot restore snapshot.db <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name m1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">m1</span><span class="o">=</span>http://host1:2380,m2<span class="o">=</span>http://host2:2380,m3<span class="o">=</span>http://host3:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-advertise-peer-urls http://host1:2380
</span></span><span class="line"><span class="cl">$ etcdutl snapshot restore snapshot.db <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name m2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">m1</span><span class="o">=</span>http://host1:2380,m2<span class="o">=</span>http://host2:2380,m3<span class="o">=</span>http://host3:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-advertise-peer-urls http://host2:2380
</span></span><span class="line"><span class="cl">$ etcdutl snapshot restore snapshot.db <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name m3 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster <span class="nv">m1</span><span class="o">=</span>http://host1:2380,m2<span class="o">=</span>http://host2:2380,m3<span class="o">=</span>http://host3:2380 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-cluster-token etcd-cluster-1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --initial-advertise-peer-urls http://host3:2380
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，<code>etcd</code>从新的数据目录开始：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ etcd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name m1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://host1:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://host1:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://host1:2380 <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">$ etcd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name m2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://host2:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://host2:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://host2:2380 <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">$ etcd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name m3 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-client-urls http://host3:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-urls http://host3:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-peer-urls http://host3:2380 <span class="p">&amp;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在恢复的 etcd 集群应该可用并为快照提供的键空间提供服务。</p>
<h4 id="43-使用错误的-url-从成员错误重新配置中恢复集群" class="headerLink">
    <a href="#43-%e4%bd%bf%e7%94%a8%e9%94%99%e8%af%af%e7%9a%84-url-%e4%bb%8e%e6%88%90%e5%91%98%e9%94%99%e8%af%af%e9%87%8d%e6%96%b0%e9%85%8d%e7%bd%ae%e4%b8%ad%e6%81%a2%e5%a4%8d%e9%9b%86%e7%be%a4" class="header-mark"></a>4.3 使用错误的 URL 从成员错误重新配置中恢复集群</h4><p>以前，etcd<a href="https://github.com/etcd-io/etcd/issues/9173" target="_blank" rel="noopener noreferrer">会因错误的 URL 的成员错误重新配置而</a>恐慌（v3.2.15 或更高版本在 etcd 服务器恐慌之前<a href="https://github.com/etcd-io/etcd/pull/9174" target="_blank" rel="noopener noreferrer">的客户端早期返回错误）。</a></p>
<p><a href="https://etcd.io/docs/v3.5/op-guide/recovery/#snapshotting-the-keyspace" target="_blank" rel="noopener noreferrer">推荐的方法是从快照</a>恢复。<code>--force-new-cluster</code>可用于在保留现有应用程序数据的同时覆盖集群成员资格，但强烈建议不要这样做，因为如果前一个集群中的其他成员还活着，它会恐慌。确保定期保存快照。</p>
<h3 id="五etcd-网关" class="headerLink">
    <a href="#%e4%ba%94etcd-%e7%bd%91%e5%85%b3" class="header-mark"></a>五、etcd 网关</h3><p>etcd 网关，何时使用，以及如何设置</p>
<h4 id="51-什么是etcd网关" class="headerLink">
    <a href="#51-%e4%bb%80%e4%b9%88%e6%98%afetcd%e7%bd%91%e5%85%b3" class="header-mark"></a>5.1 什么是etcd网关</h4><p>etcd 网关是一个简单的 TCP 代理，将网络数据转发到 etcd 集群。网关无状态透明；它既不检查客户端请求也不干扰集群响应。它不会终止 TLS 连接，不会代表其客户端进行 TLS 握手，也不会验证连接是否安全。</p>
<p>网关支持多个 etcd 服务器端点，并采用简单的循环策略。它只路由到可用的端点并对其客户端隐藏故障。未来可能会支持其他重试策略，例如加权循环。</p>
<h4 id="52-何时使用-etcd-网关" class="headerLink">
    <a href="#52-%e4%bd%95%e6%97%b6%e4%bd%bf%e7%94%a8-etcd-%e7%bd%91%e5%85%b3" class="header-mark"></a>5.2 何时使用 etcd 网关</h4><p>每个访问 etcd 的应用程序必须首先具有 etcd 集群客户端端点的地址。如果同一台服务器上的多个应用程序访问同一个 etcd 集群，每个应用程序仍然需要知道 etcd 集群的通告客户端端点。如果 etcd 集群被重新配置为具有不同的端点，每个应用程序可能还需要更新其端点列表。这种大规模的重新配置既乏味又容易出错。</p>
<p>etcd 网关通过充当稳定的本地端点解决了这个问题。典型的 etcd 网关配置让每台机器运行一个网关，监听本地地址，并且每个 etcd 应用程序都连接到其本地网关。结果只是网关需要更新其端点，而不是更新每个应用程序。</p>
<p>总之，为了自动传播集群端点更改，etcd 网关运行在每台机器上，为访问同一个 etcd 集群的多个应用程序提供服务。</p>
<h4 id="53-何时不使用-etcd-网关" class="headerLink">
    <a href="#53-%e4%bd%95%e6%97%b6%e4%b8%8d%e4%bd%bf%e7%94%a8-etcd-%e7%bd%91%e5%85%b3" class="header-mark"></a>5.3 何时不使用 etcd 网关</h4><ul>
<li>提高性能</li>
</ul>
<p>网关不是为提高 etcd 集群性能而设计的。它不提供缓存、监视合并或批处理。etcd 团队正在开发一种缓存代理，旨在提高集群的可扩展性。</p>
<ul>
<li>在集群管理系统上运行</li>
</ul>
<p>Kubernetes 等高级集群管理系统原生支持服务发现。应用程序可以通过系统管理的 DNS 名称或虚拟 IP 地址访问 etcd 集群。例如，kube-proxy 相当于 etcd 网关。</p>
<h4 id="54-启动-etcd-网关" class="headerLink">
    <a href="#54-%e5%90%af%e5%8a%a8-etcd-%e7%bd%91%e5%85%b3" class="header-mark"></a>5.4 启动 etcd 网关</h4><p>考虑一个具有以下静态端点的 etcd 集群：</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>地址</th>
<th>主机名</th>
</tr>
</thead>
<tbody>
<tr>
<td>基础设施0</td>
<td>10.0.1.10</td>
<td>infra0.example.com</td>
</tr>
<tr>
<td>基础设施1</td>
<td>10.0.1.11</td>
<td>infra1.example.com</td>
</tr>
<tr>
<td>基础设施2</td>
<td>10.0.1.12</td>
<td>infra2.example.com</td>
</tr>
</tbody>
</table>
<p>使用以下命令启动 etcd 网关以使用这些静态端点：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd gateway start --endpoints<span class="o">=</span>infra0.example.com,infra1.example.com,infra2.example.com
</span></span><span class="line"><span class="cl">2016-08-16 11:21:18.867350 I <span class="p">|</span> tcpproxy: ready to proxy client requests to <span class="o">[</span>...<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>或者，如果使用 DNS 进行服务发现，请考虑 DNS SRV 条目：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ dig +noall +answer SRV _etcd-client._tcp.example.com
</span></span><span class="line"><span class="cl">_etcd-client._tcp.example.com. <span class="m">300</span> IN SRV <span class="m">0</span> <span class="m">0</span> <span class="m">2379</span> infra0.example.com.
</span></span><span class="line"><span class="cl">_etcd-client._tcp.example.com. <span class="m">300</span> IN SRV <span class="m">0</span> <span class="m">0</span> <span class="m">2379</span> infra1.example.com.
</span></span><span class="line"><span class="cl">_etcd-client._tcp.example.com. <span class="m">300</span> IN SRV <span class="m">0</span> <span class="m">0</span> <span class="m">2379</span> infra2.example.com.
</span></span><span class="line"><span class="cl">$ dig +noall +answer infra0.example.com infra1.example.com infra2.example.com
</span></span><span class="line"><span class="cl">infra0.example.com.  <span class="m">300</span>  IN  A  10.0.1.10
</span></span><span class="line"><span class="cl">infra1.example.com.  <span class="m">300</span>  IN  A  10.0.1.11
</span></span><span class="line"><span class="cl">infra2.example.com.  <span class="m">300</span>  IN  A  10.0.1.12
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用以下命令启动 etcd 网关以从 DNS SRV 条目中获取端点：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd gateway start --discovery-srv<span class="o">=</span>example.com
</span></span><span class="line"><span class="cl">2016-08-16 11:21:18.867350 I <span class="p">|</span> tcpproxy: ready to proxy client requests to <span class="o">[</span>...<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="55-配置标志" class="headerLink">
    <a href="#55-%e9%85%8d%e7%bd%ae%e6%a0%87%e5%bf%97" class="header-mark"></a>5.5 配置标志</h4><h5 id="551-etcd-集群" class="headerLink">
    <a href="#551-etcd-%e9%9b%86%e7%be%a4" class="header-mark"></a>5.5.1 etcd 集群</h5><h5 id="端点" class="headerLink">
    <a href="#%e7%ab%af%e7%82%b9" class="header-mark"></a>–端点</h5><ul>
<li>用于转发客户端连接的 etcd 服务器目标的逗号分隔列表。</li>
<li>默认：<code>127.0.0.1:2379</code></li>
<li>无效示例：（<code>https://127.0.0.1:2379</code>网关不终止 TLS）。请注意，网关不会验证 HTTP 模式或检查请求，它只会将请求转发到给定的端点。</li>
</ul>
<h5 id="--发现-srv" class="headerLink">
    <a href="#--%e5%8f%91%e7%8e%b0-srv" class="header-mark"></a>&ndash;发现-srv</h5><ul>
<li>用于通过 SRV 记录引导集群端点的 DNS 域。</li>
<li>默认值：（未设置）</li>
</ul>
<h5 id="网络" class="headerLink">
    <a href="#%e7%bd%91%e7%bb%9c" class="header-mark"></a>网络</h5><h5 id="--listen-addr" class="headerLink">
    <a href="#--listen-addr" class="header-mark"></a>&ndash;listen-addr</h5><ul>
<li>为接受客户端请求而绑定的接口和端口。</li>
<li>默认：<code>127.0.0.1:23790</code></li>
</ul>
<h5 id="--重试延迟" class="headerLink">
    <a href="#--%e9%87%8d%e8%af%95%e5%bb%b6%e8%bf%9f" class="header-mark"></a>&ndash;重试延迟</h5><ul>
<li>重试连接失败端点之前的延迟时间。</li>
<li>默认值：1m0s</li>
<li>无效示例：“123”（期望格式中的时间单位）</li>
</ul>
<h5 id="安全" class="headerLink">
    <a href="#%e5%ae%89%e5%85%a8" class="header-mark"></a>安全</h5><h5 id="不安全的发现" class="headerLink">
    <a href="#%e4%b8%8d%e5%ae%89%e5%85%a8%e7%9a%84%e5%8f%91%e7%8e%b0" class="header-mark"></a>–不安全的发现</h5><ul>
<li>接受不安全或容易受到中间人攻击的 SRV 记录。</li>
<li>默认：<code>false</code></li>
</ul>
<h5 id="--trusted-ca-文件" class="headerLink">
    <a href="#--trusted-ca-%e6%96%87%e4%bb%b6" class="header-mark"></a>&ndash;trusted-ca 文件</h5><ul>
<li>etcd 集群的客户端 TLS CA 文件的路径，用于验证从 SRV 发现返回的端点。请注意，它仅用于验证发现的端点，而不是为数据传输创建连接。网关永远不会终止 TLS 连接或代表其客户端创建 TLS 连接。</li>
<li>默认值：（未设置）</li>
</ul>
<h3 id="六grpc-代理" class="headerLink">
    <a href="#%e5%85%adgrpc-%e4%bb%a3%e7%90%86" class="header-mark"></a>六、gRPC 代理</h3><p>在 gRPC 层运行的无状态 etcd 反向代理</p>
<p>gRPC 代理是在 gRPC 层（L7）运行的无状态 etcd 反向代理。该代理旨在减少核心 etcd 集群上的总处理负载。对于水平可扩展性，它合并了监视和租用 API 请求。为了保护集群免受滥用客户端的影响，它缓存了键范围请求。</p>
<p>gRPC 代理支持多个 etcd 服务器端点。当代理启动时，它会随机选择一个 etcd 服务器端点来使用。此端点为所有请求提供服务，直到代理检测到端点故障。如果 gRPC 代理检测到端点故障，它会切换到另一个端点（如果可用）以隐藏其客户端的故障。未来可能会支持其他重试策略，例如加权循环。</p>
<h4 id="61-可扩展的手表-api" class="headerLink">
    <a href="#61-%e5%8f%af%e6%89%a9%e5%b1%95%e7%9a%84%e6%89%8b%e8%a1%a8-api" class="header-mark"></a>6.1 可扩展的手表 API</h4><p>gRPC 代理将同一键或范围上的多个客户端观察者 ( ) 合并为连接到 etcd 服务器<code>c-watchers</code>的单个观察者 ( )。<code>s-watcher</code>代理将所有事件从 广播<code>s-watcher</code>到其<code>c-watchers</code>.</p>
<p>假设有 N 个客户端监视同一个 key，一个 gRPC 代理可以将 etcd 服务器上的监视负载从 N 减少到 1 个。用户可以部署多个 gRPC 代理以进一步分散服务器负载。</p>
<p>在以下示例中，三个客户端在密钥 A 上进行监视。gRPC 代理合并三个观察者，创建一个连接到 etcd 服务器的单个观察者。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">            +-------------+
</span></span><span class="line"><span class="cl">            | etcd server |
</span></span><span class="line"><span class="cl">            +------+------+
</span></span><span class="line"><span class="cl">                   ^ watch key A (s-watcher)
</span></span><span class="line"><span class="cl">                   |
</span></span><span class="line"><span class="cl">           +-------+-----+
</span></span><span class="line"><span class="cl">           | gRPC proxy  | &lt;-------+
</span></span><span class="line"><span class="cl">           |             |         |
</span></span><span class="line"><span class="cl">           ++-----+------+         |watch key A (c-watcher)
</span></span><span class="line"><span class="cl">watch key A ^     ^ watch key A    |
</span></span><span class="line"><span class="cl">(c-watcher) |     | (c-watcher)    |
</span></span><span class="line"><span class="cl">    +-------+-+  ++--------+  +----+----+
</span></span><span class="line"><span class="cl">    |  client |  |  client |  |  client |
</span></span><span class="line"><span class="cl">    |         |  |         |  |         |
</span></span><span class="line"><span class="cl">    +---------+  +---------+  +---------+
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="62-限制" class="headerLink">
    <a href="#62-%e9%99%90%e5%88%b6" class="header-mark"></a>6.2 限制</h4><p>为了有效地将多个客户端观察者合并为一个观察者，gRPC 代理会在可能的情况下将新的观察者合并<code>c-watchers</code>为现有<code>s-watcher</code>的。由于网络延迟或缓冲的未交付事件，此合并<code>s-watcher</code>可能与 etcd 服务器不同步。当未指定监视修订时，gRPC 代理将不保证<code>c-watcher</code>将从最近的存储修订开始监视。例如，如果客户端从修订版 1000 的 etcd 服务器进行监视，则该观察者将从修订版 1000 开始。如果客户端从 gRPC 代理进行监视，则可能从修订版 990 开始监视。</p>
<p>类似的限制适用于取消。当 watcher 被取消时，etcd 服务器的版本可能会大于取消响应的版本。</p>
<p>这两个限制不应该对大多数用例造成问题。将来，可能会有其他选项强制观察者绕过 gRPC 代理以获得更准确的修订响应。</p>
<h4 id="63-可扩展的租赁-api" class="headerLink">
    <a href="#63-%e5%8f%af%e6%89%a9%e5%b1%95%e7%9a%84%e7%a7%9f%e8%b5%81-api" class="header-mark"></a>6.3 可扩展的租赁 API</h4><p>为了保持其租约有效，客户端必须建立至少一个 gRPC 流到 etcd 服务器以发送周期性心跳。如果 etcd 工作负载涉及分布在许多客户端上的大量租用活动，则这些流可能会导致 CPU 利用率过高。为了减少核心集群上的流总数，代理支持租用流合并。</p>
<p>假设 N 个客户端正在更新租约，单个 gRPC 代理将 etcd 服务器上的流负载从 N 减少到 1。部署可能具有额外的 gRPC 代理，以进一步跨多个代理分发流。</p>
<p>在以下示例中，三个客户端更新三个独立的租约（<code>L1</code>、<code>L2</code>和<code>L3</code>）。gRPC 代理将三个客户端租用流 ( ) 合并为一个附加到 etcd 服务器<code>c-streams</code>的租用保持活动流 ( )。<code>s-stream</code>代理将客户端租赁心跳从 c-stream 转发到 s-stream，然后将响应返回到相应的 c-stream。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">          +-------------+
</span></span><span class="line"><span class="cl">          | etcd server |
</span></span><span class="line"><span class="cl">          +------+------+
</span></span><span class="line"><span class="cl">                 ^
</span></span><span class="line"><span class="cl">                 | heartbeat L1, L2, L3
</span></span><span class="line"><span class="cl">                 | (s-stream)
</span></span><span class="line"><span class="cl">                 v
</span></span><span class="line"><span class="cl">         +-------+-----+
</span></span><span class="line"><span class="cl">         | gRPC proxy  +&lt;-----------+
</span></span><span class="line"><span class="cl">         +---+------+--+            | heartbeat L3
</span></span><span class="line"><span class="cl">             ^      ^               | (c-stream)
</span></span><span class="line"><span class="cl">heartbeat L1 |      | heartbeat L2  |
</span></span><span class="line"><span class="cl">(c-stream)   v      v (c-stream)    v
</span></span><span class="line"><span class="cl">      +------+-+  +-+------+  +-----+--+
</span></span><span class="line"><span class="cl">      | client |  | client |  | client |
</span></span><span class="line"><span class="cl">      +--------+  +--------+  +--------+
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="64-滥用客户保护" class="headerLink">
    <a href="#64-%e6%bb%a5%e7%94%a8%e5%ae%a2%e6%88%b7%e4%bf%9d%e6%8a%a4" class="header-mark"></a>6.4 滥用客户保护</h4><p>gRPC 代理在不破坏一致性要求时缓存请求的响应。这可以保护 etcd 服务器免受紧密 for 循环中的滥用客户端的影响。</p>
<h4 id="65-启动-etcd-grpc-代理" class="headerLink">
    <a href="#65-%e5%90%af%e5%8a%a8-etcd-grpc-%e4%bb%a3%e7%90%86" class="header-mark"></a>6.5 启动 etcd gRPC 代理</h4><p>考虑一个具有以下静态端点的 etcd 集群：</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>地址</th>
<th>主机名</th>
</tr>
</thead>
<tbody>
<tr>
<td>基础设施0</td>
<td>10.0.1.10</td>
<td>infra0.example.com</td>
</tr>
<tr>
<td>基础设施1</td>
<td>10.0.1.11</td>
<td>infra1.example.com</td>
</tr>
<tr>
<td>基础设施2</td>
<td>10.0.1.12</td>
<td>infra2.example.com</td>
</tr>
</tbody>
</table>
<p>使用以下命令启动 etcd gRPC 代理以使用这些静态端点：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd grpc-proxy start --endpoints<span class="o">=</span>infra0.example.com,infra1.example.com,infra2.example.com --listen-addr<span class="o">=</span>127.0.0.1:2379
</span></span></code></pre></td></tr></table>
</div>
</div><p>etcd gRPC 代理启动并侦听端口 2379。它将客户端请求转发到上面提供的三个端点之一。</p>
<p>通过代理发送请求：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints<span class="o">=</span>127.0.0.1:2379 put foo bar
</span></span><span class="line"><span class="cl">OK
</span></span><span class="line"><span class="cl">$ <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints<span class="o">=</span>127.0.0.1:2379 get foo
</span></span><span class="line"><span class="cl">foo
</span></span><span class="line"><span class="cl">bar
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="66-客户端端点同步和名称解析" class="headerLink">
    <a href="#66-%e5%ae%a2%e6%88%b7%e7%ab%af%e7%ab%af%e7%82%b9%e5%90%8c%e6%ad%a5%e5%92%8c%e5%90%8d%e7%a7%b0%e8%a7%a3%e6%9e%90" class="header-mark"></a>6.6 客户端端点同步和名称解析</h4><p>代理支持通过写入用户定义的端点来注册其端点以进行发现。这有两个目的。首先，它允许客户端将其端点与一组代理端点同步以实现高可用性。其次，它是 etcd <a href="https://etcd.io/docs/v3.5/dev-guide/grpc_naming/" target="_blank" rel="noopener noreferrer">gRPC 命名</a>的端点提供者。</p>
<p>通过提供用户定义的前缀来注册代理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd grpc-proxy start --endpoints<span class="o">=</span>localhost:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-addr<span class="o">=</span>127.0.0.1:23790 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-url<span class="o">=</span>127.0.0.1:23790 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --resolver-prefix<span class="o">=</span><span class="s2">&#34;___grpc_proxy_endpoint&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --resolver-ttl<span class="o">=</span><span class="m">60</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ etcd grpc-proxy start --endpoints<span class="o">=</span>localhost:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-addr<span class="o">=</span>127.0.0.1:23791 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-url<span class="o">=</span>127.0.0.1:23791 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --resolver-prefix<span class="o">=</span><span class="s2">&#34;___grpc_proxy_endpoint&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --resolver-ttl<span class="o">=</span><span class="m">60</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>代理将列出其所有成员的成员列表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints<span class="o">=</span>http://localhost:23790 member list --write-out table
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">+----+---------+--------------------------------+------------+-----------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> ID <span class="p">|</span> STATUS  <span class="p">|</span>              NAME              <span class="p">|</span> PEER ADDRS <span class="p">|</span>  CLIENT ADDRS   <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----+---------+--------------------------------+------------+-----------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">0</span> <span class="p">|</span> started <span class="p">|</span> Gyu-Hos-MBP.sfo.coreos.systems <span class="p">|</span>            <span class="p">|</span> 127.0.0.1:23791 <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">0</span> <span class="p">|</span> started <span class="p">|</span> Gyu-Hos-MBP.sfo.coreos.systems <span class="p">|</span>            <span class="p">|</span> 127.0.0.1:23790 <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----+---------+--------------------------------+------------+-----------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>这让客户端可以通过 Sync 自动发现代理端点：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">cli</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Endpoints</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;http://localhost:23790&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">defer</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// fetch registered grpc-proxy endpoints
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Sync</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>请注意，如果代理配置没有解析器前缀，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd grpc-proxy start --endpoints<span class="o">=</span>localhost:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-addr<span class="o">=</span>127.0.0.1:23792 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --advertise-client-url<span class="o">=</span>127.0.0.1:23792
</span></span></code></pre></td></tr></table>
</div>
</div><p>grpc-proxy 的成员列表 API 返回它自己的<code>advertise-client-url</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints<span class="o">=</span>http://localhost:23792 member list --write-out table
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">+----+---------+--------------------------------+------------+-----------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> ID <span class="p">|</span> STATUS  <span class="p">|</span>              NAME              <span class="p">|</span> PEER ADDRS <span class="p">|</span>  CLIENT ADDRS   <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----+---------+--------------------------------+------------+-----------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">0</span> <span class="p">|</span> started <span class="p">|</span> Gyu-Hos-MBP.sfo.coreos.systems <span class="p">|</span>            <span class="p">|</span> 127.0.0.1:23792 <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----+---------+--------------------------------+------------+-----------------+
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="67-命名空间" class="headerLink">
    <a href="#67-%e5%91%bd%e5%90%8d%e7%a9%ba%e9%97%b4" class="header-mark"></a>6.7 命名空间</h4><p>假设应用程序希望完全控制整个密钥空间，但 etcd 集群与其他应用程序共享。为了让所有应用程序在不相互干扰的情况下运行，代理可以对 etcd 键空间进行分区，以便客户端看起来可以访问完整的键空间。当代理被赋予 flag<code>--namespace</code>时，进入代理的所有客户端请求都被转换为在键上具有用户定义的前缀。对 etcd 集群的访问将在前缀下，来自代理的响应将去除前缀；对客户来说，似乎根本没有前缀。</p>
<p>要命名代理，请使用以下命令开始<code>--namespace</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd grpc-proxy start --endpoints<span class="o">=</span>localhost:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-addr<span class="o">=</span>127.0.0.1:23790 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --namespace<span class="o">=</span>my-prefix/
</span></span></code></pre></td></tr></table>
</div>
</div><p>对代理的访问现在透明地在 etcd 集群上添加前缀：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints<span class="o">=</span>localhost:23790 put my-key abc
</span></span><span class="line"><span class="cl"><span class="c1"># OK</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints<span class="o">=</span>localhost:23790 get my-key
</span></span><span class="line"><span class="cl"><span class="c1"># my-key</span>
</span></span><span class="line"><span class="cl"><span class="c1"># abc</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints<span class="o">=</span>localhost:2379 get my-prefix/my-key
</span></span><span class="line"><span class="cl"><span class="c1"># my-prefix/my-key</span>
</span></span><span class="line"><span class="cl"><span class="c1"># abc</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="68-tls-终止" class="headerLink">
    <a href="#68-tls-%e7%bb%88%e6%ad%a2" class="header-mark"></a>6.8 TLS 终止</h4><p>通过提供未加密的本地端点，使用 gRPC 代理从安全的 etcd 集群中终止 TLS。</p>
<p>要试用它，请使用客户端 https 启动单个成员 etcd 集群：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ etcd --listen-client-urls https://localhost:2379 --advertise-client-urls https://localhost:2379 --cert-file<span class="o">=</span>peer.crt --key-file<span class="o">=</span>peer.key --trusted-ca-file<span class="o">=</span>ca.crt --client-cert-auth
</span></span></code></pre></td></tr></table>
</div>
</div><p>确认客户端端口服务于 https：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># fails</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints<span class="o">=</span>http://localhost:2379 endpoint status
</span></span><span class="line"><span class="cl"><span class="c1"># works</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints<span class="o">=</span>https://localhost:2379 --cert<span class="o">=</span>client.crt --key<span class="o">=</span>client.key --cacert<span class="o">=</span>ca.crt endpoint status
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，通过使用客户端证书<code>localhost:12379</code>连接到 etcd 端点来启动 gRPC 代理：<code>https://localhost:2379</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ etcd grpc-proxy start --endpoints<span class="o">=</span>https://localhost:2379 --listen-addr localhost:12379 --cert client.crt --key client.key --cacert<span class="o">=</span>ca.crt --insecure-skip-tls-verify <span class="p">&amp;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后，通过 http 将密钥放入代理来测试 TLS 终止：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl --endpoints<span class="o">=</span>http://localhost:12379 put abc def
</span></span><span class="line"><span class="cl"><span class="c1"># OK</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="69-指标和健康" class="headerLink">
    <a href="#69-%e6%8c%87%e6%a0%87%e5%92%8c%e5%81%a5%e5%ba%b7" class="header-mark"></a>6.9 指标和健康</h4><p>gRPC代理<code>/health</code>为由. 另一种方法是定义一个附加 URL，该 URL 将使用该标志同时响应 the和端点。<code>/metrics``--endpoints``/metrics``/health``--metrics-addr</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ etcd grpc-proxy start <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --endpoints https://localhost:2379 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --metrics-addr https://0.0.0.0:4443 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen-addr 127.0.0.1:23790 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --key client.key <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --key-file proxy-server.key <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --cert client.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --cert-file proxy-server.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --cacert ca.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --trusted-ca-file proxy-ca.pem
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="610-已知问题" class="headerLink">
    <a href="#610-%e5%b7%b2%e7%9f%a5%e9%97%ae%e9%a2%98" class="header-mark"></a>6.10 已知问题</h4><p>代理的主界面同时服务于 HTTP2 和 HTTP/1.1。如果如上例所示使用 TLS 设置代理，则在针对侦听接口使用诸如 cURL 之类的客户端时，将需要在请求返回时将协议显式设置为 HTTP/1.1<code>/metrics</code>或<code>/health</code>. 通过使用该<code>--metrics-addr</code>标志，辅助接口将没有此要求。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> $ curl --cacert proxy-ca.pem --key proxy-client.key --cert proxy-client.crt https://127.0.0.1:23790/metrics --http1.1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="配置文件和启动参数说明" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e5%92%8c%e5%90%af%e5%8a%a8%e5%8f%82%e6%95%b0%e8%af%b4%e6%98%8e" class="header-mark"></a>。、配置文件和启动参数说明</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 节点名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 指定节点的数据存储目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data-dir</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 监听url，用于与其他节点通讯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">listen-peer-urls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 对外提供服务的地址：比如 http://ip:2379,http://127.0.0.1:2379 ，客户端会连接到这里和 etcd 交互</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">listen-client-urls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 该节点member(同伴)监听地址，这个值会告诉集群其节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">initial-advertise-peer-urls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 集群中所有节点的信息，格式为 node1=http://ip1:2380,node2=http://ip2:2380,… 。注意：这里的 node1 是节点的 --name 指定的名字；后面的 ip1:2380 是 --initial-advertise-peer-urls 指定的值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">initial-cluster-state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 创建集群的 token ，这个值每个集群保持唯一。这样的话，如果你要重新创建集群，即时配置和之前的一样，也会再次生成新的集群和节点 uuid；否则会导致多个集群之间的冲突，造成位置的错误。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">initial-cluster-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 对外公告的该节点客户点监听地址，这个值会告诉集群中其他节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">advertise-client-urls</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>0etcd &ndash;config-file=/Users/yooome/etcd/etcd1.conf.yml &amp;</p>
<p>0etcd - -config-file /etc/etcd/etcd.conf</p>
<p>etcd &ndash;config-file=/Users/yooome/etcd/etcd2.conf.yml &amp;</p>
<p>etcd &ndash;config-file=/Users/yooome/etcd/etcd3.conf.yml</p>
<p>etcdctl &ndash;endpoints http://127.0.0.1:12379,http://127.0.0.1:22379,http://127.0.0.1:32379 member list</p>
<p>etcdctl &ndash;endpoints http://127.0.0.1:12379,http://127.0.0.1:22379,http://127.0.0.1:32379 member list</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#[Member]
</span></span><span class="line"><span class="cl">#1.节点名称，必须唯一
</span></span><span class="line"><span class="cl">ETCD_NAME=&#34;etcd1&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#2.设置数据保存的目录
</span></span><span class="line"><span class="cl">ETCD_DATA_DIR=&#34;/var/lib/etcd&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#3.用于监听其他etcd member的url
</span></span><span class="line"><span class="cl">ETCD_LISTEN_PEER_URLS=&#34;http://127.0.0.1:12380&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#4.该节点对外提供服务的地址
</span></span><span class="line"><span class="cl">ETCD_LISTEN_CLIENT_URLS=&#34;http://127.0.0.1:12379,http://127.0.0.1:12379&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#[Clustering]
</span></span><span class="line"><span class="cl">#5.对外公告的该节点客户端监听地址
</span></span><span class="line"><span class="cl">ETCD_ADVERTISE_CLIENT_URLS=&#34;http://192.168.86.131:12379&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#6.该节点成员对等URL地址，且会通告集群的其余成员节点
</span></span><span class="line"><span class="cl">ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;http://192.168.86.131:12380&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#7.集群中所有节点的信息
</span></span><span class="line"><span class="cl">ETCD_INITIAL_CLUSTER=&#34;etcd01=http://192.168.86.131:2380,（注意这是第一台虚拟机的地址，是不变的）
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">etcd02=http://192.168.86.132:2380&#34;（注意这是第二台虚拟机的地址，是不变的）
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#8.创建集群的token，这个值每个集群保持唯一
</span></span><span class="line"><span class="cl">ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-cluster&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#9.初始集群状态，新建集群的时候，这个值为new；
</span></span><span class="line"><span class="cl">ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#10.flannel操作etcd使用的是v2的API，而kubernetes操作etcd使用的v3的API
</span></span><span class="line"><span class="cl">#   为了兼容flannel，将默认开启v2版本，故配置文件中设置 
</span></span><span class="line"><span class="cl">ETCD_ENABLE_V2=&#34;true&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker run -d -p 2579:2579 -p 2580:2580 --restart=always --net etcdnet --ip 192.167.0.172 --name etcd2 quay.io/coreos/etcd /usr/local/bin/etcd --name autumn-client2 -advertise-client-urls http://192.167.0.172:2579 -listen-client-urls http://0.0.0.0:2579 -initial-advertise-peer-urls http://192.167.0.172:2580 -listen-peer-urls http://0.0.0.0:2580 -initial-cluster-token etcd-cluster -initial-cluster autumn-client0=http://192.167.0.168:2380,autumn-client1=http://192.167.0.170:2480,autumn-client2=http://192.167.0.172:2580 -initial-cluster-state new
</span></span></code></pre></td></tr></table>
</div>
</div><p>etcd &ndash;config-file=/Users/yooome/etcd/etcd1.conf.yml</p>
<p>etcd &ndash;config-file=/Users/yooome/etcd/etcd2.conf.yml</p>
<p>etcd &ndash;config-file=/Users/yooome/etcd/etcd3.conf.yml</p>
</div>

        

<div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 0001-01-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/index.md target="_blank" rel="noopener noreferrer">阅读原始文档</a>
                    </span></div>
            <div class="post-info-share">
                <span><a href="#" title="分享到 Twitter" data-sharer="twitter" data-url="http://yanghx.vip/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" data-title="" data-via="xxxx"><i class="fab fa-twitter fa-fw"></i></a><a href="#" title="分享到 Facebook" data-sharer="facebook" data-url="http://yanghx.vip/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="#" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="http://yanghx.vip/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" data-title="" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="#" title="分享到 Line" data-sharer="line" data-url="http://yanghx.vip/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" data-title=""><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="#" title="分享到 微博" data-sharer="weibo" data-url="http://yanghx.vip/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" data-title=""><i class="fab fa-weibo fa-fw"></i></a><a href="#" title="分享到 Myspace" data-sharer="myspace" data-url="http://yanghx.vip/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" data-title="" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="#" title="分享到 Blogger" data-sharer="blogger" data-url="http://yanghx.vip/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" data-title="" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="#" title="分享到 Evernote" data-sharer="evernote" data-url="http://yanghx.vip/etcd%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" data-title=""><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/grpc/" class="prev" rel="prev" title=""><i class="fas fa-angle-left fa-fw"></i></a>
            <a href="/k8s%E5%85%A5%E9%97%A8/" class="next" rel="next" title=""><i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.111.3">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.3.0"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer">yanghx</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp"><a target="_blank" href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11011502006407">京公安备11011502006407</a>  <a  target="_blank" href="https://beian.miit.gov.cn/">京ICP备2023005717号-1</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div id="cookieconsent-container"></div><div class="assets"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"sharerjs":true,"table":{"sort":true}};</script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script type="text/javascript" src="/js/cookieconsent.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>
</body>

</html>